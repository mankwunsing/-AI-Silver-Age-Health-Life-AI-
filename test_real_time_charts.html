<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¦æ™‚åœ–è¡¨åˆ†ææ¸¬è©¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        .input-field {
            @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent;
        }
        .card {
            @apply bg-white rounded-xl shadow-lg p-6;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">å¯¦æ™‚åœ–è¡¨åˆ†ææ¸¬è©¦</h1>
        
        <!-- åŠŸèƒ½èªªæ˜ -->
        <div class="card mb-6">
            <h2 class="text-xl font-semibold mb-4">æ–°åŠŸèƒ½èªªæ˜</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-green-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-green-800">âœ… çœŸå¯¦æ•¸æ“š</h3>
                    <p class="text-sm text-green-700 mt-2">åœ–è¡¨ç¾åœ¨åŸºæ–¼æ‚¨éŒ„å…¥çš„çœŸå¯¦å¥åº·æ•¸æ“š</p>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-blue-800">â° æ™‚é–“ç¯„åœ</h3>
                    <p class="text-sm text-blue-700 mt-2">å¯é¸æ“‡ä¸€æ—¥ã€ä¸€æ˜ŸæœŸã€ä¸€å€‹æœˆã€ä¸€å¹´</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <h3 class="font-semibold text-purple-800">ğŸ”„ å¯¦æ™‚æ›´æ–°</h3>
                    <p class="text-sm text-purple-700 mt-2">ä¿å­˜æ•¸æ“šå¾Œåœ–è¡¨è‡ªå‹•æ›´æ–°</p>
                </div>
            </div>
        </div>

        <!-- æ•¸æ“šéŒ„å…¥ -->
        <div class="card mb-6">
            <h2 class="text-xl font-semibold mb-4">å¿«é€Ÿæ•¸æ“šéŒ„å…¥</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">æ”¶ç¸®å£“ (mmHg)</label>
                    <input type="number" id="bp-systolic" placeholder="120" class="input-field" min="60" max="250">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">èˆ’å¼µå£“ (mmHg)</label>
                    <input type="number" id="bp-diastolic" placeholder="80" class="input-field" min="40" max="150">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">è„ˆæ (bpm)</label>
                    <input type="number" id="bp-pulse" placeholder="72" class="input-field" min="30" max="200">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">è¡€æ°§é£½å’Œåº¦ (%)</label>
                    <input type="number" id="spo2-percent" placeholder="98" class="input-field" min="70" max="100" step="0.1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">çŒæ³¨æŒ‡æ•¸ (%)</label>
                    <input type="number" id="spo2-pi" placeholder="2.5" class="input-field" min="0.1" max="20" step="0.1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">é«”æº« (Â°C)</label>
                    <input type="number" id="temp-value" placeholder="36.5" class="input-field" min="30" max="45" step="0.1">
                </div>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-base mb-2">æ¸¬é‡æ™‚é–“</label>
                    <input type="datetime-local" id="device-time" class="input-field">
                </div>
                <div>
                    <label class="block text-base mb-2">å‚™è¨»</label>
                    <textarea id="device-notes" placeholder="ä¾‹å¦‚ï¼šé¤å¾Œæ¸¬é‡ã€é‹å‹•å¾Œæ¸¬é‡ç­‰" class="input-field" rows="3"></textarea>
                </div>
                <button onclick="saveAllData()" class="w-full py-4 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl text-lg font-bold hover:from-green-600 hover:to-green-700 transition-all duration-300 shadow-xl border-2 border-green-400 transform hover:scale-105">
                    <i class="fa fa-save mr-2 text-xl"></i> ğŸ’¾ ä¿å­˜æ‰€æœ‰æ•¸æ“šä¸¦æ›´æ–°åœ–è¡¨
                </button>
            </div>
        </div>

        <!-- åœ–è¡¨å€åŸŸ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- è¶¨å‹¢åˆ†æåœ–è¡¨ -->
            <div class="card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">è¡€å£“è¶¨å‹¢åˆ†æ</h3>
                    <div class="flex items-center space-x-2">
                        <select id="trend-time-range" class="text-sm border border-gray-300 rounded px-2 py-1" onchange="updateTrendChart()">
                            <option value="1day">ä¸€æ—¥</option>
                            <option value="1week" selected>ä¸€æ˜ŸæœŸ</option>
                            <option value="1month">ä¸€å€‹æœˆ</option>
                            <option value="1year">ä¸€å¹´</option>
                        </select>
                        <button onclick="updateTrendChart()" class="text-blue-500 text-sm hover:underline">
                            <i class="fa fa-refresh mr-1"></i> æ›´æ–°
                        </button>
                    </div>
                </div>
                <canvas id="trend-chart" height="300"></canvas>
            </div>

            <!-- ç›¸é—œæ€§åˆ†æåœ–è¡¨ -->
            <div class="card">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">å¥åº·æŒ‡æ¨™åˆ†æ</h3>
                    <div class="flex items-center space-x-2">
                        <select id="correlation-time-range" class="text-sm border border-gray-300 rounded px-2 py-1" onchange="updateCorrelationChart()">
                            <option value="1day">ä¸€æ—¥</option>
                            <option value="1week" selected>ä¸€æ˜ŸæœŸ</option>
                            <option value="1month">ä¸€å€‹æœˆ</option>
                            <option value="1year">ä¸€å¹´</option>
                        </select>
                        <button onclick="updateCorrelationChart()" class="text-blue-500 text-sm hover:underline">
                            <i class="fa fa-refresh mr-1"></i> æ›´æ–°
                        </button>
                    </div>
                </div>
                <canvas id="correlation-chart" height="300"></canvas>
            </div>
        </div>

        <!-- å¤šç¶­åº¦åœ–è¡¨ -->
        <div class="card mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">å¤šç¶­åº¦å¥åº·æŒ‡æ¨™å°æ¯”</h3>
                <div class="flex items-center space-x-2">
                    <select id="multi-dimension-time-range" class="text-sm border border-gray-300 rounded px-2 py-1" onchange="updateMultiDimensionChart()">
                        <option value="1day">ä¸€æ—¥</option>
                        <option value="1week" selected>ä¸€æ˜ŸæœŸ</option>
                        <option value="1month">ä¸€å€‹æœˆ</option>
                        <option value="1year">ä¸€å¹´</option>
                    </select>
                    <button onclick="updateMultiDimensionChart()" class="text-blue-500 text-sm hover:underline">
                        <i class="fa fa-refresh mr-1"></i> æ›´æ–°
                    </button>
                </div>
            </div>
            <canvas id="multi-dimension-chart" height="400"></canvas>
        </div>

        <!-- æ¸¬è©¦çµæœ -->
        <div class="card">
            <h2 class="text-xl font-semibold mb-4">æ¸¬è©¦çµæœ</h2>
            <div id="test-results" class="bg-gray-50 p-4 rounded text-sm font-mono">
                <p class="text-gray-500">è«‹éŒ„å…¥æ•¸æ“šä¸¦è§€å¯Ÿåœ–è¡¨çš„å¯¦æ™‚æ›´æ–°...</p>
            </div>
        </div>
    </div>

    <script>
        // åœ–è¡¨å¯¦ä¾‹å­˜å„²
        window.chartInstances = {};

        // ç²å–æŒ‡å®šæ™‚é–“ç¯„åœçš„æ•¸æ“š
        function getDataByTimeRange(timeRange) {
            try {
                const healthRecords = JSON.parse(localStorage.getItem('healthRecords') || '[]');
                const now = new Date();
                let startDate;
                
                switch (timeRange) {
                    case '1day':
                        startDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                        break;
                    case '1week':
                        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case '1month':
                        startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        break;
                    case '1year':
                        startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                        break;
                    default:
                        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                }
                
                return healthRecords.filter(record => {
                    const recordDate = new Date(record.timestamp);
                    return recordDate >= startDate && recordDate <= now;
                });
            } catch (error) {
                console.error('ç²å–æ•¸æ“šå¤±æ•—:', error);
                return [];
            }
        }

        // ç²å–æ™‚é–“ç¯„åœæ–‡å­—
        function getTimeRangeText(timeRange) {
            const texts = {
                '1day': 'ä¸€æ—¥',
                '1week': 'ä¸€æ˜ŸæœŸ',
                '1month': 'ä¸€å€‹æœˆ',
                '1year': 'ä¸€å¹´'
            };
            return texts[timeRange] || 'ä¸€æ˜ŸæœŸ';
        }

        // è™•ç†è¡€å£“è¶¨å‹¢æ•¸æ“š
        function processBloodPressureTrendData(records, timeRange) {
            const bpRecords = records.filter(record => record.type === 'è¡€å‹' || record.type === 'è¡€å£“');
            
            if (bpRecords.length === 0) {
                return {
                    labels: ['ç„¡æ•¸æ“š'],
                    datasets: [{
                        label: 'æ”¶ç¸®å£“',
                        data: [0],
                        borderColor: '#e74c3c',
                        backgroundColor: '#e74c3c20',
                        tension: 0.4
                    }, {
                        label: 'èˆ’å¼µå£“',
                        data: [0],
                        borderColor: '#3498db',
                        backgroundColor: '#3498db20',
                        tension: 0.4
                    }]
                };
            }
            
            // æŒ‰æ™‚é–“æ’åº
            bpRecords.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            const labels = [];
            const systolicData = [];
            const diastolicData = [];
            
            bpRecords.forEach(record => {
                const date = new Date(record.timestamp);
                let label;
                
                switch (timeRange) {
                    case '1day':
                        label = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                        break;
                    case '1week':
                        label = date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                        break;
                    case '1month':
                        label = date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                        break;
                    case '1year':
                        label = date.toLocaleDateString('zh-CN', { month: 'short' });
                        break;
                    default:
                        label = date.toLocaleDateString('zh-CN');
                }
                
                labels.push(label);
                systolicData.push(record.data.systolic);
                diastolicData.push(record.data.diastolic);
            });
            
            return {
                labels: labels,
                datasets: [{
                    label: 'æ”¶ç¸®å£“',
                    data: systolicData,
                    borderColor: '#e74c3c',
                    backgroundColor: '#e74c3c20',
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }, {
                    label: 'èˆ’å¼µå£“',
                    data: diastolicData,
                    borderColor: '#3498db',
                    backgroundColor: '#3498db20',
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            };
        }

        // è™•ç†ç›¸é—œæ€§æ•¸æ“š
        function processCorrelationData(records) {
            const bpRecords = records.filter(record => record.type === 'è¡€å‹' || record.type === 'è¡€å£“');
            const spo2Records = records.filter(record => record.type === 'è¡€æ°§');
            const tempRecords = records.filter(record => record.type === 'ä½“æ¸©' || record.type === 'é«”æº«');
            
            if (bpRecords.length === 0) {
                return {
                    labels: ['ç„¡æ•¸æ“š'],
                    datasets: [{
                        label: 'æ•¸æ“šå¯ç”¨æ€§',
                        data: [0],
                        backgroundColor: ['#e74c3c'],
                        borderColor: ['#c0392b'],
                        borderWidth: 1
                    }]
                };
            }
            
            // è¨ˆç®—æ•¸æ“šå¯ç”¨æ€§
            const totalRecords = records.length;
            const bpAvailability = bpRecords.length / Math.max(totalRecords, 1);
            const spo2Availability = spo2Records.length / Math.max(totalRecords, 1);
            const tempAvailability = tempRecords.length / Math.max(totalRecords, 1);
            
            // è¨ˆç®—è¡€å£“è®Šç•°æ€§
            let bpVariability = 0;
            if (bpRecords.length > 1) {
                const systolicValues = bpRecords.map(r => r.data.systolic);
                const mean = systolicValues.reduce((a, b) => a + b, 0) / systolicValues.length;
                const variance = systolicValues.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / systolicValues.length;
                bpVariability = Math.sqrt(variance) / mean;
            }
            
            return {
                labels: ['è¡€å£“æ•¸æ“š', 'è¡€æ°§æ•¸æ“š', 'é«”æº«æ•¸æ“š', 'æ•¸æ“šå®Œæ•´æ€§', 'è¡€å£“ç©©å®šæ€§'],
                datasets: [{
                    label: 'å¥åº·æŒ‡æ¨™åˆ†æ',
                    data: [
                        bpAvailability,
                        spo2Availability,
                        tempAvailability,
                        (bpAvailability + spo2Availability + tempAvailability) / 3,
                        Math.max(0, 1 - bpVariability)
                    ],
                    backgroundColor: ['#e74c3c', '#2ecc71', '#f39c12', '#3498db', '#9b59b6'],
                    borderColor: ['#c0392b', '#27ae60', '#e67e22', '#2980b9', '#8e44ad'],
                    borderWidth: 1
                }]
            };
        }

        // è™•ç†å¤šç¶­åº¦æ•¸æ“š
        function processMultiDimensionData(records) {
            const bpRecords = records.filter(record => record.type === 'è¡€å‹' || record.type === 'è¡€å£“');
            const spo2Records = records.filter(record => record.type === 'è¡€æ°§');
            const tempRecords = records.filter(record => record.type === 'ä½“æ¸©' || record.type === 'é«”æº«');
            
            // è¨ˆç®—å„é …å¥åº·æŒ‡æ¨™
            let cardiovascularHealth = 50; // å¿ƒè¡€ç®¡å¥åº·
            let metabolicHealth = 50; // ä»£è¬å¥åº·
            let respiratoryHealth = 50; // å‘¼å¸å¥åº·
            let temperatureStability = 50; // é«”æº«ç©©å®šæ€§
            let dataCompleteness = 50; // æ•¸æ“šå®Œæ•´æ€§
            
            if (bpRecords.length > 0) {
                const latestBP = bpRecords[bpRecords.length - 1];
                const systolic = latestBP.data.systolic;
                const diastolic = latestBP.data.diastolic;
                
                // å¿ƒè¡€ç®¡å¥åº·è©•åˆ†
                if (systolic < 120 && diastolic < 80) cardiovascularHealth = 90;
                else if (systolic < 130 && diastolic < 85) cardiovascularHealth = 80;
                else if (systolic < 140 && diastolic < 90) cardiovascularHealth = 70;
                else if (systolic < 160 && diastolic < 100) cardiovascularHealth = 50;
                else cardiovascularHealth = 30;
            }
            
            if (spo2Records.length > 0) {
                const latestSpO2 = spo2Records[spo2Records.length - 1];
                const percent = latestSpO2.data.percent;
                
                // å‘¼å¸å¥åº·è©•åˆ†
                if (percent >= 98) respiratoryHealth = 90;
                else if (percent >= 95) respiratoryHealth = 80;
                else if (percent >= 90) respiratoryHealth = 60;
                else respiratoryHealth = 30;
            }
            
            if (tempRecords.length > 0) {
                const latestTemp = tempRecords[tempRecords.length - 1];
                const temp = latestTemp.data.value;
                
                // é«”æº«ç©©å®šæ€§è©•åˆ†
                if (temp >= 36.0 && temp <= 37.2) temperatureStability = 90;
                else if (temp >= 35.5 && temp <= 37.5) temperatureStability = 70;
                else if (temp >= 35.0 && temp <= 38.0) temperatureStability = 50;
                else temperatureStability = 30;
            }
            
            // æ•¸æ“šå®Œæ•´æ€§è©•åˆ†
            const totalPossibleRecords = 3; // è¡€å£“ã€è¡€æ°§ã€é«”æº«
            const actualRecords = (bpRecords.length > 0 ? 1 : 0) + 
                                 (spo2Records.length > 0 ? 1 : 0) + 
                                 (tempRecords.length > 0 ? 1 : 0);
            dataCompleteness = (actualRecords / totalPossibleRecords) * 100;
            
            // ä»£è¬å¥åº·åŸºæ–¼è¡€å£“å’Œé«”æº«ç¶œåˆè©•ä¼°
            metabolicHealth = (cardiovascularHealth + temperatureStability) / 2;
            
            return {
                labels: ['å¿ƒè¡€ç®¡å¥åº·', 'ä»£è¬å¥åº·', 'å‘¼å¸å¥åº·', 'é«”æº«ç©©å®šæ€§', 'æ•¸æ“šå®Œæ•´æ€§'],
                datasets: [{
                    label: 'ç•¶å‰ç‹€æ…‹',
                    data: [cardiovascularHealth, metabolicHealth, respiratoryHealth, temperatureStability, dataCompleteness],
                    borderColor: '#3498db',
                    backgroundColor: '#3498db40',
                    pointBackgroundColor: '#3498db',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: '#3498db'
                }, {
                    label: 'ç›®æ¨™ç‹€æ…‹',
                    data: [85, 85, 85, 85, 100],
                    borderColor: '#e74c3c',
                    backgroundColor: '#e74c3c20',
                    pointBackgroundColor: '#e74c3c',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: '#e74c3c'
                }]
            };
        }

        // æ›´æ–°è¶¨å‹¢åœ–è¡¨
        function updateTrendChart() {
            const ctx = document.getElementById('trend-chart');
            if (!ctx) return;

            // éŠ·æ¯€ç¾æœ‰åœ–è¡¨
            if (window.chartInstances && window.chartInstances['trend-chart']) {
                window.chartInstances['trend-chart'].destroy();
            }

            // ç²å–æ™‚é–“ç¯„åœ
            const timeRange = document.getElementById('trend-time-range')?.value || '1week';
            
            // ç²å–çœŸå¯¦æ•¸æ“š
            const records = getDataByTimeRange(timeRange);
            const chartData = processBloodPressureTrendData(records, timeRange);
            
            window.chartInstances = window.chartInstances || {};
            window.chartInstances['trend-chart'] = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `è¡€å£“è¶¨å‹¢åˆ†æ (${getTimeRangeText(timeRange)})`
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 60,
                            max: 200,
                            title: {
                                display: true,
                                text: 'è¡€å£“ (mmHg)'
                            }
                        }
                    }
                }
            });
        }

        // æ›´æ–°ç›¸é—œæ€§åœ–è¡¨
        function updateCorrelationChart() {
            const ctx = document.getElementById('correlation-chart');
            if (!ctx) return;

            // éŠ·æ¯€ç¾æœ‰åœ–è¡¨
            if (window.chartInstances && window.chartInstances['correlation-chart']) {
                window.chartInstances['correlation-chart'].destroy();
            }

            // ç²å–æ™‚é–“ç¯„åœ
            const timeRange = document.getElementById('correlation-time-range')?.value || '1week';
            
            // ç²å–çœŸå¯¦æ•¸æ“š
            const records = getDataByTimeRange(timeRange);
            const chartData = processCorrelationData(records);
            
            window.chartInstances = window.chartInstances || {};
            window.chartInstances['correlation-chart'] = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `å¥åº·æŒ‡æ¨™åˆ†æ (${getTimeRangeText(timeRange)})`
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            title: {
                                display: true,
                                text: 'æŒ‡æ¨™å¼·åº¦'
                            },
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // æ›´æ–°å¤šç¶­åº¦åœ–è¡¨
        function updateMultiDimensionChart() {
            const ctx = document.getElementById('multi-dimension-chart');
            if (!ctx) return;

            // éŠ·æ¯€ç¾æœ‰åœ–è¡¨
            if (window.chartInstances && window.chartInstances['multi-dimension-chart']) {
                window.chartInstances['multi-dimension-chart'].destroy();
            }

            // ç²å–æ™‚é–“ç¯„åœ
            const timeRange = document.getElementById('multi-dimension-time-range')?.value || '1week';
            
            // ç²å–çœŸå¯¦æ•¸æ“š
            const records = getDataByTimeRange(timeRange);
            const chartData = processMultiDimensionData(records);
            
            window.chartInstances = window.chartInstances || {};
            window.chartInstances['multi-dimension-chart'] = new Chart(ctx, {
                type: 'radar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `å¤šç¶­åº¦å¥åº·æŒ‡æ¨™å°æ¯” (${getTimeRangeText(timeRange)})`
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20,
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // æ›´æ–°æ‰€æœ‰åœ–è¡¨
        function updateAllCharts() {
            try {
                updateTrendChart();
                updateCorrelationChart();
                updateMultiDimensionChart();
            } catch (error) {
                console.error('æ›´æ–°åœ–è¡¨å¤±æ•—:', error);
            }
        }

        // ä¿å­˜æ‰€æœ‰æ•¸æ“š
        function saveAllData() {
            const systolic = parseInt(document.getElementById('bp-systolic').value);
            const diastolic = parseInt(document.getElementById('bp-diastolic').value);
            const pulse = parseInt(document.getElementById('bp-pulse').value);
            const spo2Percent = parseFloat(document.getElementById('spo2-percent').value);
            const spo2Pi = parseFloat(document.getElementById('spo2-pi').value);
            const tempValue = parseFloat(document.getElementById('temp-value').value);
            const time = document.getElementById('device-time').value || new Date().toISOString().slice(0, 16);
            const notes = document.getElementById('device-notes').value;
            
            if (!systolic || !diastolic || !pulse) {
                document.getElementById('test-results').innerHTML = '<div class="text-red-600">âŒ è«‹å¡«å¯«å®Œæ•´çš„è¡€å£“æ•¸æ“š</div>';
                return;
            }
            
            try {
                const healthRecords = JSON.parse(localStorage.getItem('healthRecords') || '[]');
                
                // ä¿å­˜è¡€å£“æ•¸æ“š
                const bpData = {
                    id: Date.now(),
                    type: 'è¡€å‹',
                    device: 'è¡€å‹è®¡',
                    time: time,
                    notes: notes,
                    timestamp: new Date().toISOString(),
                    data: {
                        systolic: systolic,
                        diastolic: diastolic,
                        pulse: pulse,
                        assessment: assessBloodPressure(systolic, diastolic)
                    }
                };
                healthRecords.push(bpData);
                
                // ä¿å­˜è¡€æ°§æ•¸æ“šï¼ˆå¦‚æœæœ‰ï¼‰
                if (spo2Percent) {
                    const spo2Data = {
                        id: Date.now() + 1,
                        type: 'è¡€æ°§',
                        device: 'è¡€æ°§è®¡',
                        time: time,
                        notes: notes,
                        timestamp: new Date().toISOString(),
                        data: {
                            percent: spo2Percent,
                            pi: spo2Pi || 2.0,
                            pr: pulse,
                            assessment: assessSpO2(spo2Percent)
                        }
                    };
                    healthRecords.push(spo2Data);
                }
                
                // ä¿å­˜é«”æº«æ•¸æ“šï¼ˆå¦‚æœæœ‰ï¼‰
                if (tempValue) {
                    const tempData = {
                        id: Date.now() + 2,
                        type: 'ä½“æ¸©',
                        device: 'ä½“æ¸©è®¡',
                        time: time,
                        notes: notes,
                        timestamp: new Date().toISOString(),
                        data: {
                            value: tempValue,
                            location: 'è…‹ä¸‹',
                            assessment: assessTemperature(tempValue)
                        }
                    };
                    healthRecords.push(tempData);
                }
                
                localStorage.setItem('healthRecords', JSON.stringify(healthRecords));
                
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('bp-systolic').value = '';
                document.getElementById('bp-diastolic').value = '';
                document.getElementById('bp-pulse').value = '';
                document.getElementById('spo2-percent').value = '';
                document.getElementById('spo2-pi').value = '';
                document.getElementById('temp-value').value = '';
                document.getElementById('device-time').value = '';
                document.getElementById('device-notes').value = '';
                
                // å¯¦æ™‚æ›´æ–°åœ–è¡¨
                updateAllCharts();
                
                document.getElementById('test-results').innerHTML = '<div class="text-green-600">âœ… æ•¸æ“šä¿å­˜æˆåŠŸï¼åœ–è¡¨å·²å¯¦æ™‚æ›´æ–°</div>';
            } catch (error) {
                document.getElementById('test-results').innerHTML = `<div class="text-red-600">âŒ ä¿å­˜å¤±æ•—: ${error.message}</div>`;
            }
        }

        // è©•ä¼°å‡½æ•¸
        function assessBloodPressure(systolic, diastolic) {
            if (systolic >= 180 || diastolic >= 110) {
                return { level: 'é«˜è¡€å‹3çº§', color: 'red', advice: 'ç«‹å³å°±åŒ»' };
            } else if (systolic >= 160 || diastolic >= 100) {
                return { level: 'é«˜è¡€å‹2çº§', color: 'orange', advice: 'å»ºè®®å°±åŒ»' };
            } else if (systolic >= 140 || diastolic >= 90) {
                return { level: 'é«˜è¡€å‹1çº§', color: 'yellow', advice: 'æ³¨æ„ç›‘æµ‹' };
            } else if (systolic >= 130 || diastolic >= 85) {
                return { level: 'æ­£å¸¸é«˜å€¼', color: 'blue', advice: 'ä¿æŒå¥åº·' };
            } else if (systolic >= 120 || diastolic >= 80) {
                return { level: 'æ­£å¸¸', color: 'green', advice: 'è‰¯å¥½' };
            } else {
                return { level: 'ç†æƒ³', color: 'green', advice: 'ä¼˜ç§€' };
            }
        }

        function assessSpO2(percent) {
            if (percent >= 98) return { level: 'æ­£å¸¸', color: 'green', advice: 'è¡€æ°§è‰¯å¥½' };
            if (percent >= 95) return { level: 'æ­£å¸¸', color: 'green', advice: 'è¡€æ°§æ­£å¸¸' };
            if (percent >= 90) return { level: 'åä½', color: 'yellow', advice: 'æ³¨æ„ç›‘æµ‹' };
            return { level: 'ä½', color: 'red', advice: 'å»ºè®®å°±åŒ»' };
        }

        function assessTemperature(temp) {
            if (temp >= 36.0 && temp <= 37.2) return { level: 'æ­£å¸¸', color: 'green', advice: 'ä½“æ¸©æ­£å¸¸' };
            if (temp >= 35.5 && temp <= 37.5) return { level: 'æ­£å¸¸', color: 'green', advice: 'ä½“æ¸©æ­£å¸¸' };
            if (temp >= 35.0 && temp <= 38.0) return { level: 'æ³¨æ„', color: 'yellow', advice: 'æ³¨æ„ç›‘æµ‹' };
            return { level: 'å¼‚å¸¸', color: 'red', advice: 'å»ºè®®å°±åŒ»' };
        }

        // é é¢åŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const timeString = now.toISOString().slice(0, 16);
            document.getElementById('device-time').value = timeString;
            
            // åˆå§‹åŒ–åœ–è¡¨
            updateAllCharts();
            
            document.getElementById('test-results').innerHTML = '<div class="text-blue-600">â„¹ï¸ é é¢åŠ è¼‰å®Œæˆï¼Œåœ–è¡¨å·²åˆå§‹åŒ–ã€‚è«‹éŒ„å…¥æ•¸æ“šæ¸¬è©¦å¯¦æ™‚æ›´æ–°åŠŸèƒ½ã€‚</div>';
        });
    </script>
</body>
</html>
