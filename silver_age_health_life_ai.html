<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>银龄康伴 AI - 专业健康管理助手</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // 抑制 Tailwind CSS 生產環境警告
        (function() {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                const message = args[0];
                if (typeof message === 'string' && message.includes('cdn.tailwindcss.com should not be used in production')) {
                    return; // 忽略 Tailwind CSS 生產環境警告
                }
                originalWarn.apply(console, args);
            };
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/date-fns.min.js"></script>
    <!-- 科學算法模塊 -->
    <script src="scientific_health_assessment.js"></script>
    <!-- 暫時註釋專業模塊，避免按鈕失效 -->
    <!-- <script src="professional_health_assessment.js"></script> -->
    <!-- <script src="professional_visualization.js"></script> -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); 
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .app-container { 
            max-width: 450px; 
            min-height: 800px; 
            margin: 0 auto; 
            height: 100vh; 
            overflow: visible;
            position: relative;
        }
        
        .page-content { 
            display: block; 
            visibility: visible; 
            opacity: 1;
            transform: translateX(0);
            transition: all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        /* 苹果风格的弹簧动画曲线 */
        .spring-bounce { transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .spring-smooth { transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .spring-quick { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .spring-natural { transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1); }
        
        /* 统一的按钮样式系统 */
        .btn-main { 
            @apply w-full py-4 rounded-2xl text-base font-semibold shadow-lg flex items-center justify-center relative overflow-hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform: translateY(0) scale(1);
            border: none;
            cursor: pointer;
            position: relative;
        }
        
        .btn-main::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-main:hover::before {
            left: 100%;
        }
        
        .btn-main:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .btn-main:active {
            transform: translateY(0) scale(0.98);
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-main.loading {
            pointer-events: none;
            opacity: 0.7;
        }
        
        .btn-main.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .btn-secondary { 
            @apply w-full py-3 rounded-xl text-sm font-medium shadow-md flex items-center justify-center;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform: translateY(0);
        }
        
        .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .btn-secondary:active {
            transform: translateY(0);
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* 卡片系统 */
        .card { 
            @apply bg-white rounded-2xl shadow-lg p-6 mb-6 relative overflow-hidden;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform: translateY(0) scale(1);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .card:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .card-hover { 
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .card-hover:active {
            transform: translateY(-2px) scale(0.99);
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* 输入框系统 */
        .input-field { 
            @apply w-full p-4 border-2 border-gray-200 rounded-xl text-base bg-white;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform: scale(1);
        }
        
        .input-field:focus { 
            @apply outline-none border-blue-500;
            transform: scale(1.02);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        
        .input-field:invalid {
            @apply border-red-400;
            animation: shake 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        /* 文本样式 */
        .text-title { @apply text-xl font-bold text-gray-800; }
        .text-subtitle { @apply text-lg font-semibold text-gray-700; }
        .text-small { @apply text-sm text-gray-500; }
        .text-primary { @apply text-blue-600; }
        .text-success { @apply text-green-600; }
        .text-warning { @apply text-yellow-600; }
        .text-danger { @apply text-red-600; }
        
        /* 背景色系统 */
        .bg-primary { @apply bg-blue-600; }
        .bg-success { @apply bg-green-600; }
        .bg-warning { @apply bg-yellow-600; }
        .bg-danger { @apply bg-red-600; }
        
        .empty-state { @apply text-center py-8 text-gray-500; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .glass-morphism { 
            backdrop-filter: blur(20px); 
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
        }
        
        /* 苹果风格的动画效果 */
        @keyframes springIn {
            0% { 
                opacity: 0; 
                transform: translateY(30px) scale(0.9); 
            }
            60% { 
                opacity: 1; 
                transform: translateY(-5px) scale(1.02); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        @keyframes springOut {
            0% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
            100% { 
                opacity: 0; 
                transform: translateY(-30px) scale(0.9); 
            }
        }
        
        @keyframes slideInRight {
            0% { 
                opacity: 0; 
                transform: translateX(100px); 
            }
            100% { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }
        
        @keyframes slideInLeft {
            0% { 
                opacity: 0; 
                transform: translateX(-100px); 
            }
            100% { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }
        
        @keyframes bounceIn {
            0% { 
                opacity: 0; 
                transform: scale(0.3); 
            }
            50% { 
                opacity: 1; 
                transform: scale(1.05); 
            }
            70% { 
                transform: scale(0.9); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1); 
            }
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
                opacity: 1; 
            }
            50% { 
                transform: scale(1.05); 
                opacity: 0.8; 
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        /* 动画类 */
        .animate-spring-in { animation: springIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .animate-spring-out { animation: springOut 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .animate-slide-in-right { animation: slideInRight 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .animate-slide-in-left { animation: slideInLeft 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .animate-bounce-in { animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        /* 页面切换动画 */
        .page-enter {
            animation: slideInRight 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .page-exit {
            animation: slideInLeft 0.3s cubic-bezier(0.4, 0, 0.2, 1) reverse;
        }
        
        /* 反馈系统 */
        .feedback-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
            animation: springIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .feedback-error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
            animation: shake 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .feedback-loading {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* 涟漪效果 */
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            animation: ripple 0.6s linear;
        }
        
        /* 主题切换 */
        .light-mode { 
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%) !important; 
        }
        .light-mode .app-container { 
            background: #ffffff !important; 
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important; 
            border: 1px solid #e2e8f0 !important; 
        }
        .light-mode .gradient-bg { 
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%) !important; 
        }
        .light-mode .card { 
            background: #ffffff !important; 
            border: 1px solid #e2e8f0 !important; 
            color: #1f2937 !important;
        }
        .light-mode .card-header { 
            background: #f8fafc !important; 
            border-bottom: 1px solid #e2e8f0 !important; 
        }
        .light-mode .text-title { 
            color: #1f2937 !important; 
        }
        .light-mode .text-subtitle { 
            color: #374151 !important; 
        }
        .light-mode .text-small { 
            color: #6b7280 !important; 
        }
        .light-mode .text-primary { 
            color: #3b82f6 !important; 
        }
        .light-mode .input-field { 
            background: #ffffff !important; 
            border-color: #d1d5db !important; 
            color: #1f2937 !important; 
        }
        .light-mode .input-field:focus { 
            border-color: #3b82f6 !important; 
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1) !important; 
        }
        .light-mode .btn-main { 
            background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important; 
            color: #ffffff !important; 
        }
        .light-mode .btn-secondary { 
            background: linear-gradient(135deg, #6b7280, #4b5563) !important; 
            color: #ffffff !important; 
        }
        .light-mode .feedback-success { 
            background: linear-gradient(135deg, #10b981, #059669) !important; 
            color: #ffffff !important; 
        }
        .light-mode .feedback-error { 
            background: linear-gradient(135deg, #ef4444, #dc2626) !important; 
            color: #ffffff !important; 
        }
        .light-mode .feedback-loading { 
            background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important; 
            color: #ffffff !important; 
        }
        
        /* 深色模式样式 */
        .dark-mode { 
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%) !important; 
        }
        .dark-mode .app-container { 
            background: rgba(30, 27, 75, 0.95) !important; 
            backdrop-filter: blur(20px) !important; 
            border: 1px solid rgba(255, 255, 255, 0.1) !important; 
        }
        .dark-mode .card { 
            background: rgba(30, 27, 75, 0.8) !important; 
            border: 1px solid rgba(255, 255, 255, 0.1) !important; 
            color: #e5e7eb !important;
        }
        .dark-mode .card-header { 
            background: rgba(49, 46, 129, 0.5) !important; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important; 
        }
        .dark-mode .text-title { 
            color: #f9fafb !important; 
        }
        .dark-mode .text-subtitle { 
            color: #d1d5db !important; 
        }
        .dark-mode .text-small { 
            color: #9ca3af !important; 
        }
        .dark-mode .text-primary { 
            color: #60a5fa !important; 
        }
        .dark-mode .input-field { 
            background: rgba(30, 27, 75, 0.8) !important; 
            border-color: rgba(255, 255, 255, 0.2) !important; 
            color: #f9fafb !important; 
        }
        .dark-mode .input-field:focus { 
            border-color: #60a5fa !important; 
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.1) !important; 
        }
        .dark-mode .input-field::placeholder { 
            color: #9ca3af !important; 
        }
        
        /* 响应式设计 */
        @media (max-width: 480px) {
            .app-container {
                max-width: 100%;
                border-radius: 0;
            }
            
            .card {
                margin: 0 16px 24px 16px;
                border-radius: 16px;
            }
            
            .btn-main {
                margin: 0 16px;
                border-radius: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- 主页容器 -->
    <div class="app-container bg-white rounded-3xl shadow-xl relative">
        <!-- 顶部状态栏 -->
        <div class="gradient-bg text-white p-3 flex justify-between items-center">
            <span class="text-sm font-medium" id="real-time">14:30</span>
            <div class="flex space-x-3">
                <i class="fa fa-signal text-sm"></i>
                <i class="fa fa-wifi text-sm"></i>
                <i class="fa fa-battery-three-quarters text-sm"></i>
            </div>
        </div>

        <!-- 主页 -->
        <div id="page-home" class="h-[calc(100vh-56px)] overflow-y-auto page-content" style="display: block !important; visibility: visible !important; opacity: 1 !important;">
            <!-- 顶部欢迎区域 -->
            <div class="gradient-bg p-6 text-white relative" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                <div class="relative z-10">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h1 class="text-[clamp(1.5rem,5vw,2rem)] font-bold mb-2 neon-glow animate-glow">专业健康管理助手</h1>
                            <p class="text-white/90 text-base animate-float">科学管理，健康生活</p>
                        </div>
                        <button onclick="handleAction('showSettingsPanel')" class="text-white/80 hover:text-white transition-colors">
                            <i class="fa fa-cog text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 功能按钮区域 -->
            <div class="p-5">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button onclick="handleAction('showPage', 'page-medicine')" class="btn-main text-white ripple spring-bounce animate-spring-in" data-delay="0" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                        <i class="fa fa-pills text-2xl mb-2 block"></i>
                        <span>用药记录</span>
                    </button>
                    
                    <button onclick="handleAction('showPage', 'page-exam')" class="btn-main text-white ripple spring-bounce animate-spring-in" data-delay="100" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                        <i class="fa fa-stethoscope text-2xl mb-2 block"></i>
                        <span>体检预约</span>
                    </button>
                    
                    <button onclick="handleAction('showPage', 'page-diet')" class="btn-main text-white ripple spring-bounce animate-spring-in" data-delay="200" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <i class="fa fa-apple text-2xl mb-2 block"></i>
                        <span>饮食建议</span>
                    </button>
                    
                    <button onclick="handleAction('showPage', 'page-exercise')" class="btn-main text-white ripple spring-bounce animate-spring-in" data-delay="300" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                        <i class="fa fa-heartbeat text-2xl mb-2 block"></i>
                        <span>运动记录</span>
                    </button>
                    
                    <button onclick="handleAction('showPage', 'page-goals')" class="btn-main text-white ripple spring-bounce animate-spring-in" data-delay="400" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                        <i class="fa fa-flag text-2xl mb-2 block"></i>
                        <span>健康目标</span>
                    </button>
                    
                    <button onclick="handleAction('showPage', 'page-health-data')" class="btn-main text-white ripple spring-bounce animate-spring-in" data-delay="500" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                        <i class="fa fa-line-chart text-2xl mb-2 block"></i>
                        <span>健康数据</span>
                    </button>
                </div>
            </div>
        </div>

            <!-- 悬浮快捷操作 -->
            <div class="fixed right-5 bottom-6 z-40 flex flex-col items-end space-y-3">
                <button id="fab-add-record" class="rounded-full shadow-lg text-white w-14 h-14 flex items-center justify-center spring-bounce ripple animate-bounce-in" title="添加記錄" data-delay="600" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                    <i class="fa fa-plus text-lg"></i>
                </button>
                <button id="fab-view-report" class="rounded-full shadow-lg text-white w-14 h-14 flex items-center justify-center spring-bounce ripple animate-bounce-in" title="查看報告" data-delay="700" style="background: linear-gradient(135deg, #6b7280, #4b5563);">
                    <i class="fa fa-file-text-o text-lg"></i>
                </button>
                <button id="fab-open-ai" class="rounded-full shadow-lg text-white w-14 h-14 flex items-center justify-center spring-bounce ripple animate-bounce-in" title="AI 健康助手" data-delay="800" style="background: linear-gradient(135deg, #10b981, #059669);" onclick="handleAction('openAIHealthAssistant')">
                    <i class="fa fa-comments text-lg"></i>
                </button>
            </div>

        <!-- 设置面板 -->
        <div id="settings-panel" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">系统设置</h3>
                    <button onclick="handleAction('closeSettingsPanel')" class="text-gray-500 hover:text-gray-700 transition-colors">
                        <i class="fa fa-times text-2xl"></i>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- 主题设置 -->
                    <div class="card">
                        <div class="card-header">
                            <h4 class="text-lg font-semibold text-gray-800">主题设置</h4>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-700">深色模式</span>
                                <button id="theme-toggle" onclick="handleAction('toggleTheme')" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                    <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1"></span>
                                </button>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-700">自动切换主题</span>
                                <button id="auto-theme-toggle" onclick="handleAction('toggleAutoTheme')" class="relative inline-flex h-6 w-11 items-center rounded-full bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                    <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-1"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 通知设置 -->
                    <div class="card">
                        <div class="card-header">
                            <h4 class="text-lg font-semibold text-gray-800">通知设置</h4>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-700">用药提醒</span>
                                <button id="medication-reminder-toggle" onclick="handleAction('toggleMedicationReminder')" class="relative inline-flex h-6 w-11 items-center rounded-full bg-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                    <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-6"></span>
                                </button>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-700">体检提醒</span>
                                <button id="exam-reminder-toggle" onclick="handleAction('toggleExamReminder')" class="relative inline-flex h-6 w-11 items-center rounded-full bg-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                    <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-6"></span>
                                </button>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-700">健康报告提醒</span>
                                <button id="report-reminder-toggle" onclick="handleAction('toggleReportReminder')" class="relative inline-flex h-6 w-11 items-center rounded-full bg-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                    <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform translate-x-6"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 数据管理 -->
                    <div class="card">
                        <div class="card-header">
                            <h4 class="text-lg font-semibold text-gray-800">数据管理</h4>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <span class="text-gray-700 block">导出健康数据</span>
                                    <span class="text-sm text-gray-500">导出所有健康记录为JSON格式</span>
                                </div>
                                <button onclick="handleAction('exportHealthData')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                    <i class="fa fa-download mr-2"></i>导出
                                </button>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <span class="text-gray-700 block">导入健康数据</span>
                                    <span class="text-sm text-gray-500">从JSON文件导入健康记录</span>
                                </div>
                                <button onclick="handleAction('importHealthData')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    <i class="fa fa-upload mr-2"></i>导入
                                </button>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <span class="text-gray-700 block">清除所有数据</span>
                                    <span class="text-sm text-gray-500">删除所有健康记录（不可恢复）</span>
                                </div>
                                <button onclick="handleAction('clearAllData')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                    <i class="fa fa-trash mr-2"></i>清除
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 系统信息 -->
                    <div class="card">
                        <div class="card-header">
                            <h4 class="text-lg font-semibold text-gray-800">系统信息</h4>
                        </div>
                        <div class="space-y-2 text-sm text-gray-600">
                            <div class="flex justify-between">
                                <span>应用版本:</span>
                                <span class="font-medium">v2.1.0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>AI模型:</span>
                                <span class="font-medium">DeepSeek-Health-v2.1</span>
                            </div>
                            <div class="flex justify-between">
                                <span>数据安全等级:</span>
                                <span class="font-medium text-green-600">医疗级</span>
                            </div>
                            <div class="flex justify-between">
                                <span>最后更新:</span>
                                <span class="font-medium">2025-09-28</span>
                            </div>
                        </div>
                    </div>

                    <!-- 关于 -->
                    <div class="card">
                        <div class="card-header">
                            <h4 class="text-lg font-semibold text-gray-800">关于</h4>
                        </div>
                        <div class="text-sm text-gray-600 space-y-2">
                            <p>银龄康伴 AI 是一款专为老年人设计的智能健康管理应用，集成了先进的AI技术和专业的健康评估模型。</p>
                            <p>本应用提供个性化的健康建议、智能提醒和专业的数据分析，帮助用户更好地管理自己的健康。</p>
                            <div class="flex space-x-4 mt-4">
                                <a href="#" onclick="showHelpCenter()" class="text-blue-600 hover:text-blue-800 transition-colors cursor-pointer">
                                    <i class="fa fa-question-circle mr-1"></i>帮助中心
                                </a>
                                <a href="#" onclick="showContactUs()" class="text-blue-600 hover:text-blue-800 transition-colors cursor-pointer">
                                    <i class="fa fa-envelope mr-1"></i>联系我们
                                </a>
                                <a href="#" onclick="showPrivacyPolicy()" class="text-blue-600 hover:text-blue-800 transition-colors cursor-pointer">
                                    <i class="fa fa-shield mr-1"></i>隐私政策
                                </a>
                            </div>
                            
                            <!-- 开发者后台入口 -->
                            <div class="mt-6 pt-4 border-t border-gray-200">
                                <h5 class="text-sm font-medium text-gray-700 mb-3">开发者工具</h5>
                                <button onclick="showDeveloperDashboard()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded text-sm flex items-center">
                                    <i class="fa fa-dashboard mr-2"></i>查看用户反馈
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 操作提示系统 -->
        <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 hidden">
            <div class="feedback-success flex items-center px-6 py-4 rounded-2xl shadow-2xl">
                <i class="fa fa-check-circle mr-3 text-lg"></i>
                <span id="toast-text" class="font-medium">操作成功</span>
            </div>
        </div>
        
        <!-- 加载提示 -->
        <div id="loading-toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 hidden">
            <div class="feedback-loading flex items-center px-6 py-4 rounded-2xl shadow-2xl">
                <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-3"></div>
                <span id="loading-text" class="font-medium">处理中...</span>
            </div>
        </div>
        
        <!-- 错误提示 -->
        <div id="error-toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 hidden">
            <div class="feedback-error flex items-center px-6 py-4 rounded-2xl shadow-2xl">
                <i class="fa fa-exclamation-circle mr-3 text-lg"></i>
                <span id="error-text" class="font-medium">操作失败</span>
            </div>
        </div>
        <!-- 用药记录页面 -->
        <div id="page-medicine" class="hidden h-[calc(100vh-56px)] overflow-y-auto p-5 page-content">
            <div class="flex items-center mb-5">
                <button onclick="handleAction('showPage', 'page-home')" class="text-primary mr-4"><i class="fa fa-arrow-left text-xl"></i></button>
                <h2 class="text-title">用药记录管理</h2>
            </div>
            
            <!-- 添加用药记录表单 -->
            <div class="card mb-5">
                <div class="card-header">
                    <h3 class="text-title">添加用药记录</h3>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-base mb-2">药物名称</label>
                        <input type="text" id="medicine-name" placeholder="例如：阿司匹林" class="input-field">
                    </div>
                    <div>
                        <label class="block text-base mb-2">用药时间</label>
                        <input type="datetime-local" id="medicine-time" class="input-field">
                    </div>
                    <div>
                        <label class="block text-base mb-2">用药剂量</label>
                        <input type="text" id="medicine-dose" placeholder="例如：100mg" class="input-field">
                    </div>
                    <div>
                        <label class="block text-base mb-2">用药原因</label>
                        <textarea id="medicine-reason" placeholder="例如：缓解头痛" class="input-field" rows="3"></textarea>
                    </div>
                    <button onclick="handleAction('addMedicineRecord')" class="w-full py-3 bg-primary text-white rounded-xl text-base font-semibold hover:bg-primary/90 transition-colors">
                        <i class="fa fa-plus-circle mr-2"></i> 添加记录
                    </button>
                </div>
            </div>
            
            <!-- 用药记录历史 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="text-title">用药记录历史</h3>
                    <button onclick="handleAction('clearMedicineRecords')" class="text-danger text-sm hover:underline transition-all">
                        <i class="fa fa-trash mr-1"></i> 清空
                    </button>
                </div>
                <div id="medicine-records" class="space-y-3">
                    <!-- 记录将动态生成 -->
                </div>
            </div>
        </div>

        <!-- 体检预约页面 -->
        <div id="page-exam" class="hidden h-[calc(100vh-56px)] overflow-y-auto p-5 page-content">
            <div class="flex items-center mb-5">
                <button onclick="handleAction('showPage', 'page-home')" class="text-primary mr-4"><i class="fa fa-arrow-left text-xl"></i></button>
                <h2 class="text-title">体检预约管理</h2>
            </div>
            
            <!-- 添加体检预约表单 -->
            <div class="card mb-5">
                <div class="card-header">
                    <h3 class="text-title">添加体检预约</h3>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-base mb-2">体检类型</label>
                        <select id="exam-type" class="input-field">
                            <option value="">请选择体检类型</option>
                            <option value="常规体检">常规体检</option>
                            <option value="心血管检查">心血管检查</option>
                            <option value="血糖检查">血糖检查</option>
                            <option value="血压检查">血压检查</option>
                            <option value="眼科检查">眼科检查</option>
                            <option value="口腔检查">口腔检查</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-base mb-2">预约日期</label>
                        <input type="date" id="exam-date" class="input-field">
                    </div>
                    <div>
                        <label class="block text-base mb-2">预约时间</label>
                        <input type="time" id="exam-time" class="input-field">
                    </div>
                    <div>
                        <label class="block text-base mb-2">医院/诊所</label>
                        <input type="text" id="exam-hospital" placeholder="例如：市人民医院" class="input-field">
                    </div>
                    <div>
                        <label class="block text-base mb-2">备注</label>
                        <textarea id="exam-notes" placeholder="例如：需要空腹" class="input-field" rows="3"></textarea>
                    </div>
                    <button onclick="handleAction('addExamAppointment')" class="w-full py-3 bg-primary text-white rounded-xl text-base font-semibold hover:bg-primary/90 transition-colors">
                        <i class="fa fa-calendar-plus-o mr-2"></i> 确认预约
                    </button>
                </div>
            </div>
            
            <!-- 体检预约历史 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="text-title">历史体检记录</h3>
                    <button onclick="handleAction('clearExamRecords')" class="text-danger text-sm hover:underline transition-all">
                        <i class="fa fa-trash mr-1"></i> 清空历史
                    </button>
                </div>
                <div id="exam-records" class="space-y-3">
                    <!-- 记录将动态生成 -->
                </div>
            </div>
        </div>

        <!-- 饮食建议页面 -->
        <div id="page-diet" class="hidden h-[calc(100vh-56px)] overflow-y-auto p-5 page-content">
            <div class="flex items-center mb-5">
                <button onclick="handleAction('showPage', 'page-home')" class="text-primary mr-4"><i class="fa fa-arrow-left text-xl"></i></button>
                <h2 class="text-title">饮食健康管理</h2>
            </div>
            
            <!-- 饮食记录表单 -->
            <div class="card mb-5">
                <div class="card-header">
                    <h3 class="text-title">记录饮食</h3>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-base mb-2">用餐时间</label>
                        <select id="meal-time" class="input-field">
                            <option value="早餐">早餐</option>
                            <option value="午餐">午餐</option>
                            <option value="晚餐">晚餐</option>
                            <option value="加餐">加餐</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-base mb-2">食物内容</label>
                        <textarea id="food-content" placeholder="例如：白米饭、青菜、瘦肉" class="input-field" rows="3"></textarea>
                    </div>
                    <div>
                        <label class="block text-base mb-2">用餐时间</label>
                        <input type="datetime-local" id="diet-time" class="input-field">
                    </div>
                    <button onclick="handleAction('saveDietRecord')" class="w-full py-3 bg-primary text-white rounded-xl text-base font-semibold hover:bg-primary/90 transition-colors">
                        <i class="fa fa-save mr-2"></i> 保存记录
                    </button>
                </div>
            </div>
            
            <!-- 饮食建议 -->
            <div class="card mb-5">
                <div class="card-header">
                    <h3 class="text-title">个性化饮食建议</h3>
                    <button onclick="handleAction('generateDietAdvice')" class="text-primary text-sm hover:underline transition-all">
                        <i class="fa fa-refresh mr-1"></i> 更新建议
                    </button>
                </div>
                <div id="diet-advice" class="text-base space-y-2">
                    <p class="text-neutral-500">点击"更新建议"获取个性化饮食建议</p>
                </div>
            </div>
            
            <!-- 饮食记录历史 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="text-title">饮食记录历史</h3>
                </div>
                <div id="diet-records" class="space-y-3">
                    <!-- 记录将动态生成 -->
                </div>
            </div>
        </div>

        <!-- 运动记录页面 -->
        <div id="page-exercise" class="hidden h-[calc(100vh-56px)] overflow-y-auto p-5 page-content">
            <div class="flex items-center mb-5">
                <button onclick="handleAction('showPage', 'page-home')" class="text-primary mr-4"><i class="fa fa-arrow-left text-xl"></i></button>
                <h2 class="text-title">运动记录管理</h2>
            </div>
            
            <!-- 添加运动记录表单 -->
            <div class="card mb-5">
                <div class="card-header">
                    <h3 class="text-title">添加运动记录</h3>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-base mb-2">运动类型</label>
                        <select id="exercise-type" class="input-field">
                            <option value="">请选择运动类型</option>
                            <option value="散步">散步</option>
                            <option value="跑步">跑步</option>
                            <option value="游泳">游泳</option>
                            <option value="骑自行车">骑自行车</option>
                            <option value="太极拳">太极拳</option>
                            <option value="瑜伽">瑜伽</option>
                            <option value="健身">健身</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-base mb-2">运动时长（分钟）</label>
                        <input type="number" id="exercise-duration" placeholder="例如：30" class="input-field">
                    </div>
                    <div>
                        <label class="block text-base mb-2">运动强度</label>
                        <select id="exercise-intensity" class="input-field">
                            <option value="低">低强度</option>
                            <option value="中">中等强度</option>
                            <option value="高">高强度</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-base mb-2">运动时间</label>
                        <input type="datetime-local" id="exercise-time" class="input-field">
                    </div>
                    <div>
                        <label class="block text-base mb-2">备注</label>
                        <textarea id="exercise-notes" placeholder="例如：感觉很好" class="input-field" rows="3"></textarea>
                    </div>
                    <button onclick="handleAction('addExerciseRecord')" class="w-full py-3 bg-primary text-white rounded-xl text-base font-semibold hover:bg-primary/90 transition-colors">
                        <i class="fa fa-plus-circle mr-2"></i> 添加记录
                    </button>
                </div>
            </div>
            
            <!-- 运动记录历史 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="text-title">运动记录历史</h3>
                    <button onclick="handleAction('clearExerciseRecords')" class="text-danger text-sm hover:underline transition-all">
                        <i class="fa fa-trash mr-1"></i> 清空
                    </button>
                </div>
                <div id="exercise-records" class="space-y-3">
                    <!-- 记录将动态生成 -->
                </div>
            </div>
        </div>

        <!-- 健康目标页面 -->
        <div id="page-goals" class="hidden h-[calc(100vh-56px)] overflow-y-auto p-5 page-content">
            <div class="flex items-center mb-5">
                <button onclick="handleAction('showPage', 'page-home')" class="text-primary mr-4"><i class="fa fa-arrow-left text-xl"></i></button>
                <h2 class="text-title">健康目标管理</h2>
            </div>
            
            <!-- 添加健康目标表单 -->
            <div class="card mb-5">
                <div class="card-header">
                    <h3 class="text-title">添加健康目标</h3>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-base mb-2">目标类型</label>
                        <select id="goal-type" class="input-field">
                            <option value="">请选择目标类型</option>
                            <option value="体重管理">体重管理</option>
                            <option value="运动目标">运动目标</option>
                            <option value="饮食目标">饮食目标</option>
                            <option value="睡眠目标">睡眠目标</option>
                            <option value="血压控制">血压控制</option>
                            <option value="血糖控制">血糖控制</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-base mb-2">目标描述</label>
                        <textarea id="goal-description" placeholder="例如：每天步行30分钟" class="input-field" rows="3"></textarea>
                    </div>
                    <div>
                        <label class="block text-base mb-2">目标期限</label>
                        <input type="date" id="goal-deadline" class="input-field">
                    </div>
                    <div>
                        <label class="block text-base mb-2">目标优先级</label>
                        <select id="goal-priority" class="input-field">
                            <option value="低">低优先级</option>
                            <option value="中">中等优先级</option>
                            <option value="高">高优先级</option>
                        </select>
                    </div>
                    <button onclick="handleAction('addHealthGoal')" class="w-full py-3 bg-primary text-white rounded-xl text-base font-semibold hover:bg-primary/90 transition-colors">
                        <i class="fa fa-plus-circle mr-2"></i> 添加目标
                    </button>
                </div>
            </div>
            
            <!-- 健康目标列表 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="text-title">我的健康目标</h3>
                    <button onclick="handleAction('clearCompletedGoals')" class="text-success text-sm hover:underline transition-all">
                        <i class="fa fa-check mr-1"></i> 清理已完成
                    </button>
                </div>
                <div id="health-goals" class="space-y-3">
                    <!-- 目标将动态生成 -->
                </div>
            </div>
        </div>

        <!-- 健康数据页面 -->
        <div id="page-health-data" class="hidden min-h-[calc(100vh-56px)] overflow-y-auto p-5 page-content">
            <div class="flex items-center mb-5">
                <button onclick="handleAction('showPage', 'page-home')" class="text-primary mr-4"><i class="fa fa-arrow-left text-xl"></i></button>
                <h2 class="text-title">专业健康数据管理</h2>
            </div>
            
            <!-- 专业健康评估 -->
            <div class="card mb-5">
                <div class="card-header">
                    <h3 class="text-title">DeepSeek健康评估模型</h3>
                    <button onclick="handleAction('showAlgorithmTransparency')" class="text-primary text-sm hover:underline transition-all">
                        <i class="fa fa-info-circle mr-1"></i> 算法透明度
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-base mb-2">年龄</label>
                            <input type="number" id="assessment-age" placeholder="请输入年龄" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">性别</label>
                            <select id="assessment-gender" class="input-field">
                                <option value="">请选择性别</option>
                                <option value="男">男</option>
                                <option value="女">女</option>
                            </select>
                        </div>
                        <!-- 血壓數據已從智能設備錄入中獲取，無需重複填寫 -->
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded">
                            <div class="flex items-center">
                                <i class="fa fa-info-circle text-blue-500 mr-2"></i>
                                <p class="text-sm text-blue-700">
                                    <strong>血壓數據</strong>：將從智能設備數據錄入中自動獲取，無需在此填寫
                                </p>
                            </div>
                        </div>
                        <div>
                            <label class="block text-base mb-2">身高 (cm)</label>
                            <input type="number" id="assessment-height" placeholder="例如：170" class="input-field" oninput="calculateBMI()">
                        </div>
                        <div>
                            <label class="block text-base mb-2">体重 (kg)</label>
                            <input type="number" id="assessment-weight" placeholder="例如：65" class="input-field" oninput="calculateBMI()">
                        </div>
                        <div>
                            <label class="block text-base mb-2">BMI (自动计算)</label>
                            <input type="number" id="assessment-bmi" placeholder="将自动计算" class="input-field" readonly>
                            <div id="bmi-category" class="text-sm mt-1"></div>
                        </div>
                        <div>
                            <label class="block text-base mb-2">血糖 (mg/dL)</label>
                            <input type="number" id="assessment-glucose" placeholder="例如：95" class="input-field">
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-base mb-2">医疗史</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="history-diabetes" class="mr-2">
                                    <span class="text-sm">糖尿病</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="history-hypertension" class="mr-2">
                                    <span class="text-sm">高血压</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="history-heart" class="mr-2">
                                    <span class="text-sm">心脏病</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-base mb-2">生活方式</label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="lifestyle-smoking" class="mr-2">
                                    <span class="text-sm">吸烟</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="lifestyle-exercise" class="mr-2">
                                    <span class="text-sm">规律运动</span>
                                </label>
                            </div>
                        </div>
                        <button onclick="handleAction('runHealthAssessment')" class="w-full py-3 bg-primary text-white rounded-xl text-base font-semibold hover:bg-primary/90 transition-colors">
                            <i class="fa fa-calculator mr-2"></i> 运行健康评估
                        </button>
                    </div>
                </div>
            </div>

            <!-- 专业数据可视化 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 mb-5">
                <!-- 趋势分析图表 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-title">健康指标趋势分析</h3>
                        <div class="flex items-center space-x-2">
                            <select id="trend-time-range" class="text-sm border border-gray-300 rounded px-2 py-1" onchange="updateTrendChart()">
                                <option value="1day">一日</option>
                                <option value="1week" selected>一星期</option>
                                <option value="1month">一個月</option>
                                <option value="1year">一年</option>
                            </select>
                            <button onclick="updateTrendChart()" class="text-primary text-sm hover:underline transition-all">
                                <i class="fa fa-refresh mr-1"></i> 更新
                            </button>
                        </div>
                    </div>
                    <div class="p-4">
                        <canvas id="trend-chart" height="300"></canvas>
                    </div>
                </div>

                <!-- 相关性分析图表 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-title">指标相关性分析</h3>
                        <div class="flex items-center space-x-2">
                            <select id="correlation-time-range" class="text-sm border border-gray-300 rounded px-2 py-1" onchange="updateCorrelationChart()">
                                <option value="1day">一日</option>
                                <option value="1week" selected>一星期</option>
                                <option value="1month">一個月</option>
                                <option value="1year">一年</option>
                            </select>
                            <button onclick="updateCorrelationChart()" class="text-primary text-sm hover:underline transition-all">
                                <i class="fa fa-refresh mr-1"></i> 更新
                            </button>
                        </div>
                    </div>
                    <div class="p-4">
                        <canvas id="correlation-chart" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- 多维度健康对比 -->
            <div class="card mb-5">
                <div class="card-header">
                    <h3 class="text-title">多维度健康指标对比</h3>
                    <div class="flex items-center space-x-2">
                        <select id="multi-dimension-time-range" class="text-sm border border-gray-300 rounded px-2 py-1" onchange="updateMultiDimensionChart()">
                            <option value="1day">一日</option>
                            <option value="1week" selected>一星期</option>
                            <option value="1month">一個月</option>
                            <option value="1year">一年</option>
                        </select>
                        <button onclick="updateMultiDimensionChart()" class="text-primary text-sm hover:underline transition-all">
                            <i class="fa fa-refresh mr-1"></i> 更新
                        </button>
                    </div>
                </div>
                <div class="p-4">
                    <canvas id="multi-dimension-chart" height="400"></canvas>
                </div>
            </div>
            
            <!-- 智能设备数据录入 -->
            <div class="card mb-5">
                <div class="card-header">
                    <h3 class="text-title">智能设备数据录入</h3>
                    <p class="text-sm text-gray-600 mt-1">支持血压计、血氧计、温度计等设备数据</p>
                </div>
                
                <!-- 设备选择标签页 -->
                <div class="mb-4">
                    <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
                        <button id="tab-bp" onclick="switchDeviceTab('bp')" class="flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors bg-white text-blue-600 shadow-sm">
                            <i class="fa fa-heartbeat mr-2"></i>血压计
                        </button>
                        <button id="tab-spo2" onclick="switchDeviceTab('spo2')" class="flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-800">
                            <i class="fa fa-tint mr-2"></i>血氧计
                        </button>
                        <button id="tab-temp" onclick="switchDeviceTab('temp')" class="flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-800">
                            <i class="fa fa-thermometer-half mr-2"></i>温度计
                        </button>
                    </div>
                </div>

                <!-- 血压计数据录入 -->
                <div id="device-bp" class="device-form">
                    <div class="bg-green-50 border-l-4 border-green-400 p-3 rounded mb-4">
                        <p class="text-sm text-green-700">
                            <i class="fa fa-info-circle mr-1"></i>
                            填寫完血壓數據後，可以單獨保存或添加到批量保存
                        </p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fa fa-heart text-red-500 mr-1"></i>收缩压 (SYS)
                            </label>
                            <div class="relative">
                                <input type="number" id="bp-systolic" placeholder="120" class="input-field pr-8" min="60" max="250">
                                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">mmHg</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fa fa-heart text-blue-500 mr-1"></i>舒张压 (DIA)
                            </label>
                            <div class="relative">
                                <input type="number" id="bp-diastolic" placeholder="80" class="input-field pr-8" min="40" max="150">
                                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">mmHg</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fa fa-heartbeat text-green-500 mr-1"></i>脉搏 (PULSE)
                            </label>
                            <div class="relative">
                                <input type="number" id="bp-pulse" placeholder="72" class="input-field pr-8" min="30" max="200">
                                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">bpm</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg mb-4">
                        <div class="flex items-center">
                            <i class="fa fa-info-circle text-blue-500 mr-2"></i>
                            <span class="text-sm text-blue-700">血压评估：</span>
                            <span id="bp-assessment" class="text-sm font-medium text-blue-800 ml-2">请输入数据</span>
                        </div>
                    </div>
                    <button onclick="addToBatchSave('bp')" class="w-full py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition-colors mb-2">
                        <i class="fa fa-plus mr-2"></i> 添加到批量保存
                    </button>
                </div>

                <!-- 血氧计数据录入 -->
                <div id="device-spo2" class="device-form hidden">
                    <div class="bg-green-50 border-l-4 border-green-400 p-3 rounded mb-4">
                        <p class="text-sm text-green-700">
                            <i class="fa fa-info-circle mr-1"></i>
                            填寫完血氧數據後，請向下滾動查看保存按鈕
                        </p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fa fa-tint text-red-500 mr-1"></i>血氧饱和度 (%SpO2)
                            </label>
                            <div class="relative">
                                <input type="number" id="spo2-percent" placeholder="98" class="input-field pr-8" min="70" max="100" step="0.1">
                                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">%</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fa fa-signal text-orange-500 mr-1"></i>灌注指数 (PI%)
                            </label>
                            <div class="relative">
                                <input type="number" id="spo2-pi" placeholder="2.5" class="input-field pr-8" min="0.1" max="20" step="0.1">
                                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">%</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fa fa-heartbeat text-green-500 mr-1"></i>脉搏率 (PR)
                            </label>
                            <div class="relative">
                                <input type="number" id="spo2-pr" placeholder="72" class="input-field pr-8" min="30" max="200">
                                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">bpm</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg mb-4">
                        <div class="flex items-center">
                            <i class="fa fa-info-circle text-green-500 mr-2"></i>
                            <span class="text-sm text-green-700">血氧评估：</span>
                            <span id="spo2-assessment" class="text-sm font-medium text-green-800 ml-2">请输入数据</span>
                        </div>
                    </div>
                    <button onclick="addToBatchSave('spo2')" class="w-full py-2 bg-green-500 text-white rounded-lg text-sm font-medium hover:bg-green-600 transition-colors mb-2">
                        <i class="fa fa-plus mr-2"></i> 添加到批量保存
                    </button>
                </div>

                <!-- 温度计数据录入 -->
                <div id="device-temp" class="device-form hidden">
                    <div class="bg-green-50 border-l-4 border-green-400 p-3 rounded mb-4">
                        <p class="text-sm text-green-700">
                            <i class="fa fa-info-circle mr-1"></i>
                            填寫完體溫數據後，請向下滾動查看保存按鈕
                        </p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fa fa-thermometer-half text-red-500 mr-1"></i>体温
                            </label>
                            <div class="relative">
                                <input type="number" id="temp-value" placeholder="36.5" class="input-field pr-8" min="30" max="45" step="0.1">
                                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">°C</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fa fa-map-marker text-blue-500 mr-1"></i>测量部位
                            </label>
                            <select id="temp-location" class="input-field">
                                <option value="腋下">腋下</option>
                                <option value="口腔">口腔</option>
                                <option value="直肠">直肠</option>
                                <option value="耳温">耳温</option>
                                <option value="额温">额温</option>
                            </select>
                        </div>
                    </div>
                    <div class="bg-orange-50 p-3 rounded-lg mb-4">
                        <div class="flex items-center">
                            <i class="fa fa-info-circle text-orange-500 mr-2"></i>
                            <span class="text-sm text-orange-700">体温评估：</span>
                            <span id="temp-assessment" class="text-sm font-medium text-orange-800 ml-2">请输入数据</span>
                        </div>
                    </div>
                    <button onclick="addToBatchSave('temp')" class="w-full py-2 bg-orange-500 text-white rounded-lg text-sm font-medium hover:bg-orange-600 transition-colors mb-2">
                        <i class="fa fa-plus mr-2"></i> 添加到批量保存
                    </button>
                </div>

                <!-- 批量保存區域 -->
                <div id="batch-save-area" class="mb-4 hidden">
                    <div class="bg-purple-50 border-l-4 border-purple-400 p-4 rounded">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-semibold text-purple-800">批量保存列表</h4>
                                <p class="text-sm text-purple-700">已添加 <span id="batch-count">0</span> 項數據</p>
                            </div>
                            <div class="space-x-2">
                                <button onclick="clearBatchSave()" class="px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600">
                                    <i class="fa fa-trash mr-1"></i>清空
                                </button>
                                <button onclick="saveBatchData()" class="px-4 py-2 bg-purple-500 text-white rounded-lg font-medium hover:bg-purple-600">
                                    <i class="fa fa-save mr-2"></i>批量保存
                                </button>
                            </div>
                        </div>
                        <div id="batch-items" class="mt-3 space-y-2">
                            <!-- 批量保存項目將在這裡顯示 -->
                        </div>
                    </div>
                </div>

                <!-- 通用信息 -->
                <div class="space-y-4">
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fa fa-info-circle text-blue-400"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-blue-700">
                                    可以單獨保存或使用批量保存功能一次性保存多個設備數據
                                </p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-base mb-2">测量时间</label>
                        <input type="datetime-local" id="device-time" class="input-field">
                    </div>
                    <div>
                        <label class="block text-base mb-2">备注</label>
                        <textarea id="device-notes" placeholder="例如：餐后测量、运动后测量等" class="input-field" rows="3"></textarea>
                    </div>
                    <button onclick="handleAction('addDeviceData')" class="w-full py-4 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl text-lg font-bold hover:from-green-600 hover:to-green-700 transition-all duration-300 shadow-xl border-2 border-green-400 transform hover:scale-105">
                        <i class="fa fa-save mr-2 text-xl"></i> 💾 保存设备数据
                    </button>
                </div>
            </div>

            <!-- 传统数据录入 -->
            <div class="card mb-5">
                <div class="card-header">
                    <h3 class="text-title">手动数据录入</h3>
                    <p class="text-sm text-gray-600 mt-1">手动输入其他健康数据</p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-base mb-2">数据类型</label>
                        <select id="data-type" class="input-field">
                            <option value="">请选择数据类型</option>
                            <option value="血糖">血糖</option>
                            <option value="体重">体重</option>
                            <option value="身高">身高</option>
                            <option value="腰围">腰围</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-base mb-2">数值</label>
                        <input type="text" id="data-value" placeholder="例如：5.5" class="input-field">
                    </div>
                    <div>
                        <label class="block text-base mb-2">测量时间</label>
                        <input type="datetime-local" id="data-time" class="input-field">
                    </div>
                    <div>
                        <label class="block text-base mb-2">备注</label>
                        <textarea id="data-notes" placeholder="例如：空腹测量" class="input-field" rows="3"></textarea>
                    </div>
                    <button onclick="handleAction('addHealthRecord')" class="w-full py-3 bg-secondary text-white rounded-xl text-base font-semibold hover:bg-secondary/90 transition-colors">
                        <i class="fa fa-plus-circle mr-2"></i> 添加数据
                    </button>
                </div>
            </div>
            
            <!-- 健康数据历史 -->
            <div class="card mb-5">
                <div class="card-header">
                    <h3 class="text-title">健康数据历史</h3>
                </div>
                <div id="health-data-records" class="space-y-3">
                    <!-- 记录将动态生成 -->
                </div>
            </div>
            
            <!-- 智能设备数据统计 -->
            <div class="card mb-5">
                <div class="card-header">
                    <h3 class="text-title">智能设备数据统计</h3>
                    <button onclick="handleAction('refreshDeviceStats')" class="text-primary text-sm hover:underline transition-all">
                        <i class="fa fa-refresh mr-1"></i> 刷新
                    </button>
                </div>
                <div id="device-stats" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- 统计信息将动态生成 -->
                </div>
            </div>

            <!-- 专业健康报告 -->
            <div class="card mb-5 card-hover">
                <div class="card-header">
                    <h3 class="text-title">专业健康分析报告</h3>
                    <button onclick="handleAction('generateHealthReport')" class="text-primary text-base hover:underline transition-all">
                        <i class="fa fa-refresh mr-1"></i> 生成报告
                    </button>
                </div>
                <div id="health-report" class="text-base space-y-2 empty-state">
                    <i class="fa fa-file-text-o text-4xl mb-2"></i>
                    <p class="text-base">暂无健康报告</p>
                    <p class="text-small mt-1">点击"生成报告"按钮获取AI分析</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 专业健康评估模型
        class HealthAssessmentModel {
            constructor() {
                this.modelVersion = "DeepSeek-Health-v2.1";
                this.lastUpdated = "2025-09-28";
                this.algorithmTransparency = {
                    riskFactors: {
                        cardiovascular: ["age", "bloodPressure", "cholesterol", "diabetes", "smoking", "familyHistory"],
                        metabolic: ["bmi", "waistCircumference", "bloodGlucose", "insulinResistance"],
                        cognitive: ["age", "education", "socialEngagement", "physicalActivity", "dietQuality"]
                    },
                    weightFactors: {
                        age: 0.15,
                        bloodPressure: 0.20,
                        cholesterol: 0.18,
                        diabetes: 0.22,
                        lifestyle: 0.25
                    },
                    confidenceLevel: 0.85
                };
            }

            // 心血管风险评估
            calculateCardiovascularRisk(patientData) {
                const factors = this.algorithmTransparency.riskFactors.cardiovascular;
                let riskScore = 0;
                let explanations = [];

                factors.forEach(factor => {
                    const weight = this.algorithmTransparency.weightFactors[factor] || 0.1;
                    const value = patientData[factor];
                    
                    if (factor === 'age') {
                        if (value > 65) riskScore += weight * 0.8;
                        else if (value > 50) riskScore += weight * 0.5;
                        explanations.push(`年龄${value}岁: ${value > 65 ? '高风险' : value > 50 ? '中风险' : '低风险'}`);
                    }
                    
                    if (factor === 'bloodPressure') {
                        if (value.systolic > 140 || value.diastolic > 90) riskScore += weight * 0.9;
                        else if (value.systolic > 130 || value.diastolic > 85) riskScore += weight * 0.6;
                        explanations.push(`血压${value.systolic}/${value.diastolic}: ${value.systolic > 140 ? '高血压' : '正常'}`);
                    }
                });

                return {
                    riskScore: Math.min(riskScore, 1.0),
                    riskLevel: riskScore > 0.7 ? '高风险' : riskScore > 0.4 ? '中风险' : '低风险',
                    confidence: this.algorithmTransparency.confidenceLevel,
                    explanations: explanations,
                    recommendations: this.generateRecommendations(riskScore, 'cardiovascular')
                };
            }

            // 代谢健康评估
            calculateMetabolicHealth(patientData) {
                const factors = this.algorithmTransparency.riskFactors.metabolic;
                let healthScore = 0;
                let explanations = [];

                factors.forEach(factor => {
                    const value = patientData[factor];
                    
                    if (factor === 'bmi') {
                        if (value > 30) healthScore += 0.3;
                        else if (value > 25) healthScore += 0.15;
                        explanations.push(`BMI ${value}: ${value > 30 ? '肥胖' : value > 25 ? '超重' : '正常'}`);
                    }
                    
                    if (factor === 'bloodGlucose') {
                        if (value > 126) healthScore += 0.4;
                        else if (value > 100) healthScore += 0.2;
                        explanations.push(`血糖${value}mg/dL: ${value > 126 ? '糖尿病' : value > 100 ? '糖尿病前期' : '正常'}`);
                    }
                });

                return {
                    healthScore: Math.min(healthScore, 1.0),
                    healthLevel: healthScore > 0.6 ? '需要关注' : healthScore > 0.3 ? '良好' : '优秀',
                    confidence: this.algorithmTransparency.confidenceLevel,
                    explanations: explanations,
                    recommendations: this.generateRecommendations(healthScore, 'metabolic')
                };
            }

            // 生成个性化建议
            generateRecommendations(score, type) {
                const recommendations = [];
                
                if (type === 'cardiovascular') {
                    if (score > 0.7) {
                        recommendations.push('建议立即咨询心血管专科医生');
                        recommendations.push('开始低钠饮食，每日钠摄入<2g');
                        recommendations.push('每周至少150分钟中等强度运动');
                    } else if (score > 0.4) {
                        recommendations.push('定期监测血压和血脂');
                        recommendations.push('保持健康饮食和规律运动');
                    } else {
                        recommendations.push('继续保持健康生活方式');
                    }
                }
                
                if (type === 'metabolic') {
                    if (score > 0.6) {
                        recommendations.push('建议内分泌科就诊评估');
                        recommendations.push('控制碳水化合物摄入，选择低GI食物');
                        recommendations.push('增加有氧运动和力量训练');
                    } else if (score > 0.3) {
                        recommendations.push('定期监测血糖和体重');
                        recommendations.push('保持均衡饮食和规律运动');
                    } else {
                        recommendations.push('继续保持良好的代谢健康');
                    }
                }
                
                return recommendations;
            }

            // 获取算法透明度信息
            getAlgorithmTransparency() {
                return {
                    modelName: this.modelVersion,
                    lastUpdated: this.lastUpdated,
                    riskFactors: this.algorithmTransparency.riskFactors,
                    weightFactors: this.algorithmTransparency.weightFactors,
                    confidenceLevel: this.algorithmTransparency.confidenceLevel,
                    dataSources: [
                        'WHO健康指标数据库',
                        '美国心脏协会指南',
                        '中国心血管病预防指南',
                        'DeepSeek医学知识库'
                    ],
                    validationStudies: [
                        'Framingham心脏研究',
                        '中国心血管病流行病学研究',
                        'DeepSeek模型验证研究'
                    ]
                };
            }
        }

        // 专业数据可视化系统
        class ProfessionalVisualization {
            constructor() {
                this.chartConfigs = {
                    medical: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                borderColor: 'rgba(255,255,255,0.2)',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: 'rgba(0,0,0,0.1)' },
                                ticks: { font: { size: 11 } }
                            },
                            y: {
                                grid: { color: 'rgba(0,0,0,0.1)' },
                                ticks: { font: { size: 11 } }
                            }
                        }
                    }
                };
            }

            // 创建趋势分析图表
            createTrendChart(canvasId, data, title) {
                const ctx = document.getElementById(canvasId);
                if (!ctx) return;

                // 銷毀現有圖表
                if (this.chartInstances && this.chartInstances[canvasId]) {
                    this.chartInstances[canvasId].destroy();
                }

                // 初始化圖表實例存儲
                if (!this.chartInstances) {
                    this.chartInstances = {};
                }

                this.chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: title,
                            data: data.values,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgb(59, 130, 246)',
                            pointBorderColor: 'white',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        ...this.chartConfigs.medical,
                        plugins: {
                            ...this.chartConfigs.medical.plugins,
                            title: {
                                display: true,
                                text: title,
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    }
                });
            }

            // 创建相关性分析图表
            createCorrelationChart(canvasId, data) {
                const ctx = document.getElementById(canvasId);
                if (!ctx) return;

                // 銷毀現有圖表
                if (this.chartInstances && this.chartInstances[canvasId]) {
                    this.chartInstances[canvasId].destroy();
                }

                // 初始化圖表實例存儲
                if (!this.chartInstances) {
                    this.chartInstances = {};
                }

                this.chartInstances[canvasId] = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: '健康指标相关性',
                            data: data.points,
                            backgroundColor: 'rgba(16, 185, 129, 0.6)',
                            borderColor: 'rgb(16, 185, 129)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        ...this.chartConfigs.medical,
                        plugins: {
                            ...this.chartConfigs.medical.plugins,
                            title: {
                                display: true,
                                text: '健康指标相关性分析',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        scales: {
                            x: {
                                ...this.chartConfigs.medical.scales.x,
                                title: {
                                    display: true,
                                    text: data.xLabel || '指标A'
                                }
                            },
                            y: {
                                ...this.chartConfigs.medical.scales.y,
                                title: {
                                    display: true,
                                    text: data.yLabel || '指标B'
                                }
                            }
                        }
                    }
                });
            }

            // 创建多维度对比图表
            createMultiDimensionChart(canvasId, data) {
                const ctx = document.getElementById(canvasId);
                if (!ctx) return;

                // 銷毀現有圖表
                if (this.chartInstances && this.chartInstances[canvasId]) {
                    this.chartInstances[canvasId].destroy();
                }

                // 初始化圖表實例存儲
                if (!this.chartInstances) {
                    this.chartInstances = {};
                }

                this.chartInstances[canvasId] = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: data.labels,
                        datasets: data.datasets.map((dataset, index) => ({
                            ...dataset,
                            borderColor: this.getColor(index),
                            backgroundColor: this.getColor(index, 0.2),
                            borderWidth: 2,
                            pointBackgroundColor: this.getColor(index),
                            pointBorderColor: 'white',
                            pointBorderWidth: 2
                        }))
                    },
                    options: {
                        ...this.chartConfigs.medical,
                        plugins: {
                            ...this.chartConfigs.medical.plugins,
                            title: {
                                display: true,
                                text: '多维度健康指标对比',
                                font: { size: 14, weight: 'bold' }
                            }
                        },
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    stepSize: 20,
                                    font: { size: 11 }
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            }
                        }
                    }
                });
            }

            getColor(index, alpha = 1) {
                const colors = [
                    `rgba(59, 130, 246, ${alpha})`,
                    `rgba(16, 185, 129, ${alpha})`,
                    `rgba(245, 158, 11, ${alpha})`,
                    `rgba(239, 68, 68, ${alpha})`,
                    `rgba(139, 92, 246, ${alpha})`
                ];
                return colors[index % colors.length];
            }
        }

        // 个性化健康建议系统
        class PersonalizedHealthSystem {
            constructor() {
                this.userProfile = {
                    age: null,
                    gender: null,
                    medicalHistory: [],
                    lifestyle: {},
                    preferences: {}
                };
                this.adaptiveReminders = [];
                this.habitFormation = new HabitFormationSystem();
            }

            // 更新用户画像
            updateUserProfile(profileData) {
                this.userProfile = { ...this.userProfile, ...profileData };
                this.generatePersonalizedRecommendations();
            }

            // 生成个性化健康建议
            generatePersonalizedRecommendations() {
                const recommendations = [];
                
                // 基于年龄的建议
                if (this.userProfile.age > 65) {
                    recommendations.push({
                        type: 'preventive',
                        priority: 'high',
                        title: '老年健康管理',
                        content: '建议定期进行认知功能评估和跌倒风险评估',
                        frequency: 'monthly'
                    });
                }

                // 基于医疗史的建议
                if (this.userProfile.medicalHistory.includes('diabetes')) {
                    recommendations.push({
                        type: 'management',
                        priority: 'high',
                        title: '糖尿病管理',
                        content: '建议每日监测血糖，保持HbA1c<7%',
                        frequency: 'daily'
                    });
                }

                // 基于生活方式的建议
                if (this.userProfile.lifestyle.exercise < 150) {
                    recommendations.push({
                        type: 'lifestyle',
                        priority: 'medium',
                        title: '运动建议',
                        content: '建议每周至少150分钟中等强度运动',
                        frequency: 'weekly'
                    });
                }

                return recommendations;
            }

            // 自适应提醒系统
            createAdaptiveReminder(type, content, initialTime) {
                const reminder = {
                    id: Date.now(),
                    type: type,
                    content: content,
                    time: initialTime,
                    frequency: 'daily',
                    adaptation: {
                        successRate: 0,
                        adjustments: 0,
                        lastAdjustment: null
                    }
                };

                this.adaptiveReminders.push(reminder);
                return reminder;
            }

            // 调整提醒时间
            adjustReminderTime(reminderId, success) {
                const reminder = this.adaptiveReminders.find(r => r.id === reminderId);
                if (!reminder) return;

                // 更新成功率
                reminder.adaptation.successRate = 
                    (reminder.adaptation.successRate * 0.9) + (success ? 0.1 : 0);

                // 如果成功率低，调整时间
                if (reminder.adaptation.successRate < 0.3) {
                    const currentTime = new Date(reminder.time);
                    currentTime.setMinutes(currentTime.getMinutes() + 30);
                    reminder.time = currentTime.toISOString();
                    reminder.adaptation.adjustments++;
                    reminder.adaptation.lastAdjustment = new Date();
                }
            }
        }

        // 习惯养成系统
        class HabitFormationSystem {
            constructor() {
                this.habits = [];
                this.streakTracking = {};
            }

            // 创建新习惯
            createHabit(name, target, frequency) {
                const habit = {
                    id: Date.now(),
                    name: name,
                    target: target,
                    frequency: frequency,
                    startDate: new Date(),
                    streak: 0,
                    totalDays: 0,
                    completionRate: 0
                };

                this.habits.push(habit);
                this.streakTracking[habit.id] = 0;
                return habit;
            }

            // 记录习惯完成
            recordHabitCompletion(habitId, completed) {
                const habit = this.habits.find(h => h.id === habitId);
                if (!habit) return;

                habit.totalDays++;
                if (completed) {
                    habit.streak++;
                    this.streakTracking[habitId]++;
                } else {
                    habit.streak = 0;
                    this.streakTracking[habitId] = 0;
                }

                habit.completionRate = (habit.totalDays - habit.streak) / habit.totalDays;
            }

            // 获取习惯建议
            getHabitSuggestions() {
                return [
                    {
                        name: '每日步行',
                        target: '8000步',
                        frequency: 'daily',
                        benefits: ['改善心血管健康', '增强骨骼强度', '提升心情']
                    },
                    {
                        name: '充足睡眠',
                        target: '7-8小时',
                        frequency: 'daily',
                        benefits: ['增强免疫力', '改善记忆', '调节情绪']
                    },
                    {
                        name: '健康饮食',
                        target: '5份蔬果',
                        frequency: 'daily',
                        benefits: ['降低慢性病风险', '提供必需营养', '维持健康体重']
                    }
                ];
            }
        }

        // 医疗级数据安全系统
        class MedicalDataSecurity {
            constructor() {
                this.securityLevel = 'medical-grade';
                this.encryption = {
                    algorithm: 'AES-256-GCM',
                    keyRotation: 'monthly',
                    dataAtRest: true,
                    dataInTransit: true
                };
                this.auditLog = [];
                this.dataRetention = {
                    healthRecords: '7年',
                    personalData: '3年',
                    auditLogs: '10年'
                };
            }

            // 记录数据访问
            logDataAccess(userId, dataType, action) {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    userId: userId,
                    dataType: dataType,
                    action: action,
                    ipAddress: 'masked',
                    userAgent: 'masked'
                };

                this.auditLog.push(logEntry);
                return logEntry;
            }

            // 数据脱敏
            anonymizeData(data) {
                const anonymized = { ...data };
                
                // 移除或脱敏敏感信息
                if (anonymized.personalInfo) {
                    anonymized.personalInfo.name = '***';
                    anonymized.personalInfo.idNumber = '***';
                    anonymized.personalInfo.phone = '***';
                }

                return anonymized;
            }

            // 获取安全合规报告
            getSecurityComplianceReport() {
                return {
                    securityLevel: this.securityLevel,
                    encryption: this.encryption,
                    dataRetention: this.dataRetention,
                    auditLogCount: this.auditLog.length,
                    lastSecurityAudit: '2025-09-28',
                    complianceStandards: [
                        'HIPAA (美国健康保险可携性和责任法案)',
                        'GDPR (通用数据保护条例)',
                        '中国网络安全法',
                        '医疗数据安全标准'
                    ]
                };
            }
        }

        // DeepSeek API 配置
        const DEEPSEEK_API_KEY = 'sk-ef5d339bf70b4f4d8e0657db5ba02d22';
        const DEEPSEEK_API_URL = 'https://api.deepseek.com/v1/chat/completions';

        // 初始化专业系统
        const healthAssessment = new HealthAssessmentModel();
        // 科學健康評估系統
        const scientificAssessment = new ScientificHealthAssessment();
        // 暫時註釋專業模塊，避免按鈕失效
        // const professionalAssessment = new ProfessionalHealthAssessment();
        // const professionalViz = new ProfessionalVisualization();
        const personalizedHealth = new PersonalizedHealthSystem();
        const dataSecurity = new MedicalDataSecurity();

        // 交互反馈系统
        class FeedbackSystem {
            static showSuccess(message = '操作成功') {
                const toast = document.getElementById('toast');
                const text = document.getElementById('toast-text');
                text.textContent = message;
                toast.classList.remove('hidden');
                toast.classList.add('animate-spring-in');
                
                setTimeout(() => {
                    toast.classList.add('animate-spring-out');
                    setTimeout(() => {
                        toast.classList.add('hidden');
                        toast.classList.remove('animate-spring-in', 'animate-spring-out');
                    }, 400);
                }, 2000);
            }
            
            static showError(message = '操作失败') {
                const errorToast = document.getElementById('error-toast');
                const text = document.getElementById('error-text');
                text.textContent = message;
                errorToast.classList.remove('hidden');
                errorToast.classList.add('animate-spring-in');
                
                setTimeout(() => {
                    errorToast.classList.add('animate-spring-out');
                    setTimeout(() => {
                        errorToast.classList.add('hidden');
                        errorToast.classList.remove('animate-spring-in', 'animate-spring-out');
                    }, 400);
                }, 3000);
            }
            
            static showLoading(message = '处理中...') {
                const loadingToast = document.getElementById('loading-toast');
                const text = document.getElementById('loading-text');
                text.textContent = message;
                loadingToast.classList.remove('hidden');
                loadingToast.classList.add('animate-spring-in');
                return loadingToast;
            }
            
            static hideLoading() {
                const loadingToast = document.getElementById('loading-toast');
                loadingToast.classList.add('animate-spring-out');
                setTimeout(() => {
                    loadingToast.classList.add('hidden');
                    loadingToast.classList.remove('animate-spring-in', 'animate-spring-out');
                }, 400);
            }
        }

        // 涟漪效果
        function createRipple(event) {
            const button = event.currentTarget;
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;
            
            const ripple = document.createElement('span');
            ripple.style.cssText = `
                position: absolute;
                width: ${size}px;
                height: ${size}px;
                left: ${x}px;
                top: ${y}px;
                background: rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                transform: scale(0);
                animation: ripple 0.6s linear;
                pointer-events: none;
            `;
            
            button.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        }

        // 按钮加载状态
        function setButtonLoading(button, loading = true) {
            if (loading) {
                button.classList.add('loading');
                button.disabled = true;
            } else {
                button.classList.remove('loading');
                button.disabled = false;
            }
        }

        // 页面切换功能
        function showPage(pageId) {
            console.log('切换到页面:', pageId);
            
            // 显示加载状态
            const loadingToast = FeedbackSystem.showLoading('切换页面中...');
            
            // 隐藏所有页面
            const pages = document.querySelectorAll('[id^="page-"]');
            pages.forEach(page => {
                page.classList.add('hidden');
                page.style.display = 'none';
                page.classList.remove('page-enter');
            });
            
            // 显示目标页面
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                setTimeout(() => {
                    targetPage.classList.remove('hidden');
                    targetPage.style.display = 'block';
                    targetPage.classList.add('page-enter');
                    
                    // 滚动到页面顶部
                    targetPage.scrollTop = 0;
                    window.scrollTo(0, 0);
                    
                    // 隐藏加载状态
                    FeedbackSystem.hideLoading();
                    FeedbackSystem.showSuccess('页面切换成功');
                    
                    console.log('页面显示成功:', pageId);
                }, 300);
            } else {
                FeedbackSystem.hideLoading();
                FeedbackSystem.showError('页面未找到');
                console.error('页面未找到:', pageId);
            }
        }

        // 通用模态框显示函数
        function showModal(title, content) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h2 class="text-xl font-semibold">${title}</h2>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fa fa-times text-xl"></i>
                        </button>
                    </div>
                    <div class="p-0">
                        ${content}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // 帮助中心功能
        function showHelpCenter() {
            const helpContent = `
                <div class="max-w-4xl mx-auto p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">帮助中心</h2>
                    
                    <div class="space-y-6">
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">常见问题</h3>
                            <div class="space-y-4">
                                <div>
                                    <h4 class="font-medium text-gray-700 mb-2">如何录入健康数据？</h4>
                                    <p class="text-sm text-gray-600">点击"智能设备数据录入"按钮，选择相应的健康指标进行录入。</p>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-700 mb-2">如何生成健康报告？</h4>
                                    <p class="text-sm text-gray-600">填写基本信息后，点击"生成健康报告"即可获得AI分析报告。</p>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-700 mb-2">数据安全吗？</h4>
                                    <p class="text-sm text-gray-600">所有数据都经过加密处理，符合医疗级安全标准。</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">使用指南</h3>
                            <div class="space-y-3">
                                <div class="flex items-start">
                                    <span class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-medium mr-3 mt-0.5">1</span>
                                    <div>
                                        <h4 class="font-medium text-gray-700">填写基本信息</h4>
                                        <p class="text-sm text-gray-600">输入年龄、性别、身高、体重等基本信息</p>
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <span class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-medium mr-3 mt-0.5">2</span>
                                    <div>
                                        <h4 class="font-medium text-gray-700">录入健康数据</h4>
                                        <p class="text-sm text-gray-600">使用智能设备数据录入功能记录各项健康指标</p>
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <span class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-medium mr-3 mt-0.5">3</span>
                                    <div>
                                        <h4 class="font-medium text-gray-700">生成健康报告</h4>
                                        <p class="text-sm text-gray-600">点击生成报告，获得AI智能分析结果</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            showModal('帮助中心', helpContent);
        }

        // 联系我们功能
        function showContactUs() {
            const contactContent = `
                <div class="max-w-4xl mx-auto p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">联系我们</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">联系方式</h3>
                            <div class="space-y-3">
                                <div class="flex items-center">
                                    <i class="fa fa-envelope text-blue-500 mr-3"></i>
                                    <span class="text-gray-700">邮箱: 20231079@tcss.edu.hk</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fa fa-clock-o text-blue-500 mr-3"></i>
                                    <span class="text-gray-700">服务时间: 24小时</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">在线客服</h3>
                            <div class="space-y-3">
                                <div class="flex items-center">
                                    <i class="fa fa-wechat text-green-500 mr-3"></i>
                                    <span class="text-gray-700">微信: mankwunsing</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fa fa-qq text-blue-500 mr-3"></i>
                                    <span class="text-gray-700">QQ: 3600452098</span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fa fa-comments text-purple-500 mr-3"></i>
                                    <span class="text-gray-700">在线聊天: 24小时服务</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 rounded-lg p-6 mt-6">
                        <h3 class="text-lg font-semibold text-blue-800 mb-3">意见反馈</h3>
                        <p class="text-blue-700 text-sm mb-4">我们重视您的每一个建议，请通过以下方式联系我们：</p>
                        <div class="flex space-x-4">
                            <button onclick="showFeedbackForm()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm cursor-pointer">
                                提交反馈
                            </button>
                            <button onclick="showFeatureSuggestionForm()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm cursor-pointer">
                                建议功能
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            showModal('联系我们', contactContent);
        }

        // 提交反馈功能
        function showFeedbackForm() {
            const feedbackContent = `
                <div class="max-w-2xl mx-auto p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">提交反馈</h2>
                    
                    <form id="feedbackForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">反馈类型</label>
                            <select id="feedbackType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="">请选择反馈类型</option>
                                <option value="bug">Bug报告</option>
                                <option value="improvement">功能改进</option>
                                <option value="usability">使用体验</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">问题描述</label>
                            <textarea id="feedbackDescription" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="请详细描述您遇到的问题或建议..." required></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">联系方式（可选）</label>
                            <input type="email" id="feedbackContact" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="您的邮箱地址，方便我们回复">
                        </div>
                        
                        <div class="flex space-x-4">
                            <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md transition-colors">
                                提交反馈
                            </button>
                            <button type="button" onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md transition-colors">
                                取消
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            showModal('提交反馈', feedbackContent);
            
            // 添加表单提交处理
            setTimeout(() => {
                const form = document.getElementById('feedbackForm');
                if (form) {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        handleFeedbackSubmission();
                    });
                }
            }, 100);
        }

        // 建议功能功能
        function showFeatureSuggestionForm() {
            const suggestionContent = `
                <div class="max-w-2xl mx-auto p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">建议功能</h2>
                    
                    <form id="suggestionForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">功能类别</label>
                            <select id="suggestionCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>
                                <option value="">请选择功能类别</option>
                                <option value="health">健康管理</option>
                                <option value="ui">界面优化</option>
                                <option value="ai">AI功能</option>
                                <option value="data">数据处理</option>
                                <option value="notification">提醒功能</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">功能建议</label>
                            <textarea id="suggestionDescription" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="请详细描述您希望添加的功能..." required></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">使用场景</label>
                            <textarea id="suggestionScenario" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="请描述这个功能的使用场景和预期效果..."></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">优先级</label>
                            <select id="suggestionPriority" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="low">低</option>
                                <option value="medium" selected>中</option>
                                <option value="high">高</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">联系方式（可选）</label>
                            <input type="email" id="suggestionContact" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="您的邮箱地址，方便我们回复">
                        </div>
                        
                        <div class="flex space-x-4">
                            <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-md transition-colors">
                                提交建议
                            </button>
                            <button type="button" onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md transition-colors">
                                取消
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            showModal('建议功能', suggestionContent);
            
            // 添加表单提交处理
            setTimeout(() => {
                const form = document.getElementById('suggestionForm');
                if (form) {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        handleSuggestionSubmission();
                    });
                }
            }, 100);
        }

        // 处理反馈提交
        function handleFeedbackSubmission() {
            const type = document.getElementById('feedbackType').value;
            const description = document.getElementById('feedbackDescription').value;
            const contact = document.getElementById('feedbackContact').value;
            
            if (!type || !description) {
                alert('请填写必填字段');
                return;
            }
            
            // 模拟提交过程
            const submitBtn = document.querySelector('#feedbackForm button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '提交中...';
            submitBtn.disabled = true;
            
            setTimeout(() => {
                // 保存反馈到本地存储
                const feedback = {
                    id: Date.now(),
                    type: 'feedback',
                    feedbackType: type,
                    description: description,
                    contact: contact,
                    timestamp: new Date().toISOString(),
                    status: 'new'
                };
                
                saveFeedbackToStorage(feedback);
                
                // 发送邮件通知开发者
                sendEmailNotification(feedback);
                
                console.log('反馈提交:', feedback);
                
                // 显示成功消息
                alert('反馈提交成功！感谢您的宝贵意见，我们会认真考虑您的建议。');
                
                // 关闭模态框
                document.querySelector('.fixed').remove();
            }, 1500);
        }

        // 处理建议提交
        function handleSuggestionSubmission() {
            const category = document.getElementById('suggestionCategory').value;
            const description = document.getElementById('suggestionDescription').value;
            const scenario = document.getElementById('suggestionScenario').value;
            const priority = document.getElementById('suggestionPriority').value;
            const contact = document.getElementById('suggestionContact').value;
            
            if (!category || !description) {
                alert('请填写必填字段');
                return;
            }
            
            // 模拟提交过程
            const submitBtn = document.querySelector('#suggestionForm button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = '提交中...';
            submitBtn.disabled = true;
            
            setTimeout(() => {
                // 保存建议到本地存储
                const suggestion = {
                    id: Date.now(),
                    type: 'suggestion',
                    category: category,
                    description: description,
                    scenario: scenario,
                    priority: priority,
                    contact: contact,
                    timestamp: new Date().toISOString(),
                    status: 'new'
                };
                
                saveFeedbackToStorage(suggestion);
                
                // 发送邮件通知开发者
                sendEmailNotification(suggestion);
                
                console.log('功能建议提交:', suggestion);
                
                // 显示成功消息
                alert('功能建议提交成功！我们会评估您的建议，并在后续版本中考虑实现。');
                
                // 关闭模态框
                document.querySelector('.fixed').remove();
            }, 1500);
        }

        // 保存反馈到本地存储
        function saveFeedbackToStorage(feedback) {
            try {
                let feedbacks = JSON.parse(localStorage.getItem('userFeedbacks') || '[]');
                feedbacks.push(feedback);
                localStorage.setItem('userFeedbacks', JSON.stringify(feedbacks));
                console.log('反馈已保存到本地存储:', feedback);
            } catch (error) {
                console.error('保存反馈失败:', error);
            }
        }

        // 发送邮件通知开发者
        function sendEmailNotification(feedback) {
            try {
                const developerEmail = '20231079@tcss.edu.hk';
                const subject = feedback.type === 'feedback' ? '新用户反馈' : '新功能建议';
                const body = generateEmailBody(feedback);
                
                // 创建邮件链接
                const mailtoLink = `mailto:${developerEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                // 尝试打开邮件客户端
                window.open(mailtoLink, '_blank');
                
                console.log('邮件通知已发送:', { developerEmail, subject, body });
            } catch (error) {
                console.error('发送邮件通知失败:', error);
            }
        }

        // 生成邮件内容
        function generateEmailBody(feedback) {
            const timestamp = new Date(feedback.timestamp).toLocaleString('zh-CN');
            
            if (feedback.type === 'feedback') {
                return `
新用户反馈 - ${timestamp}

反馈类型: ${getFeedbackTypeText(feedback.feedbackType)}
问题描述: ${feedback.description}
联系方式: ${feedback.contact || '未提供'}

请及时查看并处理此反馈。

---
银龄康伴 AI 系统自动通知
                `.trim();
            } else {
                return `
新功能建议 - ${timestamp}

功能类别: ${getSuggestionCategoryText(feedback.category)}
功能建议: ${feedback.description}
使用场景: ${feedback.scenario || '未提供'}
优先级: ${getPriorityText(feedback.priority)}
联系方式: ${feedback.contact || '未提供'}

请评估此建议并考虑在后续版本中实现。

---
银龄康伴 AI 系统自动通知
                `.trim();
            }
        }

        // 获取反馈类型文本
        function getFeedbackTypeText(type) {
            const types = {
                'bug': 'Bug报告',
                'improvement': '功能改进',
                'usability': '使用体验',
                'other': '其他'
            };
            return types[type] || type;
        }

        // 获取建议类别文本
        function getSuggestionCategoryText(category) {
            const categories = {
                'health': '健康管理',
                'ui': '界面优化',
                'ai': 'AI功能',
                'data': '数据处理',
                'notification': '提醒功能',
                'other': '其他'
            };
            return categories[category] || category;
        }

        // 获取优先级文本
        function getPriorityText(priority) {
            const priorities = {
                'low': '低',
                'medium': '中',
                'high': '高'
            };
            return priorities[priority] || priority;
        }

        // 开发者后台 - 查看所有反馈和建议
        function showDeveloperDashboard() {
            const feedbacks = JSON.parse(localStorage.getItem('userFeedbacks') || '[]');
            
            const dashboardContent = `
                <div class="max-w-6xl mx-auto p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">开发者后台 - 用户反馈管理</h2>
                        <div class="flex space-x-2">
                            <button onclick="exportFeedbacks()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">
                                导出数据
                            </button>
                            <button onclick="clearAllFeedbacks()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm">
                                清空数据
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="font-medium text-blue-800">总反馈数</h3>
                            <p class="text-2xl font-bold text-blue-600">${feedbacks.length}</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h3 class="font-medium text-green-800">新反馈</h3>
                            <p class="text-2xl font-bold text-green-600">${feedbacks.filter(f => f.status === 'new').length}</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h3 class="font-medium text-purple-800">功能建议</h3>
                            <p class="text-2xl font-bold text-purple-600">${feedbacks.filter(f => f.type === 'suggestion').length}</p>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md">
                        <div class="p-4 border-b">
                            <h3 class="text-lg font-semibold">反馈列表</h3>
                        </div>
                        <div class="max-h-96 overflow-y-auto">
                            ${feedbacks.length === 0 ? 
                                '<div class="p-8 text-center text-gray-500">暂无反馈数据</div>' :
                                feedbacks.map(feedback => `
                                    <div class="p-4 border-b hover:bg-gray-50">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <div class="flex items-center space-x-2 mb-2">
                                                    <span class="px-2 py-1 text-xs rounded ${feedback.type === 'feedback' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                                                        ${feedback.type === 'feedback' ? '反馈' : '建议'}
                                                    </span>
                                                    <span class="px-2 py-1 text-xs rounded ${feedback.status === 'new' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}">
                                                        ${feedback.status === 'new' ? '新' : '已处理'}
                                                    </span>
                                                    ${feedback.type === 'suggestion' ? `<span class="px-2 py-1 text-xs rounded ${feedback.priority === 'high' ? 'bg-red-100 text-red-800' : feedback.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}">${getPriorityText(feedback.priority)}</span>` : ''}
                                                </div>
                                                <h4 class="font-medium text-gray-800 mb-1">
                                                    ${feedback.type === 'feedback' ? getFeedbackTypeText(feedback.feedbackType) : getSuggestionCategoryText(feedback.category)}
                                                </h4>
                                                <p class="text-sm text-gray-600 mb-2">${feedback.description.substring(0, 100)}${feedback.description.length > 100 ? '...' : ''}</p>
                                                <div class="text-xs text-gray-500">
                                                    ${new Date(feedback.timestamp).toLocaleString('zh-CN')}
                                                    ${feedback.contact ? ` | 联系: ${feedback.contact}` : ''}
                                                </div>
                                            </div>
                                            <div class="flex space-x-2 ml-4">
                                                <button onclick="viewFeedbackDetail(${feedback.id})" class="text-blue-600 hover:text-blue-800 text-sm">
                                                    查看详情
                                                </button>
                                                <button onclick="markAsProcessed(${feedback.id})" class="text-green-600 hover:text-green-800 text-sm">
                                                    标记已处理
                                                </button>
                                                <button onclick="deleteFeedback(${feedback.id})" class="text-red-600 hover:text-red-800 text-sm">
                                                    删除
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
            `;
            
            showModal('开发者后台', dashboardContent);
        }

        // 查看反馈详情
        function viewFeedbackDetail(feedbackId) {
            const feedbacks = JSON.parse(localStorage.getItem('userFeedbacks') || '[]');
            const feedback = feedbacks.find(f => f.id === feedbackId);
            
            if (!feedback) return;
            
            const detailContent = `
                <div class="max-w-2xl mx-auto p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">反馈详情</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">类型</label>
                            <p class="text-gray-900">${feedback.type === 'feedback' ? '用户反馈' : '功能建议'}</p>
                        </div>
                        
                        ${feedback.type === 'feedback' ? `
                            <div>
                                <label class="block text-sm font-medium text-gray-700">反馈类型</label>
                                <p class="text-gray-900">${getFeedbackTypeText(feedback.feedbackType)}</p>
                            </div>
                        ` : `
                            <div>
                                <label class="block text-sm font-medium text-gray-700">功能类别</label>
                                <p class="text-gray-900">${getSuggestionCategoryText(feedback.category)}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">优先级</label>
                                <p class="text-gray-900">${getPriorityText(feedback.priority)}</p>
                            </div>
                            ${feedback.scenario ? `
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">使用场景</label>
                                    <p class="text-gray-900">${feedback.scenario}</p>
                                </div>
                            ` : ''}
                        `}
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">${feedback.type === 'feedback' ? '问题描述' : '功能建议'}</label>
                            <p class="text-gray-900 whitespace-pre-wrap">${feedback.description}</p>
                        </div>
                        
                        ${feedback.contact ? `
                            <div>
                                <label class="block text-sm font-medium text-gray-700">联系方式</label>
                                <p class="text-gray-900">${feedback.contact}</p>
                            </div>
                        ` : ''}
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">提交时间</label>
                            <p class="text-gray-900">${new Date(feedback.timestamp).toLocaleString('zh-CN')}</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">状态</label>
                            <p class="text-gray-900">${feedback.status === 'new' ? '新反馈' : '已处理'}</p>
                        </div>
                    </div>
                    
                    <div class="flex space-x-4 mt-6">
                        <button onclick="markAsProcessed(${feedback.id}); this.closest('.fixed').remove(); showDeveloperDashboard();" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                            标记已处理
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                            关闭
                        </button>
                    </div>
                </div>
            `;
            
            showModal('反馈详情', detailContent);
        }

        // 标记为已处理
        function markAsProcessed(feedbackId) {
            const feedbacks = JSON.parse(localStorage.getItem('userFeedbacks') || '[]');
            const feedback = feedbacks.find(f => f.id === feedbackId);
            if (feedback) {
                feedback.status = 'processed';
                localStorage.setItem('userFeedbacks', JSON.stringify(feedbacks));
                console.log('反馈已标记为已处理:', feedbackId);
            }
        }

        // 删除反馈
        function deleteFeedback(feedbackId) {
            if (confirm('确定要删除这个反馈吗？')) {
                const feedbacks = JSON.parse(localStorage.getItem('userFeedbacks') || '[]');
                const filteredFeedbacks = feedbacks.filter(f => f.id !== feedbackId);
                localStorage.setItem('userFeedbacks', JSON.stringify(filteredFeedbacks));
                console.log('反馈已删除:', feedbackId);
                showDeveloperDashboard(); // 刷新列表
            }
        }

        // 导出反馈数据
        function exportFeedbacks() {
            const feedbacks = JSON.parse(localStorage.getItem('userFeedbacks') || '[]');
            const dataStr = JSON.stringify(feedbacks, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `feedbacks_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // 清空所有反馈
        function clearAllFeedbacks() {
            if (confirm('确定要清空所有反馈数据吗？此操作不可恢复！')) {
                localStorage.removeItem('userFeedbacks');
                console.log('所有反馈数据已清空');
                showDeveloperDashboard(); // 刷新列表
            }
        }

        // 保存饮食记录
        async function saveDietRecord() {
            const mealTime = document.getElementById('meal-time')?.value;
            const foodContent = document.getElementById('food-content')?.value;
            const dietTime = document.getElementById('diet-time')?.value;
            
            if (!mealTime || !foodContent) {
                alert('请填写用餐时间和食物内容');
                return;
            }
            
            try {
                const dietRecord = {
                    id: Date.now(),
                    mealTime: mealTime,
                    foodContent: foodContent,
                    dietTime: dietTime || new Date().toISOString(),
                    timestamp: new Date().toISOString()
                };
                
                // 保存到本地存储
                let dietRecords = JSON.parse(localStorage.getItem('dietRecords') || '[]');
                dietRecords.push(dietRecord);
                localStorage.setItem('dietRecords', JSON.stringify(dietRecords));
                
                // 清空表单
                document.getElementById('food-content').value = '';
                document.getElementById('diet-time').value = '';
                
                // 显示成功消息
                FeedbackSystem.showSuccess('饮食记录保存成功！');
                
                // 刷新饮食记录历史
                displayDietHistory();
                
                console.log('饮食记录已保存:', dietRecord);
            } catch (error) {
                console.error('保存饮食记录失败:', error);
                FeedbackSystem.showError('保存失败，请重试');
            }
        }

        // 生成个性化饮食建议
        async function generatePersonalizedDietAdvice() {
            try {
                FeedbackSystem.showLoading('正在分析您的健康数据...');
                
                // 收集所有健康数据
                const healthData = await collectAllHealthData();
                
                // 生成AI饮食建议
                const dietAdvice = await generateAIDietAdvice(healthData);
                
                // 显示建议
                displayDietAdvice(dietAdvice);
                
                FeedbackSystem.hideLoading();
                FeedbackSystem.showSuccess('个性化饮食建议已生成！');
                
            } catch (error) {
                console.error('生成饮食建议失败:', error);
                FeedbackSystem.hideLoading();
                FeedbackSystem.showError('生成建议失败，请重试');
            }
        }

        // 收集所有健康数据
        async function collectAllHealthData() {
            const healthData = {
                // 基本信息
                age: document.getElementById('assessment-age')?.value,
                gender: document.getElementById('assessment-gender')?.value,
                height: document.getElementById('assessment-height')?.value,
                weight: document.getElementById('assessment-weight')?.value,
                bmi: document.getElementById('assessment-bmi')?.value,
                
                // 健康指标
                bloodPressure: {
                    systolic: document.getElementById('assessment-systolic')?.value,
                    diastolic: document.getElementById('assessment-diastolic')?.value
                },
                heartRate: document.getElementById('assessment-heart-rate')?.value,
                bloodGlucose: document.getElementById('assessment-glucose')?.value,
                temperature: document.getElementById('assessment-temperature')?.value,
                spO2: document.getElementById('assessment-spo2')?.value,
                
                // 医疗史
                medicalHistory: document.getElementById('assessment-medical-history')?.value,
                medications: document.getElementById('assessment-medications')?.value,
                
                // 生活方式
                exerciseHabits: document.getElementById('assessment-exercise')?.value,
                sleepHabits: document.getElementById('assessment-sleep')?.value,
                stressLevel: document.getElementById('assessment-stress')?.value,
                
                // 饮食记录
                dietRecords: JSON.parse(localStorage.getItem('dietRecords') || '[]'),
                
                // 设备数据
                deviceData: getLatestDeviceData()
            };
            
            return healthData;
        }

        // 生成AI饮食建议
        async function generateAIDietAdvice(healthData) {
            // 首先尝试使用AI服务
            const prompt = `
作为专业的营养师和健康顾问，请根据以下用户的健康数据，提供个性化的饮食建议：

**基本信息：**
- 年龄: ${healthData.age || '未提供'}
- 性别: ${healthData.gender || '未提供'}
- 身高: ${healthData.height || '未提供'} cm
- 体重: ${healthData.weight || '未提供'} kg
- BMI: ${healthData.bmi || '未提供'}

**健康指标：**
- 血压: ${healthData.bloodPressure.systolic || '未提供'}/${healthData.bloodPressure.diastolic || '未提供'} mmHg
- 心率: ${healthData.heartRate || '未提供'} bpm
- 血糖: ${healthData.bloodGlucose || '未提供'} mg/dL
- 体温: ${healthData.temperature || '未提供'} °C
- 血氧: ${healthData.spO2 || '未提供'} %

**医疗史：**
- 疾病史: ${healthData.medicalHistory || '无'}
- 用药情况: ${healthData.medications || '无'}

**生活方式：**
- 运动习惯: ${healthData.exerciseHabits || '未提供'}
- 睡眠习惯: ${healthData.sleepHabits || '未提供'}
- 压力水平: ${healthData.stressLevel || '未提供'}

**近期饮食记录：**
${healthData.dietRecords.slice(-7).map(record => 
    `- ${record.mealTime}: ${record.foodContent} (${new Date(record.dietTime).toLocaleDateString()})`
).join('\n') || '暂无饮食记录'}

**设备监测数据：**
${healthData.deviceData ? `
- 最新血压: ${healthData.deviceData.bloodPressure?.systolic || 'N/A'}/${healthData.deviceData.bloodPressure?.diastolic || 'N/A'} mmHg
- 最新心率: ${healthData.deviceData.heartRate || 'N/A'} bpm
- 最新血糖: ${healthData.deviceData.bloodGlucose || 'N/A'} mg/dL
- 最新体温: ${healthData.deviceData.temperature || 'N/A'} °C
- 最新血氧: ${healthData.deviceData.spO2 || 'N/A'} %
` : '暂无设备数据'}

请基于以上信息，提供：
1. 营养需求分析
2. 具体饮食建议（包括推荐食物和避免食物）
3. 用餐时间建议
4. 特殊注意事项
5. 营养补充建议

请用中文回答，内容要专业、实用、易懂。
            `;
            
            try {
                // 检查AI服务是否可用
                const healthCheck = await fetch('http://localhost:3000/', {
                    method: 'GET',
                    timeout: 3000
                });
                
                if (!healthCheck.ok) {
                    throw new Error('AI服务不可用');
                }
                
                console.log('AI服务健康检查通过，开始发送请求...');
                
                const response = await fetch('http://localhost:3000/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer sk-ef5d339bf70b4f4d8e0657db5ba02d22'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            {
                                role: 'user',
                                content: prompt
                            }
                        ]
                    })
                });
                
                console.log('API响应状态:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API错误详情:', errorData);
                    throw new Error(`AI服务响应失败: ${response.status} - ${JSON.stringify(errorData)}`);
                }
                
                const data = await response.json();
                console.log('API响应数据:', data);
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    return data.choices[0].message.content;
                } else {
                    throw new Error('API响应格式异常');
                }
                
            } catch (error) {
                console.log('AI服务不可用，使用基于规则的备用建议:', error.message);
                // 返回基于规则的备用建议
                return generateRuleBasedDietAdvice(healthData);
            }
        }

        // 基于规则的备用饮食建议
        function generateRuleBasedDietAdvice(healthData) {
            let advice = "🤖 **智能营养分析** - 基于您的健康数据提供个性化饮食建议\n\n";
            
            // 营养需求分析
            advice += "## 📊 营养需求分析\n\n";
            
            const age = parseInt(healthData.age);
            const gender = healthData.gender;
            const bmi = parseFloat(healthData.bmi);
            
            if (age && gender) {
                if (age >= 60) {
                    advice += `**老年营养需求** (${age}岁${gender === '男' ? '男性' : '女性'})：\n`;
                    advice += "- 蛋白质需求：1.0-1.2g/kg体重/天\n";
                    advice += "- 钙质需求：1000-1200mg/天\n";
                    advice += "- 维生素D需求：800-1000IU/天\n";
                    advice += "- 水分需求：1500-2000ml/天\n\n";
                } else if (age >= 50) {
                    advice += `**中年营养需求** (${age}岁${gender === '男' ? '男性' : '女性'})：\n`;
                    advice += "- 蛋白质需求：0.8-1.0g/kg体重/天\n";
                    advice += "- 钙质需求：1000mg/天\n";
                    advice += "- 维生素D需求：600-800IU/天\n";
                    advice += "- 水分需求：2000-2500ml/天\n\n";
                }
            }
            
            // BMI分析
            if (bmi) {
                advice += "## 🏃‍♂️ 体重管理建议\n\n";
                if (bmi < 18.5) {
                    advice += "**体重偏轻** (BMI: " + bmi.toFixed(1) + ")：\n";
                    advice += "- 增加营养密度高的食物：坚果、全脂奶制品、瘦肉、鱼类\n";
                    advice += "- 适当增加健康脂肪：橄榄油、牛油果、坚果\n";
                    advice += "- 少食多餐，增加餐次\n";
                    advice += "- 推荐食物：全脂牛奶、鸡蛋、瘦肉、坚果、香蕉\n\n";
                } else if (bmi > 24) {
                    advice += "**体重偏重** (BMI: " + bmi.toFixed(1) + ")：\n";
                    advice += "- 控制总热量摄入，创造热量缺口\n";
                    advice += "- 增加蔬菜和蛋白质比例，减少精制碳水化合物\n";
                    advice += "- 选择低热量高纤维食物\n";
                    advice += "- 推荐食物：绿叶蔬菜、瘦肉、鱼类、燕麦、豆类\n";
                    advice += "- 避免食物：高糖饮料、油炸食品、精制米面\n\n";
                } else {
                    advice += "**体重正常** (BMI: " + bmi.toFixed(1) + ")：\n";
                    advice += "- 保持均衡饮食，维持当前健康状态\n";
                    advice += "- 继续多样化饮食，适量运动\n\n";
                }
            }
            
            // 血压分析
            const systolic = parseInt(healthData.bloodPressure.systolic);
            const diastolic = parseInt(healthData.bloodPressure.diastolic);
            if (systolic && diastolic) {
                advice += "## 🩺 血压管理建议\n\n";
                if (systolic >= 140 || diastolic >= 90) {
                    advice += "**血压偏高** (" + systolic + "/" + diastolic + " mmHg)：\n";
                    advice += "- 减少钠盐摄入，每日不超过6克（约1茶匙）\n";
                    advice += "- 增加富含钾的食物：香蕉、橙子、菠菜、土豆、番茄\n";
                    advice += "- 增加富含镁的食物：坚果、绿叶蔬菜、全谷物\n";
                    advice += "- 限制加工食品、腌制食品、快餐\n";
                    advice += "- 推荐食物：香蕉、橙子、菠菜、燕麦、坚果\n";
                    advice += "- 避免食物：咸菜、腊肉、方便面、薯片\n\n";
                } else if (systolic >= 120 || diastolic >= 80) {
                    advice += "**血压正常偏高** (" + systolic + "/" + diastolic + " mmHg)：\n";
                    advice += "- 预防性控制钠盐摄入\n";
                    advice += "- 增加富含钾的食物\n";
                    advice += "- 保持健康生活方式\n\n";
                } else {
                    advice += "**血压正常** (" + systolic + "/" + diastolic + " mmHg)：\n";
                    advice += "- 继续保持健康饮食和生活方式\n\n";
                }
            }
            
            // 血糖分析
            const glucose = parseInt(healthData.bloodGlucose);
            if (glucose) {
                advice += "## 🍯 血糖管理建议\n\n";
                if (glucose > 126) {
                    advice += "**血糖偏高** (" + glucose + " mg/dL)：\n";
                    advice += "- 控制碳水化合物摄入，选择低GI食物\n";
                    advice += "- 增加膳食纤维：燕麦、豆类、蔬菜、全谷物\n";
                    advice += "- 定时定量进餐，避免暴饮暴食\n";
                    advice += "- 推荐食物：燕麦、豆类、绿叶蔬菜、坚果、鱼类\n";
                    advice += "- 避免食物：白米饭、白面包、糖果、含糖饮料\n\n";
                } else if (glucose > 100) {
                    advice += "**血糖正常偏高** (" + glucose + " mg/dL)：\n";
                    advice += "- 预防性控制精制碳水化合物\n";
                    advice += "- 增加膳食纤维摄入\n";
                    advice += "- 保持规律进餐\n\n";
                } else {
                    advice += "**血糖正常** (" + glucose + " mg/dL)：\n";
                    advice += "- 继续保持均衡饮食\n\n";
                }
            }
            
            // 医疗史分析
            if (healthData.medicalHistory) {
                advice += "## 🏥 特殊疾病饮食建议\n\n";
                const medicalHistory = healthData.medicalHistory.toLowerCase();
                
                if (medicalHistory.includes('高血压') || medicalHistory.includes('血压')) {
                    advice += "**高血压饮食原则**：\n";
                    advice += "- DASH饮食法：多蔬菜水果，少钠盐\n";
                    advice += "- 增加钾、钙、镁的摄入\n";
                    advice += "- 限制酒精摄入\n\n";
                }
                
                if (medicalHistory.includes('糖尿病') || medicalHistory.includes('血糖')) {
                    advice += "**糖尿病饮食原则**：\n";
                    advice += "- 控制碳水化合物总量和分布\n";
                    advice += "- 选择低GI食物\n";
                    advice += "- 定时定量进餐\n";
                    advice += "- 增加膳食纤维\n\n";
                }
                
                if (medicalHistory.includes('心脏病') || medicalHistory.includes('心血管')) {
                    advice += "**心血管疾病饮食原则**：\n";
                    advice += "- 地中海饮食模式\n";
                    advice += "- 增加omega-3脂肪酸\n";
                    advice += "- 限制饱和脂肪和反式脂肪\n";
                    advice += "- 增加抗氧化物质\n\n";
                }
            }
            
            // 生活方式建议
            advice += "## 🏃‍♀️ 生活方式饮食建议\n\n";
            
            if (healthData.exerciseHabits) {
                advice += "**运动营养**：\n";
                if (healthData.exerciseHabits.includes('散步') || healthData.exerciseHabits.includes('轻度')) {
                    advice += "- 轻度运动：保持均衡饮食即可\n";
                    advice += "- 运动前后适量补充水分\n\n";
                } else if (healthData.exerciseHabits.includes('跑步') || healthData.exerciseHabits.includes('强度')) {
                    advice += "- 中高强度运动：适当增加蛋白质和碳水化合物\n";
                    advice += "- 运动前1-2小时进食，运动后30分钟内补充营养\n\n";
                }
            }
            
            if (healthData.stressLevel) {
                advice += "**压力管理饮食**：\n";
                if (healthData.stressLevel.includes('高') || healthData.stressLevel.includes('大')) {
                    advice += "- 增加富含B族维生素的食物：全谷物、坚果、绿叶蔬菜\n";
                    advice += "- 增加富含镁的食物：香蕉、坚果、深色蔬菜\n";
                    advice += "- 避免过量咖啡因和糖分\n\n";
                }
            }
            
            // 饮食记录分析
            if (healthData.dietRecords && healthData.dietRecords.length > 0) {
                advice += "## 📝 基于您的饮食记录\n\n";
                advice += "**近期饮食回顾**：\n";
                const recentRecords = healthData.dietRecords.slice(-3);
                recentRecords.forEach(record => {
                    advice += `- ${record.mealTime}: ${record.foodContent}\n`;
                });
                advice += "\n**改进建议**：\n";
                advice += "- 确保每餐都有蔬菜\n";
                advice += "- 增加优质蛋白质来源\n";
                advice += "- 控制精制碳水化合物\n\n";
            }
            
            // 用餐时间建议
            advice += "## ⏰ 用餐时间建议\n\n";
            advice += "**最佳用餐时间**：\n";
            advice += "- 早餐：7:00-9:00（起床后1小时内）\n";
            advice += "- 午餐：12:00-13:00\n";
            advice += "- 晚餐：18:00-19:00（睡前3-4小时）\n";
            advice += "- 加餐：上午10:00、下午15:00（如需要）\n\n";
            
            // 营养补充建议
            advice += "## 💊 营养补充建议\n\n";
            if (age >= 60) {
                advice += "**老年营养补充**：\n";
                advice += "- 维生素D：800-1000IU/天\n";
                advice += "- 钙质：1000-1200mg/天\n";
                advice += "- 维生素B12：2.4μg/天\n";
                advice += "- Omega-3：1000mg/天\n\n";
            }
            
            // 通用饮食原则
            advice += "## 🥗 通用饮食原则\n\n";
            advice += "**健康饮食金字塔**：\n";
            advice += "1. **基础层**：全谷物、蔬菜、水果（占餐盘的50%）\n";
            advice += "2. **蛋白质层**：瘦肉、鱼类、豆类、坚果（占餐盘的25%）\n";
            advice += "3. **健康脂肪层**：橄榄油、坚果、牛油果（适量）\n";
            advice += "4. **限制层**：精制糖、加工食品、过量盐分\n\n";
            
            advice += "**每日饮食目标**：\n";
            advice += "- 蔬菜：300-500g\n";
            advice += "- 水果：200-350g\n";
            advice += "- 全谷物：250-400g\n";
            advice += "- 蛋白质：60-80g\n";
            advice += "- 水分：1500-2000ml\n\n";
            
            // 注意事项
            advice += "## ⚠️ 重要注意事项\n\n";
            advice += "- 以上建议仅供参考，不能替代专业医疗建议\n";
            advice += "- 如有特殊疾病，请咨询专业医生或营养师\n";
            advice += "- 饮食调整应循序渐进，避免突然改变\n";
            advice += "- 定期监测健康指标，及时调整饮食方案\n";
            advice += "- 结合适量运动，效果更佳\n\n";
            
            advice += "💡 **温馨提示**：健康饮食是一个长期的过程，坚持就是胜利！";
            
            return advice;
        }

        // 显示饮食建议
        function displayDietAdvice(advice) {
            const adviceContainer = document.getElementById('diet-advice');
            if (adviceContainer) {
                // 将换行符转换为HTML
                const formattedAdvice = advice.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                adviceContainer.innerHTML = `
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="flex items-start">
                            <i class="fa fa-lightbulb-o text-blue-500 text-xl mr-3 mt-1"></i>
                            <div class="flex-1">
                                <h4 class="font-semibold text-blue-800 mb-2">AI个性化饮食建议</h4>
                                <div class="text-blue-700 text-sm leading-relaxed">
                                    ${formattedAdvice}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // 显示饮食记录历史
        function displayDietHistory() {
            const dietRecords = JSON.parse(localStorage.getItem('dietRecords') || '[]');
            const historyContainer = document.querySelector('#page-diet .card:last-child .space-y-3');
            
            if (historyContainer) {
                if (dietRecords.length === 0) {
                    historyContainer.innerHTML = '<p class="text-gray-500 text-center py-4">暂无饮食记录</p>';
                } else {
                    historyContainer.innerHTML = dietRecords.slice(-10).reverse().map(record => `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div>
                                <div class="font-medium text-gray-800">${record.mealTime}</div>
                                <div class="text-sm text-gray-600">${record.foodContent}</div>
                                <div class="text-xs text-gray-500">${new Date(record.dietTime).toLocaleString('zh-CN')}</div>
                            </div>
                            <button onclick="deleteDietRecord(${record.id})" class="text-red-500 hover:text-red-700">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    `).join('');
                }
            }
        }

        // 删除饮食记录
        function deleteDietRecord(recordId) {
            if (confirm('确定要删除这条饮食记录吗？')) {
                let dietRecords = JSON.parse(localStorage.getItem('dietRecords') || '[]');
                dietRecords = dietRecords.filter(record => record.id !== recordId);
                localStorage.setItem('dietRecords', JSON.stringify(dietRecords));
                displayDietHistory();
                FeedbackSystem.showSuccess('饮食记录已删除');
            }
        }

        // 隐私政策功能
        function showPrivacyPolicy() {
            const privacyContent = `
                <div class="max-w-4xl mx-auto p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">隐私政策</h2>
                    
                    <div class="space-y-6">
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">数据收集与使用</h3>
                            <div class="space-y-3 text-sm text-gray-600">
                                <p>我们仅收集必要的健康数据以提供个性化服务：</p>
                                <ul class="list-disc list-inside space-y-1 ml-4">
                                    <li>基本信息：年龄、性别、身高、体重</li>
                                    <li>健康指标：血压、心率、血糖、体温、血氧等</li>
                                    <li>医疗史：疾病史、用药情况</li>
                                    <li>生活方式：运动习惯、饮食习惯</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">数据安全保护</h3>
                            <div class="space-y-3 text-sm text-gray-600">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <h4 class="font-medium text-gray-700 mb-2">加密技术</h4>
                                        <p>采用AES-256加密算法保护数据传输和存储</p>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-gray-700 mb-2">访问控制</h4>
                                        <p>严格的权限管理和身份验证机制</p>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-gray-700 mb-2">数据备份</h4>
                                        <p>多重备份确保数据安全性和可用性</p>
                                    </div>
                                    <div>
                                        <h4 class="font-medium text-gray-700 mb-2">合规认证</h4>
                                        <p>符合HIPAA、GDPR等国际安全标准</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">用户权利</h3>
                            <div class="space-y-3 text-sm text-gray-600">
                                <div class="flex items-start">
                                    <i class="fa fa-check-circle text-green-500 mr-3 mt-1"></i>
                                    <div>
                                        <h4 class="font-medium text-gray-700">数据访问权</h4>
                                        <p>您可以随时查看和下载您的健康数据</p>
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <i class="fa fa-edit text-blue-500 mr-3 mt-1"></i>
                                    <div>
                                        <h4 class="font-medium text-gray-700">数据修改权</h4>
                                        <p>您可以更正或更新不准确的个人信息</p>
                                    </div>
                                </div>
                                <div class="flex items-start">
                                    <i class="fa fa-trash text-red-500 mr-3 mt-1"></i>
                                    <div>
                                        <h4 class="font-medium text-gray-700">数据删除权</h4>
                                        <p>您可以要求删除您的个人健康数据</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-yellow-800 mb-3">重要声明</h3>
                            <p class="text-yellow-700 text-sm">
                                本应用提供的健康建议仅供参考，不能替代专业医疗诊断。如有健康问题，请及时咨询专业医生。
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            showModal('隐私政策', privacyContent);
        }

        // 操作处理函数
        async function handleAction(action, ...args) {
            console.log('执行操作:', action, args);
            
            // 添加涟漪效果
            if (event && event.currentTarget) {
                createRipple(event);
            }
            
            switch(action) {
                case 'showPage':
                    showPage(args[0]);
                    break;
                    
                case 'runHealthAssessment':
                    await simulateAsyncOperation('运行健康评估', () => {
                        runHealthAssessment();
                        return true;
                    });
                    break;
                    
                case 'showAlgorithmTransparency':
                    showAlgorithmTransparency();
                    break;
                    
                case 'updateTrendChart':
                    updateTrendChart();
                    break;
                    
                case 'updateCorrelationChart':
                    updateCorrelationChart();
                    break;
                    
                case 'updateMultiDimensionChart':
                    updateMultiDimensionChart();
                    break;
                    
                case 'refreshDeviceStats':
                    refreshDeviceStats();
                    break;
                    
                case 'openAIHealthAssistant':
                    openAIHealthAssistant();
                    break;
                    
                case 'addMedicineRecord':
                    await simulateAsyncOperation('添加用药记录', () => {
                        console.log('添加用药记录');
                        return true;
                    });
                    break;
                    
                case 'clearMedicineRecords':
                    await simulateAsyncOperation('清空用药记录', () => {
                        console.log('清空用药记录');
                        return true;
                    });
                    break;
                    
                case 'addExamAppointment':
                    await simulateAsyncOperation('添加体检预约', () => {
                        console.log('添加体检预约');
                        return true;
                    });
                    break;
                    
                case 'clearExamRecords':
                    await simulateAsyncOperation('清空体检记录', () => {
                        console.log('清空体检记录');
                        return true;
                    });
                    break;
                    
                case 'saveDietRecord':
                    await saveDietRecord();
                    break;
                    
                case 'generateDietAdvice':
                    await generatePersonalizedDietAdvice();
                    break;
                    
                case 'addExerciseRecord':
                    await simulateAsyncOperation('添加运动记录', () => {
                        console.log('添加运动记录');
                        return true;
                    });
                    break;
                    
                case 'clearExerciseRecords':
                    await simulateAsyncOperation('清空运动记录', () => {
                        console.log('清空运动记录');
                        return true;
                    });
                    break;
                    
                case 'addHealthGoal':
                    await simulateAsyncOperation('添加健康目标', () => {
                        console.log('添加健康目标');
                        return true;
                    });
                    break;
                    
                case 'clearCompletedGoals':
                    await simulateAsyncOperation('清理已完成目标', () => {
                        console.log('清理已完成目标');
                        return true;
                    });
                    break;
                    
                case 'addHealthRecord':
                    await simulateAsyncOperation('添加健康数据', () => {
                        addHealthRecord();
                        return true;
                    });
                    break;
                    
                case 'addDeviceData':
                    await simulateAsyncOperation('保存设备数据', () => {
                        addDeviceData();
                        return true;
                    });
                    break;
                    
                case 'generateHealthReport':
                    await simulateAsyncOperation('生成专业健康报告', async () => {
                        await generateProfessionalHealthReport();
                        return true;
                    });
                    break;
                    
                case 'showSettingsPanel':
                    showSettingsPanel();
                    break;
                    
                case 'closeSettingsPanel':
                    closeSettingsPanel();
                    break;
                    
                case 'toggleTheme':
                    toggleTheme();
                    break;
                    
                case 'toggleAutoTheme':
                    toggleAutoTheme();
                    break;
                    
                case 'toggleMedicationReminder':
                    toggleMedicationReminder();
                    break;
                    
                case 'toggleExamReminder':
                    toggleExamReminder();
                    break;
                    
                case 'toggleReportReminder':
                    toggleReportReminder();
                    break;
                    
                case 'exportHealthData':
                    await simulateAsyncOperation('导出健康数据', () => {
                        exportHealthData();
                        return true;
                    });
                    break;
                    
                case 'importHealthData':
                    await simulateAsyncOperation('导入健康数据', () => {
                        importHealthData();
                        return true;
                    });
                    break;
                    
                case 'clearAllData':
                    await simulateAsyncOperation('清除所有数据', () => {
                        clearAllData();
                        return true;
                    });
                    break;
                    
                default:
                    console.log('未知操作:', action);
                    FeedbackSystem.showError('未知操作');
            }
        }

        // 模拟异步操作
        async function simulateAsyncOperation(operationName, operation) {
            const loadingToast = FeedbackSystem.showLoading(`${operationName}中...`);
            
            try {
                // 模拟网络延迟
                await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000));
                
                const result = operation();
                
                if (result) {
                    FeedbackSystem.hideLoading();
                    FeedbackSystem.showSuccess(`${operationName}成功`);
                } else {
                    throw new Error('操作失败');
                }
            } catch (error) {
                FeedbackSystem.hideLoading();
                FeedbackSystem.showError(`${operationName}失败`);
                console.error('操作失败:', error);
            }
        }

        // 初始化动画延迟
        function initStaggeredAnimations() {
            const animatedElements = document.querySelectorAll('[data-delay]');
            animatedElements.forEach(element => {
                const delay = parseInt(element.dataset.delay);
                element.style.animationDelay = `${delay}ms`;
            });
        }

        // 运行健康评估
        function runHealthAssessment() {
            const age = parseInt(document.getElementById('assessment-age')?.value) || 0;
            const bmi = parseFloat(document.getElementById('assessment-bmi')?.value) || 0;
            const glucose = parseInt(document.getElementById('assessment-glucose')?.value) || 0;
            
            // 從智能設備數據中獲取血壓數據
            const deviceData = getLatestDeviceData();
            const systolic = deviceData.bloodPressure?.systolic || 0;
            const diastolic = deviceData.bloodPressure?.diastolic || 0;
            
            const medicalHistory = [];
            if (document.getElementById('history-diabetes')?.checked) medicalHistory.push('diabetes');
            if (document.getElementById('history-hypertension')?.checked) medicalHistory.push('hypertension');
            if (document.getElementById('history-heart')?.checked) medicalHistory.push('heart');
            
            const patientData = {
                age: age,
                bloodPressure: { systolic: systolic, diastolic: diastolic },
                bmi: bmi,
                bloodGlucose: glucose,
                medicalHistory: medicalHistory
            };
            
            // 运行心血管风险评估
            const cardiovascularRisk = healthAssessment.calculateCardiovascularRisk(patientData);
            
            // 运行代谢健康评估
            const metabolicHealth = healthAssessment.calculateMetabolicHealth(patientData);
            
            // 显示评估结果
            showAssessmentResults(cardiovascularRisk, metabolicHealth);
        }

        // 显示评估结果
        function showAssessmentResults(cardiovascularRisk, metabolicHealth) {
            const reportDiv = document.getElementById('health-report');
            if (!reportDiv) return;
            
            reportDiv.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-blue-800 mb-2">心血管风险评估</h4>
                        <p class="text-blue-700">风险等级: <span class="font-bold">${cardiovascularRisk.riskLevel}</span></p>
                        <p class="text-blue-700">风险评分: <span class="font-bold">${(cardiovascularRisk.riskScore * 100).toFixed(1)}%</span></p>
                        <p class="text-blue-700">置信度: <span class="font-bold">${(cardiovascularRisk.confidence * 100).toFixed(1)}%</span></p>
                        <div class="mt-2">
                            <h5 class="font-medium text-blue-800">评估说明:</h5>
                            <ul class="text-sm text-blue-700 list-disc list-inside">
                                ${(cardiovascularRisk.explanations || []).map(exp => `<li>${exp}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="mt-2">
                            <h5 class="font-medium text-blue-800">建议:</h5>
                            <ul class="text-sm text-blue-700 list-disc list-inside">
                                ${(cardiovascularRisk.recommendations || []).map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-green-800 mb-2">代谢健康评估</h4>
                        <p class="text-green-700">健康等级: <span class="font-bold">${metabolicHealth.healthLevel}</span></p>
                        <p class="text-green-700">健康评分: <span class="font-bold">${(metabolicHealth.healthScore * 100).toFixed(1)}%</span></p>
                        <p class="text-green-700">置信度: <span class="font-bold">${(metabolicHealth.confidence * 100).toFixed(1)}%</span></p>
                        <div class="mt-2">
                            <h5 class="font-medium text-green-800">评估说明:</h5>
                            <ul class="text-sm text-green-700 list-disc list-inside">
                                ${(metabolicHealth.explanations || []).map(exp => `<li>${exp}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="mt-2">
                            <h5 class="font-medium text-green-800">建议:</h5>
                            <ul class="text-sm text-green-700 list-disc list-inside">
                                ${(metabolicHealth.recommendations || []).map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        // 显示算法透明度信息
        function showAlgorithmTransparency() {
            const transparency = healthAssessment.getAlgorithmTransparency();
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold">算法透明度报告</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fa fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-gray-800">模型信息</h4>
                            <p class="text-sm text-gray-600">模型名称: ${transparency.modelName}</p>
                            <p class="text-sm text-gray-600">最后更新: ${transparency.lastUpdated}</p>
                            <p class="text-sm text-gray-600">置信度: ${(transparency.confidenceLevel * 100).toFixed(1)}%</p>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-800">风险因子权重</h4>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                ${Object.entries(transparency.weightFactors).map(([factor, weight]) => 
                                    `<div class="flex justify-between">
                                        <span>${factor}:</span>
                                        <span class="font-medium">${(weight * 100).toFixed(1)}%</span>
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-800">数据来源</h4>
                            <ul class="text-sm text-gray-600 list-disc list-inside">
                                ${(transparency.dataSources || []).map(source => `<li>${source}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-gray-800">验证研究</h4>
                            <ul class="text-sm text-gray-600 list-disc list-inside">
                                ${(transparency.validationStudies || []).map(study => `<li>${study}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // 獲取指定時間範圍的數據
        function getDataByTimeRange(timeRange) {
            try {
                const healthRecords = JSON.parse(localStorage.getItem('healthRecords') || '[]');
                const now = new Date();
                let startDate;
                
                switch (timeRange) {
                    case '1day':
                        startDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                        break;
                    case '1week':
                        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        break;
                    case '1month':
                        startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        break;
                    case '1year':
                        startDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                        break;
                    default:
                        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                }
                
                return healthRecords.filter(record => {
                    const recordDate = new Date(record.timestamp);
                    return recordDate >= startDate && recordDate <= now;
                });
            } catch (error) {
                console.error('獲取數據失敗:', error);
                return [];
            }
        }

        // 處理血壓趨勢數據
        function processBloodPressureTrendData(records, timeRange) {
            const bpRecords = records.filter(record => record.type === '血压' || record.type === '血壓');
            
            if (bpRecords.length === 0) {
                return {
                    labels: ['無數據'],
                    datasets: [{
                        label: '收縮壓',
                        data: [0],
                        borderColor: '#e74c3c',
                        backgroundColor: '#e74c3c20',
                        tension: 0.4
                    }, {
                        label: '舒張壓',
                        data: [0],
                        borderColor: '#3498db',
                        backgroundColor: '#3498db20',
                        tension: 0.4
                    }]
                };
            }
            
            // 按時間排序
            bpRecords.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            const labels = [];
            const systolicData = [];
            const diastolicData = [];
            
            bpRecords.forEach(record => {
                const date = new Date(record.timestamp);
                let label;
                
                switch (timeRange) {
                    case '1day':
                        label = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                        break;
                    case '1week':
                        label = date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                        break;
                    case '1month':
                        label = date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
                        break;
                    case '1year':
                        label = date.toLocaleDateString('zh-CN', { month: 'short' });
                        break;
                    default:
                        label = date.toLocaleDateString('zh-CN');
                }
                
                labels.push(label);
                systolicData.push(record.data.systolic);
                diastolicData.push(record.data.diastolic);
            });
            
            return {
                labels: labels,
                datasets: [{
                    label: '收縮壓',
                    data: systolicData,
                    borderColor: '#e74c3c',
                    backgroundColor: '#e74c3c20',
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }, {
                    label: '舒張壓',
                    data: diastolicData,
                    borderColor: '#3498db',
                    backgroundColor: '#3498db20',
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            };
        }

        // 更新趋势图表
        function updateTrendChart() {
            const ctx = document.getElementById('trend-chart');
            if (!ctx) return;

            // 銷毀現有圖表
            if (window.chartInstances && window.chartInstances['trend-chart']) {
                window.chartInstances['trend-chart'].destroy();
            }

            // 獲取時間範圍
            const timeRange = document.getElementById('trend-time-range')?.value || '1week';
            
            // 獲取真實數據
            const records = getDataByTimeRange(timeRange);
            const chartData = processBloodPressureTrendData(records, timeRange);
            
            window.chartInstances = window.chartInstances || {};
            window.chartInstances['trend-chart'] = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `血壓趨勢分析 (${getTimeRangeText(timeRange)})`
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 60,
                            max: 200,
                            title: {
                                display: true,
                                text: '血壓 (mmHg)'
                            }
                        }
                    }
                }
            });
        }

        // 獲取時間範圍文字
        function getTimeRangeText(timeRange) {
            const texts = {
                '1day': '一日',
                '1week': '一星期',
                '1month': '一個月',
                '1year': '一年'
            };
            return texts[timeRange] || '一星期';
        }

        // 處理相關性數據
        function processCorrelationData(records) {
            const bpRecords = records.filter(record => record.type === '血压' || record.type === '血壓');
            const spo2Records = records.filter(record => record.type === '血氧');
            const tempRecords = records.filter(record => record.type === '体温' || record.type === '體溫');
            
            if (bpRecords.length === 0) {
                return {
                    labels: ['無數據'],
                    datasets: [{
                        label: '數據可用性',
                        data: [0],
                        backgroundColor: ['#e74c3c'],
                        borderColor: ['#c0392b'],
                        borderWidth: 1
                    }]
                };
            }
            
            // 計算數據可用性
            const totalRecords = records.length;
            const bpAvailability = bpRecords.length / Math.max(totalRecords, 1);
            const spo2Availability = spo2Records.length / Math.max(totalRecords, 1);
            const tempAvailability = tempRecords.length / Math.max(totalRecords, 1);
            
            // 計算血壓變異性
            let bpVariability = 0;
            if (bpRecords.length > 1) {
                const systolicValues = bpRecords.map(r => r.data.systolic);
                const mean = systolicValues.reduce((a, b) => a + b, 0) / systolicValues.length;
                const variance = systolicValues.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / systolicValues.length;
                bpVariability = Math.sqrt(variance) / mean;
            }
            
            return {
                labels: ['血壓數據', '血氧數據', '體溫數據', '數據完整性', '血壓穩定性'],
                datasets: [{
                    label: '健康指標分析',
                    data: [
                        bpAvailability,
                        spo2Availability,
                        tempAvailability,
                        (bpAvailability + spo2Availability + tempAvailability) / 3,
                        Math.max(0, 1 - bpVariability)
                    ],
                    backgroundColor: ['#e74c3c', '#2ecc71', '#f39c12', '#3498db', '#9b59b6'],
                    borderColor: ['#c0392b', '#27ae60', '#e67e22', '#2980b9', '#8e44ad'],
                    borderWidth: 1
                }]
            };
        }

        // 更新相关性图表
        function updateCorrelationChart() {
            const ctx = document.getElementById('correlation-chart');
            if (!ctx) return;

            // 銷毀現有圖表
            if (window.chartInstances && window.chartInstances['correlation-chart']) {
                window.chartInstances['correlation-chart'].destroy();
            }

            // 獲取時間範圍
            const timeRange = document.getElementById('correlation-time-range')?.value || '1week';
            
            // 獲取真實數據
            const records = getDataByTimeRange(timeRange);
            const chartData = processCorrelationData(records);
            
            window.chartInstances = window.chartInstances || {};
            window.chartInstances['correlation-chart'] = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `健康指標分析 (${getTimeRangeText(timeRange)})`
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            title: {
                                display: true,
                                text: '指標強度'
                            },
                            ticks: {
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // 處理多維度數據
        function processMultiDimensionData(records) {
            const bpRecords = records.filter(record => record.type === '血压' || record.type === '血壓');
            const spo2Records = records.filter(record => record.type === '血氧');
            const tempRecords = records.filter(record => record.type === '体温' || record.type === '體溫');
            
            // 計算各項健康指標
            let cardiovascularHealth = 50; // 心血管健康
            let metabolicHealth = 50; // 代謝健康
            let respiratoryHealth = 50; // 呼吸健康
            let temperatureStability = 50; // 體溫穩定性
            let dataCompleteness = 50; // 數據完整性
            
            if (bpRecords.length > 0) {
                const latestBP = bpRecords[bpRecords.length - 1];
                const systolic = latestBP.data.systolic;
                const diastolic = latestBP.data.diastolic;
                
                // 心血管健康評分
                if (systolic < 120 && diastolic < 80) cardiovascularHealth = 90;
                else if (systolic < 130 && diastolic < 85) cardiovascularHealth = 80;
                else if (systolic < 140 && diastolic < 90) cardiovascularHealth = 70;
                else if (systolic < 160 && diastolic < 100) cardiovascularHealth = 50;
                else cardiovascularHealth = 30;
            }
            
            if (spo2Records.length > 0) {
                const latestSpO2 = spo2Records[spo2Records.length - 1];
                const percent = latestSpO2.data.percent;
                
                // 呼吸健康評分
                if (percent >= 98) respiratoryHealth = 90;
                else if (percent >= 95) respiratoryHealth = 80;
                else if (percent >= 90) respiratoryHealth = 60;
                else respiratoryHealth = 30;
            }
            
            if (tempRecords.length > 0) {
                const latestTemp = tempRecords[tempRecords.length - 1];
                const temp = latestTemp.data.value;
                
                // 體溫穩定性評分
                if (temp >= 36.0 && temp <= 37.2) temperatureStability = 90;
                else if (temp >= 35.5 && temp <= 37.5) temperatureStability = 70;
                else if (temp >= 35.0 && temp <= 38.0) temperatureStability = 50;
                else temperatureStability = 30;
            }
            
            // 數據完整性評分
            const totalPossibleRecords = 3; // 血壓、血氧、體溫
            const actualRecords = (bpRecords.length > 0 ? 1 : 0) + 
                                 (spo2Records.length > 0 ? 1 : 0) + 
                                 (tempRecords.length > 0 ? 1 : 0);
            dataCompleteness = (actualRecords / totalPossibleRecords) * 100;
            
            // 代謝健康基於血壓和體溫綜合評估
            metabolicHealth = (cardiovascularHealth + temperatureStability) / 2;
            
            return {
                labels: ['心血管健康', '代謝健康', '呼吸健康', '體溫穩定性', '數據完整性'],
                datasets: [{
                    label: '當前狀態',
                    data: [cardiovascularHealth, metabolicHealth, respiratoryHealth, temperatureStability, dataCompleteness],
                    borderColor: '#3498db',
                    backgroundColor: '#3498db40',
                    pointBackgroundColor: '#3498db',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: '#3498db'
                }, {
                    label: '目標狀態',
                    data: [85, 85, 85, 85, 100],
                    borderColor: '#e74c3c',
                    backgroundColor: '#e74c3c20',
                    pointBackgroundColor: '#e74c3c',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: '#e74c3c'
                }]
            };
        }

        // 更新多维度图表
        function updateMultiDimensionChart() {
            const ctx = document.getElementById('multi-dimension-chart');
            if (!ctx) return;

            // 銷毀現有圖表
            if (window.chartInstances && window.chartInstances['multi-dimension-chart']) {
                window.chartInstances['multi-dimension-chart'].destroy();
            }

            // 獲取時間範圍
            const timeRange = document.getElementById('multi-dimension-time-range')?.value || '1week';
            
            // 獲取真實數據
            const records = getDataByTimeRange(timeRange);
            const chartData = processMultiDimensionData(records);
            
            window.chartInstances = window.chartInstances || {};
            window.chartInstances['multi-dimension-chart'] = new Chart(ctx, {
                type: 'radar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `多維度健康指標對比 (${getTimeRangeText(timeRange)})`
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20,
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // 更新所有圖表
        function updateAllCharts() {
            try {
                updateTrendChart();
                updateCorrelationChart();
                updateMultiDimensionChart();
            } catch (error) {
                console.error('更新圖表失敗:', error);
            }
        }

        // 增强的DeepSeek API调用
        async function callDeepSeekAPI(prompt, systemPrompt = null) {
            try {
                const response = await fetch('http://localhost:3000/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${DEEPSEEK_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            ...(systemPrompt ? [{ role: 'system', content: systemPrompt }] : []),
                            { role: 'user', content: prompt }
                        ],
                        temperature: 0.7,
                        max_tokens: 2000,
                        stream: false
                    })
                });

                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error('DeepSeek API调用失败:', error);
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    throw new Error('网络连接失败，请确保代理服务器正在运行 (npm start)');
                } else if (error.message.includes('Failed to fetch')) {
                    throw new Error('无法连接到代理服务器，请检查服务器状态');
                }
                throw error;
            }
        }

        // 生成专业健康报告
        async function generateProfessionalHealthReport() {
            try {
                // 收集用户健康数据
                const healthData = collectHealthData();
                
                // 检查数据完整性
                const missingData = checkDataCompleteness(healthData);
                if (missingData.length > 0) {
                    const userConfirm = confirm(`以下数据缺失，可能影响评估准确性：\n${missingData.join('\n')}\n\n是否继续生成报告？`);
                    if (!userConfirm) return;
                }
                
                // 构建专业提示词
                const systemPrompt = `你是一位专业的健康管理专家，具有丰富的临床经验和医学知识。请基于提供的健康数据，生成一份专业、详细、个性化的健康分析报告。报告应该包括：
1. 健康状态评估
2. 风险因素分析
3. 个性化建议
4. 生活方式指导
5. 医疗建议

请使用专业医学术语，但确保内容易于理解。`;
                
                const currentDate = new Date().toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
                
                // 调试信息：打印传递给AI的数据
                console.log('传递给AI的健康数据:', healthData);
                console.log('医疗史状态:', {
                    diabetes: healthData.diabetes,
                    hypertension: healthData.hypertension,
                    heartDisease: healthData.heartDisease
                });
                console.log('生活方式状态:', {
                    smoking: healthData.smoking,
                    exercise: healthData.exercise
                });

                const userPrompt = `请基于以下健康数据生成专业健康报告：

报告生成日期：${currentDate}

用户基本信息：
- 年龄: ${healthData.age || '未提供'}
- 性别: ${healthData.gender || '未提供'}

基础健康指标：
- 身高: ${healthData.height ? `${healthData.height} cm` : '未提供'}
- 体重: ${healthData.weight ? `${healthData.weight} kg` : '未提供'}
- BMI: ${healthData.bmi ? `${healthData.bmi} (${getBMICategory(healthData.bmi)})` : '未计算'}
- 血压: ${healthData.bloodPressure?.systolic && healthData.bloodPressure?.diastolic ? 
    `${healthData.bloodPressure.systolic}/${healthData.bloodPressure.diastolic} mmHg (来自智能设备)` : '未测量 - 请使用智能设备数据录入功能'}
- 血糖: ${healthData.glucose || '未测量'}
- 心率: ${healthData.heartRate || '未测量'}

智能设备监测数据：
${healthData.deviceData.bloodPressure ? `
- 最新血压数据 (${healthData.deviceData.bloodPressure.time}):
  * 收缩压: ${healthData.deviceData.bloodPressure.systolic} mmHg
  * 舒张压: ${healthData.deviceData.bloodPressure.diastolic} mmHg
  * 脉搏: ${healthData.deviceData.bloodPressure.pulse} bpm
  * 评估: ${healthData.deviceData.bloodPressure.assessment.level} - ${healthData.deviceData.bloodPressure.assessment.advice}` : ''}
${healthData.deviceData.spO2 ? `
- 最新血氧数据 (${healthData.deviceData.spO2.time}):
  * 血氧饱和度: ${healthData.deviceData.spO2.percent}%
  * 灌注指数: ${healthData.deviceData.spO2.pi}%
  * 脉搏率: ${healthData.deviceData.spO2.pr} bpm
  * 评估: ${healthData.deviceData.spO2.assessment.level} - ${healthData.deviceData.spO2.assessment.advice}` : ''}
${healthData.deviceData.temperature ? `
- 最新体温数据 (${healthData.deviceData.temperature.time}):
  * 体温: ${healthData.deviceData.temperature.value}°C
  * 测量部位: ${healthData.deviceData.temperature.location}
  * 评估: ${healthData.deviceData.temperature.assessment.level} - ${healthData.deviceData.temperature.assessment.advice}` : ''}

医疗史：
- 糖尿病: ${healthData.diabetes ? '是' : '否'}
- 高血压: ${healthData.hypertension ? '是' : '否'}
- 心脏病: ${healthData.heartDisease ? '是' : '否'}

生活方式：
- 吸烟: ${healthData.smoking ? '是' : '否'}
- 规律运动: ${healthData.exercise ? '是' : '否'}
- 运动频率: ${healthData.exerciseFrequency || '未提供'}

请基于以上数据生成一份详细的健康分析报告，特别关注：
1. 智能设备数据的趋势分析
2. 各项指标的综合评估
3. 基于实际监测数据的个性化建议
4. 生活方式改进建议
5. 医疗建议和注意事项

报告应该专业、详细且易于理解。`;

                // 使用科學健康評估模型
                const scientificReport = await scientificAssessment.generateComprehensiveAssessment(healthData);
                
                // 调用DeepSeek API
                const aiReport = await callDeepSeekAPI(userPrompt, systemPrompt);
                
                // 合併科學評估和AI報告
                const combinedReport = {
                    professionalAssessment: scientificReport,
                    aiAnalysis: aiReport,
                    timestamp: new Date().toISOString()
                };
                
                // 显示报告
                displayProfessionalHealthReport(combinedReport);
                
                return report;
            } catch (error) {
                console.error('生成健康报告失败:', error);
                FeedbackSystem.showError('生成健康报告失败: ' + error.message);
                throw error;
            }
        }

        // 获取BMI分类
        function getBMICategory(bmi) {
            if (!bmi) return '未计算';
            const bmiValue = parseFloat(bmi);
            if (bmiValue < 18.5) return '偏瘦';
            if (bmiValue < 24) return '正常';
            if (bmiValue < 28) return '偏胖';
            return '肥胖';
        }

        // BMI自动计算函数
        function calculateBMI() {
            const height = parseFloat(document.getElementById('assessment-height')?.value);
            const weight = parseFloat(document.getElementById('assessment-weight')?.value);
            const bmiInput = document.getElementById('assessment-bmi');
            const bmiCategory = document.getElementById('bmi-category');
            
            if (height && weight && height > 0 && weight > 0) {
                // BMI = 体重(kg) / 身高(m)²
                const heightInMeters = height / 100;
                const bmi = weight / (heightInMeters * heightInMeters);
                
                // 设置BMI值（保留1位小数）
                bmiInput.value = bmi.toFixed(1);
                
                // 显示BMI分类
                let category = '';
                let categoryColor = '';
                
                if (bmi < 18.5) {
                    category = '偏瘦';
                    categoryColor = 'text-blue-600';
                } else if (bmi < 24) {
                    category = '正常';
                    categoryColor = 'text-green-600';
                } else if (bmi < 28) {
                    category = '偏胖';
                    categoryColor = 'text-yellow-600';
                } else {
                    category = '肥胖';
                    categoryColor = 'text-red-600';
                }
                
                bmiCategory.innerHTML = `<span class="${categoryColor} font-medium">BMI分类: ${category}</span>`;
            } else {
                bmiInput.value = '';
                bmiCategory.innerHTML = '';
            }
        }

        // 检查数据完整性
        function checkDataCompleteness(healthData) {
            const missing = [];
            
            if (!healthData.age) missing.push('• 年龄');
            if (!healthData.gender) missing.push('• 性别');
            if (!healthData.bloodPressure?.systolic || !healthData.bloodPressure?.diastolic) {
                missing.push('• 血压数据（建议使用智能设备数据录入）');
            }
            if (!healthData.height || !healthData.weight) missing.push('• 身高和体重（用于计算BMI）');
            if (!healthData.glucose) missing.push('• 血糖值');
            if (!healthData.heartRate) missing.push('• 心率数据');
            if (!healthData.temperature) missing.push('• 体温数据');
            if (!healthData.spO2) missing.push('• 血氧数据');
            
            return missing;
        }

        // 收集健康数据
        function collectHealthData() {
            // 获取智能设备数据
            const deviceData = getLatestDeviceData();
            
            // 验证必要数据
            const age = document.getElementById('assessment-age')?.value;
            const gender = document.getElementById('assessment-gender')?.value;
            
            if (!age || !gender) {
                throw new Error('请填写年龄和性别信息');
            }
            
            const healthData = {
                age: document.getElementById('assessment-age')?.value || null,
                gender: document.getElementById('assessment-gender')?.value || null,
                bloodPressure: {
                    systolic: deviceData.bloodPressure?.systolic || null,
                    diastolic: deviceData.bloodPressure?.diastolic || null,
                    pulse: deviceData.bloodPressure?.pulse || null
                },
                height: document.getElementById('assessment-height')?.value || null,
                weight: document.getElementById('assessment-weight')?.value || null,
                bmi: document.getElementById('assessment-bmi')?.value || null,
                glucose: document.getElementById('assessment-glucose')?.value || null,
                heartRate: deviceData.heartRate || null,
                temperature: deviceData.temperature || null,
                spO2: deviceData.spO2 || null,
                diabetes: document.getElementById('history-diabetes')?.checked || false,
                hypertension: document.getElementById('history-hypertension')?.checked || false,
                heartDisease: document.getElementById('history-heart')?.checked || false,
                smoking: document.getElementById('lifestyle-smoking')?.checked || false,
                exercise: document.getElementById('lifestyle-exercise')?.checked || false,
                exerciseFrequency: null, // 可以添加运动频率选择
                deviceData: deviceData // 包含所有智能设备数据
            };
            
            // 调试信息：打印收集到的数据
            console.log('收集到的健康数据:', healthData);
            console.log('医疗史数据:', {
                diabetes: healthData.diabetes,
                hypertension: healthData.hypertension,
                heartDisease: healthData.heartDisease
            });
            console.log('生活方式数据:', {
                smoking: healthData.smoking,
                exercise: healthData.exercise,
                exerciseFrequency: healthData.exerciseFrequency
            });
            
            return healthData;
        }

        // 获取最新的智能设备数据
        function getLatestDeviceData() {
            const healthRecords = JSON.parse(localStorage.getItem('healthRecords') || '[]');
            const deviceRecords = healthRecords.filter(record => record.device);
            
            const latestData = {
                bloodPressure: null,
                heartRate: null,
                temperature: null,
                spO2: null,
                lastUpdate: null
            };
            
            // 获取最新的血压数据
            const bpRecords = deviceRecords.filter(record => record.type === '血压' || record.type === '血壓').sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            if (bpRecords.length > 0) {
                const latestBP = bpRecords[0];
                latestData.bloodPressure = {
                    systolic: latestBP.data.systolic,
                    diastolic: latestBP.data.diastolic,
                    pulse: latestBP.data.pulse,
                    assessment: latestBP.data.assessment,
                    time: latestBP.time
                };
                latestData.heartRate = latestBP.data.pulse;
                latestData.lastUpdate = latestBP.timestamp;
            }
            
            // 获取最新的血氧数据
            const spo2Records = deviceRecords.filter(record => record.type === '血氧').sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            if (spo2Records.length > 0) {
                const latestSpO2 = spo2Records[0];
                latestData.spO2 = {
                    percent: latestSpO2.data.percent,
                    pi: latestSpO2.data.pi,
                    pr: latestSpO2.data.pr,
                    assessment: latestSpO2.data.assessment,
                    time: latestSpO2.time
                };
                if (!latestData.heartRate) {
                    latestData.heartRate = latestSpO2.data.pr;
                }
                if (!latestData.lastUpdate || new Date(latestSpO2.timestamp) > new Date(latestData.lastUpdate)) {
                    latestData.lastUpdate = latestSpO2.timestamp;
                }
            }
            
            // 获取最新的体温数据
            const tempRecords = deviceRecords.filter(record => record.type === '体温' || record.type === '體溫').sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            if (tempRecords.length > 0) {
                const latestTemp = tempRecords[0];
                latestData.temperature = {
                    value: latestTemp.data.value,
                    location: latestTemp.data.location,
                    assessment: latestTemp.data.assessment,
                    time: latestTemp.time
                };
                if (!latestData.lastUpdate || new Date(latestTemp.timestamp) > new Date(latestData.lastUpdate)) {
                    latestData.lastUpdate = latestTemp.timestamp;
                }
            }
            
            return latestData;
        }

        // 显示健康报告
        function displayHealthReport(report) {
            const reportDiv = document.getElementById('health-report');
            if (!reportDiv) return;
            
            const currentDate = new Date().toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            
            const currentTime = new Date().toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            reportDiv.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border border-blue-200">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <i class="fa fa-file-text-o text-2xl text-blue-600 mr-3"></i>
                                <h4 class="text-xl font-bold text-blue-800">AI专业健康分析报告</h4>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-blue-600 font-medium">${currentDate}</p>
                                <p class="text-xs text-blue-500">生成时间: ${currentTime}</p>
                            </div>
                        </div>
                        <div class="prose prose-blue max-w-none">
                            ${formatReportContent(report)}
                        </div>
                        <div class="mt-4 pt-4 border-t border-blue-200">
                            <div class="flex items-center justify-between">
                                <p class="text-sm text-blue-600">
                                    <i class="fa fa-info-circle mr-1"></i>
                                    本报告由DeepSeek AI生成，仅供参考，不能替代专业医疗建议
                                </p>
                                <p class="text-xs text-blue-500">
                                    <i class="fa fa-clock-o mr-1"></i>
                                    报告ID: ${Date.now().toString().slice(-6)}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 格式化报告内容
        function formatReportContent(report) {
            // 将报告内容格式化为HTML
            return report
                .replace(/\n\n/g, '</p><p class="mb-4">')
                .replace(/\n/g, '<br>')
                .replace(/^/, '<p class="mb-4">')
                .replace(/$/, '</p>')
                .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-blue-800">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em class="italic text-blue-700">$1</em>')
                .replace(/^(\d+\.\s)/gm, '<span class="font-semibold text-blue-800">$1</span>');
        }

        // 显示专业健康报告
        function displayProfessionalHealthReport(combinedReport) {
            const reportContainer = document.getElementById('health-report');
            if (!reportContainer) return;
            
            // 防御性编程：确保数据存在
            if (!combinedReport) {
                reportContainer.innerHTML = '<div class="text-center text-red-500">报告数据不可用</div>';
                return;
            }
            
            const { professionalAssessment, aiAnalysis } = combinedReport;
            
            // 检查专业评估数据是否存在
            if (!professionalAssessment) {
                reportContainer.innerHTML = '<div class="text-center text-red-500">专业评估数据不可用</div>';
                return;
            }
            
            reportContainer.innerHTML = `
                <div class="space-y-6">
                    <!-- 專業評估概覽 -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border border-blue-200">
                        <h3 class="text-lg font-semibold text-blue-800 mb-4">專業健康評估概覽</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600">${professionalAssessment.compositeScore?.score || 'N/A'}</div>
                                <div class="text-sm text-blue-700">綜合評分</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-${getRiskColor(professionalAssessment.riskStratification?.category || 'unknown')}">${professionalAssessment.riskStratification?.category || '未知'}</div>
                                <div class="text-sm text-gray-700">風險分層</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600">${professionalAssessment.compositeScore?.confidence || 'N/A'}%</div>
                                <div class="text-sm text-gray-700">評估置信度</div>
                            </div>
                        </div>
                    </div>

                    <!-- 子模型評估 -->
                    <div class="bg-white p-6 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">子模型評估結果</h3>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-red-50 rounded">
                                <span class="font-medium text-red-800">血壓穩定性</span>
                                <span class="text-sm text-red-700">${professionalAssessment.subModelAssessments?.bloodPressureStability?.assessment || '無數據'}</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-green-50 rounded">
                                <span class="font-medium text-green-800">血氧灌注</span>
                                <span class="text-sm text-green-700">${professionalAssessment.subModelAssessments?.bloodOxygenPerfusion?.assessment || '無數據'}</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-orange-50 rounded">
                                <span class="font-medium text-orange-800">體溫-脈搏協同</span>
                                <span class="text-sm text-orange-700">${professionalAssessment.subModelAssessments?.temperaturePulseSynergy?.assessment || '無數據'}</span>
                            </div>
                        </div>
                    </div>

                    <!-- 邏輯推導洞察 -->
                    ${(professionalAssessment.derivedInsights?.insights || []).length > 0 ? `
                    <div class="bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                        <h3 class="text-lg font-semibold text-yellow-800 mb-4">邏輯推導洞察</h3>
                        <div class="space-y-3">
                            ${(professionalAssessment.derivedInsights?.insights || []).map(insight => `
                                <div class="p-3 bg-white rounded border-l-4 border-yellow-400">
                                    <div class="font-medium text-gray-800">${insight.insight}</div>
                                    <div class="text-sm text-gray-600 mt-1">置信度: ${insight.confidence} | ${insight.recommendation}</div>
                                    <div class="text-xs text-gray-500 mt-1">參考: ${insight.reference}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- 個性化建議 -->
                    <div class="bg-green-50 p-6 rounded-lg border border-green-200">
                        <h3 class="text-lg font-semibold text-green-800 mb-4">個性化建議</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-medium text-green-700 mb-2">立即建議</h4>
                                <ul class="text-sm text-gray-700 space-y-1">
                                    ${(professionalAssessment.personalizedRecommendations?.immediate || []).map(rec => `<li>• ${rec}</li>`).join('')}
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-medium text-green-700 mb-2">生活方式</h4>
                                <ul class="text-sm text-gray-700 space-y-1">
                                    ${(professionalAssessment.personalizedRecommendations?.lifestyle || []).map(rec => `<li>• ${rec}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 數據限制說明 -->
                    <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">評估限制說明</h3>
                        <div class="text-sm text-gray-700">
                            <p class="mb-2"><strong>數據限制：</strong></p>
                            <ul class="list-disc list-inside space-y-1 mb-4">
                                ${(professionalAssessment.dataLimitations || []).map(limitation => `<li>${limitation}</li>`).join('')}
                            </ul>
                            <p class="mb-2"><strong>算法透明度：</strong></p>
                            <ul class="list-disc list-inside space-y-1">
                                ${(professionalAssessment.algorithmTransparency?.limitations || []).map(limitation => `<li>${limitation}</li>`).join('')}
                            </ul>
                        </div>
                    </div>

                    <!-- AI 分析報告 -->
                    <div class="bg-white p-6 rounded-lg border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">AI 深度分析</h3>
                        <div class="prose max-w-none">
                            <pre class="whitespace-pre-wrap text-sm text-gray-700 leading-relaxed">${aiAnalysis}</pre>
                        </div>
                    </div>
                </div>
            `;
        }

        // 獲取風險顏色
        function getRiskColor(riskCategory) {
            const colors = {
                'low': 'green-600',
                'moderate': 'yellow-600',
                'high': 'orange-600',
                'very_high': 'red-600'
            };
            return colors[riskCategory] || 'gray-600';
        }

        // 智能健康问答
        async function askHealthQuestion(question) {
            try {
                const systemPrompt = `你是一位专业的健康顾问，请基于医学知识和最佳实践回答用户的健康问题。回答应该：
1. 准确、专业
2. 易于理解
3. 包含实用建议
4. 提醒用户必要时咨询医生

请用中文回答，保持专业但友好的语调。`;
                
                const response = await callDeepSeekAPI(question, systemPrompt);
                return response;
            } catch (error) {
                console.error('健康问答失败:', error);
                throw error;
            }
        }

        // 打开AI健康助手
        function openAIHealthAssistant() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">AI健康助手</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                            <i class="fa fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-2">常见健康问题</h4>
                            <div class="grid grid-cols-1 gap-2">
                                <button onclick="askQuickQuestion('如何预防高血压？')" class="text-left p-2 bg-white rounded hover:bg-blue-50 transition-colors">
                                    <i class="fa fa-heart text-red-500 mr-2"></i>如何预防高血压？
                                </button>
                                <button onclick="askQuickQuestion('糖尿病患者应该注意什么？')" class="text-left p-2 bg-white rounded hover:bg-blue-50 transition-colors">
                                    <i class="fa fa-tint text-blue-500 mr-2"></i>糖尿病患者应该注意什么？
                                </button>
                                <button onclick="askQuickQuestion('老年人如何保持健康？')" class="text-left p-2 bg-white rounded hover:bg-blue-50 transition-colors">
                                    <i class="fa fa-user text-green-500 mr-2"></i>老年人如何保持健康？
                                </button>
                                <button onclick="askQuickQuestion('如何改善睡眠质量？')" class="text-left p-2 bg-white rounded hover:bg-blue-50 transition-colors">
                                    <i class="fa fa-moon text-purple-500 mr-2"></i>如何改善睡眠质量？
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">或者输入您的问题：</label>
                            <div class="flex space-x-2">
                                <input type="text" id="health-question-input" placeholder="请输入您的健康问题..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button onclick="askCustomQuestion()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    <i class="fa fa-paper-plane mr-1"></i>提问
                                </button>
                            </div>
                        </div>
                        
                        <div id="ai-response" class="hidden">
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <h4 class="font-semibold text-green-800 mb-2">AI回答：</h4>
                                <div id="response-content" class="text-green-700"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // 快速问题
        async function askQuickQuestion(question) {
            const responseDiv = document.getElementById('ai-response');
            const contentDiv = document.getElementById('response-content');
            
            if (!responseDiv || !contentDiv) return;
            
            responseDiv.classList.remove('hidden');
            contentDiv.innerHTML = '<div class="flex items-center"><div class="animate-spin rounded-full h-4 w-4 border-b-2 border-green-600 mr-2"></div>AI正在思考...</div>';
            
            try {
                const response = await askHealthQuestion(question);
                contentDiv.innerHTML = formatReportContent(response);
            } catch (error) {
                contentDiv.innerHTML = `<div class="text-red-600">抱歉，AI助手暂时无法回答您的问题。请稍后再试。</div>`;
            }
        }

        // 自定义问题
        async function askCustomQuestion() {
            const input = document.getElementById('health-question-input');
            const question = input?.value?.trim();
            
            if (!question) {
                FeedbackSystem.showError('请输入您的问题');
                return;
            }
            
            await askQuickQuestion(question);
            input.value = '';
        }

        // 设置面板功能
        function showSettingsPanel() {
            const panel = document.getElementById('settings-panel');
            if (panel) {
                panel.classList.remove('hidden');
                loadSettingsState();
            }
        }

        function closeSettingsPanel() {
            const panel = document.getElementById('settings-panel');
            if (panel) {
                panel.classList.add('hidden');
            }
        }

        function loadSettingsState() {
            // 加载主题状态
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            updateToggleState('theme-toggle', isDarkMode);
            
            // 加载自动主题状态
            const isAutoTheme = localStorage.getItem('autoTheme') === 'true';
            updateToggleState('auto-theme-toggle', isAutoTheme);
            
            // 加载通知设置
            const medicationReminder = localStorage.getItem('medicationReminder') !== 'false';
            updateToggleState('medication-reminder-toggle', medicationReminder);
            
            const examReminder = localStorage.getItem('examReminder') !== 'false';
            updateToggleState('exam-reminder-toggle', examReminder);
            
            const reportReminder = localStorage.getItem('reportReminder') !== 'false';
            updateToggleState('report-reminder-toggle', reportReminder);
        }

        function initTheme() {
            // 初始化主题
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            const isAutoTheme = localStorage.getItem('autoTheme') === 'true';
            
            if (isAutoTheme) {
                // 自动主题：根据时间切换
                const hour = new Date().getHours();
                const shouldUseDarkMode = hour < 6 || hour >= 18;
                
                if (shouldUseDarkMode) {
                    document.body.classList.remove('light-mode');
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                    document.body.classList.add('light-mode');
                }
            } else {
                // 手动主题
                if (isDarkMode) {
                    document.body.classList.remove('light-mode');
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                    document.body.classList.add('light-mode');
                }
            }
        }

        function checkAutoTheme() {
            const isAutoTheme = localStorage.getItem('autoTheme') === 'true';
            
            if (isAutoTheme) {
                const hour = new Date().getHours();
                const shouldUseDarkMode = hour < 6 || hour >= 18;
                const isCurrentlyDark = document.body.classList.contains('dark-mode');
                
                if (shouldUseDarkMode && !isCurrentlyDark) {
                    document.body.classList.remove('light-mode');
                    document.body.classList.add('dark-mode');
                } else if (!shouldUseDarkMode && isCurrentlyDark) {
                    document.body.classList.remove('dark-mode');
                    document.body.classList.add('light-mode');
                }
            }
        }

        function updateToggleState(toggleId, isOn) {
            const toggle = document.getElementById(toggleId);
            if (!toggle) return;
            
            const span = toggle.querySelector('span');
            if (isOn) {
                toggle.classList.remove('bg-gray-200');
                toggle.classList.add('bg-blue-600');
                span.classList.remove('translate-x-1');
                span.classList.add('translate-x-6');
            } else {
                toggle.classList.remove('bg-blue-600');
                toggle.classList.add('bg-gray-200');
                span.classList.remove('translate-x-6');
                span.classList.add('translate-x-1');
            }
        }

        function toggleTheme() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            const newDarkMode = !isDarkMode;
            
            localStorage.setItem('darkMode', newDarkMode.toString());
            updateToggleState('theme-toggle', newDarkMode);
            
            // 应用主题
            if (newDarkMode) {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
            }
            
            FeedbackSystem.showSuccess(newDarkMode ? '已切换到深色模式' : '已切换到浅色模式');
        }

        function toggleAutoTheme() {
            const isAutoTheme = localStorage.getItem('autoTheme') === 'true';
            const newAutoTheme = !isAutoTheme;
            
            localStorage.setItem('autoTheme', newAutoTheme.toString());
            updateToggleState('auto-theme-toggle', newAutoTheme);
            
            // 如果启用自动主题，立即应用
            if (newAutoTheme) {
                const hour = new Date().getHours();
                const shouldUseDarkMode = hour < 6 || hour >= 18;
                
                if (shouldUseDarkMode) {
                    document.body.classList.remove('light-mode');
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                    document.body.classList.add('light-mode');
                }
            } else {
                // 如果禁用自动主题，使用手动设置
                const isDarkMode = localStorage.getItem('darkMode') === 'true';
                if (isDarkMode) {
                    document.body.classList.remove('light-mode');
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                    document.body.classList.add('light-mode');
                }
            }
            
            FeedbackSystem.showSuccess(newAutoTheme ? '已启用自动主题切换' : '已禁用自动主题切换');
        }

        function toggleMedicationReminder() {
            const isEnabled = localStorage.getItem('medicationReminder') !== 'false';
            const newState = !isEnabled;
            
            localStorage.setItem('medicationReminder', newState.toString());
            updateToggleState('medication-reminder-toggle', newState);
            
            FeedbackSystem.showSuccess(newState ? '已启用用药提醒' : '已禁用用药提醒');
        }

        function toggleExamReminder() {
            const isEnabled = localStorage.getItem('examReminder') !== 'false';
            const newState = !isEnabled;
            
            localStorage.setItem('examReminder', newState.toString());
            updateToggleState('exam-reminder-toggle', newState);
            
            FeedbackSystem.showSuccess(newState ? '已启用体检提醒' : '已禁用体检提醒');
        }

        function toggleReportReminder() {
            const isEnabled = localStorage.getItem('reportReminder') !== 'false';
            const newState = !isEnabled;
            
            localStorage.setItem('reportReminder', newState.toString());
            updateToggleState('report-reminder-toggle', newState);
            
            FeedbackSystem.showSuccess(newState ? '已启用健康报告提醒' : '已禁用健康报告提醒');
        }

        function exportHealthData() {
            try {
                // 收集所有健康数据
                const healthData = {
                    medications: JSON.parse(localStorage.getItem('medications') || '[]'),
                    appointments: JSON.parse(localStorage.getItem('appointments') || '[]'),
                    healthRecords: JSON.parse(localStorage.getItem('healthRecords') || '[]'),
                    exerciseRecords: JSON.parse(localStorage.getItem('exerciseRecords') || '[]'),
                    dietRecords: JSON.parse(localStorage.getItem('dietRecords') || '[]'),
                    healthGoals: JSON.parse(localStorage.getItem('healthGoals') || '[]'),
                    exportDate: new Date().toISOString(),
                    version: '2.1.0'
                };
                
                // 创建下载链接
                const dataStr = JSON.stringify(healthData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `health-data-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                FeedbackSystem.showSuccess('健康数据导出成功');
            } catch (error) {
                console.error('导出失败:', error);
                FeedbackSystem.showError('导出失败: ' + error.message);
            }
        }

        function importHealthData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // 验证数据格式
                        if (!data.version || !data.exportDate) {
                            throw new Error('无效的数据文件格式');
                        }
                        
                        // 导入数据
                        if (data.medications) localStorage.setItem('medications', JSON.stringify(data.medications));
                        if (data.appointments) localStorage.setItem('appointments', JSON.stringify(data.appointments));
                        if (data.healthRecords) localStorage.setItem('healthRecords', JSON.stringify(data.healthRecords));
                        if (data.exerciseRecords) localStorage.setItem('exerciseRecords', JSON.stringify(data.exerciseRecords));
                        if (data.dietRecords) localStorage.setItem('dietRecords', JSON.stringify(data.dietRecords));
                        if (data.healthGoals) localStorage.setItem('healthGoals', JSON.stringify(data.healthGoals));
                        
                        FeedbackSystem.showSuccess('健康数据导入成功');
                    } catch (error) {
                        console.error('导入失败:', error);
                        FeedbackSystem.showError('导入失败: ' + error.message);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        function clearAllData() {
            if (confirm('确定要清除所有健康数据吗？此操作不可恢复！')) {
                try {
                    // 清除所有健康数据
                    localStorage.removeItem('medications');
                    localStorage.removeItem('appointments');
                    localStorage.removeItem('healthRecords');
                    localStorage.removeItem('exerciseRecords');
                    localStorage.removeItem('dietRecords');
                    localStorage.removeItem('healthGoals');
                    
                    FeedbackSystem.showSuccess('所有健康数据已清除');
                } catch (error) {
                    console.error('清除失败:', error);
                    FeedbackSystem.showError('清除失败: ' + error.message);
                }
            }
        }

        // 设备数据录入功能
        let currentDeviceTab = 'bp';

        function switchDeviceTab(device) {
            currentDeviceTab = device;
            
            // 更新标签页样式
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
                tab.classList.add('text-gray-600');
            });
            
            const activeTab = document.getElementById(`tab-${device}`);
            if (activeTab) {
                activeTab.classList.remove('text-gray-600');
                activeTab.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
            }
            
            // 显示对应的设备表单
            document.querySelectorAll('.device-form').forEach(form => {
                form.classList.add('hidden');
            });
            
            const activeForm = document.getElementById(`device-${device}`);
            if (activeForm) {
                activeForm.classList.remove('hidden');
            }
        }

        function addDeviceData() {
            const time = document.getElementById('device-time')?.value || new Date().toISOString().slice(0, 16);
            const notes = document.getElementById('device-notes')?.value || '';
            
            let deviceData = null;
            
            switch (currentDeviceTab) {
                case 'bp':
                    deviceData = addBloodPressureData(time, notes);
                    break;
                case 'spo2':
                    deviceData = addSpO2Data(time, notes);
                    break;
                case 'temp':
                    deviceData = addTemperatureData(time, notes);
                    break;
            }
            
            if (deviceData) {
                // 保存到本地存储
                const healthRecords = JSON.parse(localStorage.getItem('healthRecords') || '[]');
                healthRecords.push(deviceData);
                localStorage.setItem('healthRecords', JSON.stringify(healthRecords));
                
                // 清空表单
                clearDeviceForm();
                
                // 實時更新圖表
                updateAllCharts();
                
                FeedbackSystem.showSuccess('设备数据保存成功');
            }
        }

        // 批量保存功能
        let batchSaveData = [];

        function addToBatchSave(deviceType) {
            const time = document.getElementById('device-time')?.value || new Date().toISOString().slice(0, 16);
            const notes = document.getElementById('device-notes')?.value || '';
            
            let deviceData = null;
            
            switch (deviceType) {
                case 'bp':
                    deviceData = addBloodPressureData(time, notes);
                    break;
                case 'spo2':
                    deviceData = addSpO2Data(time, notes);
                    break;
                case 'temp':
                    deviceData = addTemperatureData(time, notes);
                    break;
            }
            
            if (deviceData) {
                // 添加到批量保存列表
                batchSaveData.push(deviceData);
                updateBatchSaveDisplay();
                FeedbackSystem.showSuccess(`${getDeviceTypeName(deviceType)}數據已添加到批量保存`);
            }
        }

        function getDeviceTypeName(deviceType) {
            const names = {
                'bp': '血壓',
                'spo2': '血氧',
                'temp': '體溫'
            };
            return names[deviceType] || deviceType;
        }

        function updateBatchSaveDisplay() {
            const batchArea = document.getElementById('batch-save-area');
            const batchCount = document.getElementById('batch-count');
            const batchItems = document.getElementById('batch-items');
            
            if (batchSaveData.length > 0) {
                batchArea.classList.remove('hidden');
                batchCount.textContent = batchSaveData.length;
                
                batchItems.innerHTML = batchSaveData.map((item, index) => `
                    <div class="flex items-center justify-between bg-white p-2 rounded border">
                        <div class="flex items-center">
                            <i class="fa fa-${getDeviceIcon(item.type)} text-${getDeviceColor(item.type)}-500 mr-2"></i>
                            <span class="text-sm font-medium">${item.type} - ${item.time}</span>
                        </div>
                        <button onclick="removeFromBatch(${index})" class="text-red-500 hover:text-red-700">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                `).join('');
            } else {
                batchArea.classList.add('hidden');
            }
        }

        function getDeviceIcon(type) {
            const icons = {
                '血压': 'heartbeat',
                '血氧': 'tint',
                '体温': 'thermometer-half'
            };
            return icons[type] || 'circle';
        }

        function getDeviceColor(type) {
            const colors = {
                '血压': 'red',
                '血氧': 'green',
                '体温': 'orange'
            };
            return colors[type] || 'gray';
        }

        function removeFromBatch(index) {
            batchSaveData.splice(index, 1);
            updateBatchSaveDisplay();
        }

        function clearBatchSave() {
            batchSaveData = [];
            updateBatchSaveDisplay();
            FeedbackSystem.showSuccess('批量保存列表已清空');
        }

        function saveBatchData() {
            if (batchSaveData.length === 0) {
                FeedbackSystem.showError('批量保存列表為空');
                return;
            }
            
            try {
                const savedCount = batchSaveData.length;
                
                // 保存所有數據到本地存儲
                const healthRecords = JSON.parse(localStorage.getItem('healthRecords') || '[]');
                healthRecords.push(...batchSaveData);
                localStorage.setItem('healthRecords', JSON.stringify(healthRecords));
                
                // 清空批量保存列表
                batchSaveData = [];
                updateBatchSaveDisplay();
                
            // 清空表單
            clearDeviceForm();
            
            // 實時更新圖表
            updateAllCharts();
            
            FeedbackSystem.showSuccess(`成功批量保存 ${savedCount} 項設備數據`);
            } catch (error) {
                console.error('批量保存失敗:', error);
                FeedbackSystem.showError('批量保存失敗: ' + error.message);
            }
        }

        function addBloodPressureData(time, notes) {
            const systolic = parseInt(document.getElementById('bp-systolic')?.value);
            const diastolic = parseInt(document.getElementById('bp-diastolic')?.value);
            const pulse = parseInt(document.getElementById('bp-pulse')?.value);
            
            if (!systolic || !diastolic || !pulse) {
                FeedbackSystem.showError('请填写完整的血压数据');
                return null;
            }
            
            const assessment = assessBloodPressure(systolic, diastolic);
            
            return {
                id: Date.now(),
                type: '血压',
                device: '血压计',
                data: {
                    systolic: systolic,
                    diastolic: diastolic,
                    pulse: pulse,
                    assessment: assessment
                },
                time: time,
                notes: notes,
                timestamp: new Date().toISOString()
            };
        }

        function addSpO2Data(time, notes) {
            const percent = parseFloat(document.getElementById('spo2-percent')?.value);
            const pi = parseFloat(document.getElementById('spo2-pi')?.value);
            const pr = parseInt(document.getElementById('spo2-pr')?.value);
            
            if (!percent || !pi || !pr) {
                FeedbackSystem.showError('请填写完整的血氧数据');
                return null;
            }
            
            const assessment = assessSpO2(percent, pi);
            
            return {
                id: Date.now(),
                type: '血氧',
                device: '血氧计',
                data: {
                    percent: percent,
                    pi: pi,
                    pr: pr,
                    assessment: assessment
                },
                time: time,
                notes: notes,
                timestamp: new Date().toISOString()
            };
        }

        function addTemperatureData(time, notes) {
            const value = parseFloat(document.getElementById('temp-value')?.value);
            const location = document.getElementById('temp-location')?.value;
            
            if (!value || !location) {
                FeedbackSystem.showError('请填写完整的体温数据');
                return null;
            }
            
            const assessment = assessTemperature(value, location);
            
            return {
                id: Date.now(),
                type: '体温',
                device: '温度计',
                data: {
                    value: value,
                    location: location,
                    assessment: assessment
                },
                time: time,
                notes: notes,
                timestamp: new Date().toISOString()
            };
        }

        function assessBloodPressure(systolic, diastolic) {
            if (systolic >= 180 || diastolic >= 110) {
                return { level: '高血压3级', color: 'red', advice: '立即就医' };
            } else if (systolic >= 160 || diastolic >= 100) {
                return { level: '高血压2级', color: 'orange', advice: '建议就医' };
            } else if (systolic >= 140 || diastolic >= 90) {
                return { level: '高血压1级', color: 'yellow', advice: '注意监测' };
            } else if (systolic >= 130 || diastolic >= 85) {
                return { level: '正常高值', color: 'blue', advice: '保持健康' };
            } else if (systolic >= 120 || diastolic >= 80) {
                return { level: '正常', color: 'green', advice: '良好' };
            } else {
                return { level: '理想', color: 'green', advice: '优秀' };
            }
        }

        function assessSpO2(percent, pi) {
            if (percent < 90) {
                return { level: '低氧血症', color: 'red', advice: '立即就医' };
            } else if (percent < 95) {
                return { level: '轻度缺氧', color: 'orange', advice: '注意监测' };
            } else if (percent >= 95 && percent < 98) {
                return { level: '正常', color: 'green', advice: '良好' };
            } else {
                return { level: '理想', color: 'green', advice: '优秀' };
            }
        }

        function assessTemperature(value, location) {
            let normalRange = { min: 36.0, max: 37.2 };
            
            // 根据测量部位调整正常范围
            switch (location) {
                case '口腔':
                    normalRange = { min: 36.3, max: 37.2 };
                    break;
                case '直肠':
                    normalRange = { min: 36.6, max: 37.8 };
                    break;
                case '耳温':
                    normalRange = { min: 36.1, max: 37.5 };
                    break;
                case '额温':
                    normalRange = { min: 35.8, max: 37.0 };
                    break;
            }
            
            if (value < normalRange.min) {
                return { level: '体温偏低', color: 'blue', advice: '注意保暖' };
            } else if (value > 37.5) {
                return { level: '发热', color: 'red', advice: '建议就医' };
            } else if (value > normalRange.max) {
                return { level: '体温偏高', color: 'orange', advice: '注意观察' };
            } else {
                return { level: '正常', color: 'green', advice: '良好' };
            }
        }

        function clearDeviceForm() {
            // 清空当前设备表单
            const currentForm = document.getElementById(`device-${currentDeviceTab}`);
            if (currentForm) {
                const inputs = currentForm.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.type === 'checkbox' || input.type === 'radio') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
            }
            
            // 清空通用信息
            document.getElementById('device-time').value = '';
            document.getElementById('device-notes').value = '';
            
            // 重置评估显示
            document.getElementById('bp-assessment').textContent = '请输入数据';
            document.getElementById('spo2-assessment').textContent = '请输入数据';
            document.getElementById('temp-assessment').textContent = '请输入数据';
        }

        function addHealthRecord() {
            const type = document.getElementById('data-type')?.value;
            const value = document.getElementById('data-value')?.value;
            const time = document.getElementById('data-time')?.value || new Date().toISOString().slice(0, 16);
            const notes = document.getElementById('data-notes')?.value || '';
            
            if (!type || !value) {
                FeedbackSystem.showError('请填写完整的数据信息');
                return;
            }
            
            const record = {
                id: Date.now(),
                type: type,
                value: value,
                time: time,
                notes: notes,
                timestamp: new Date().toISOString()
            };
            
            // 保存到本地存储
            const healthRecords = JSON.parse(localStorage.getItem('healthRecords') || '[]');
            healthRecords.push(record);
            localStorage.setItem('healthRecords', JSON.stringify(healthRecords));
            
            // 清空表单
            document.getElementById('data-type').value = '';
            document.getElementById('data-value').value = '';
            document.getElementById('data-time').value = '';
            document.getElementById('data-notes').value = '';
            
            FeedbackSystem.showSuccess('健康数据添加成功');
        }

        // 实时评估功能
        function initRealTimeAssessment() {
            // 血压实时评估
            ['bp-systolic', 'bp-diastolic', 'bp-pulse'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', updateBloodPressureAssessment);
                }
            });
            
            // 血氧实时评估
            ['spo2-percent', 'spo2-pi', 'spo2-pr'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', updateSpO2Assessment);
                }
            });
            
            // 体温实时评估
            ['temp-value', 'temp-location'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', updateTemperatureAssessment);
                }
            });
        }

        function updateBloodPressureAssessment() {
            const systolic = parseInt(document.getElementById('bp-systolic')?.value);
            const diastolic = parseInt(document.getElementById('bp-diastolic')?.value);
            
            if (systolic && diastolic) {
                const assessment = assessBloodPressure(systolic, diastolic);
                const assessmentEl = document.getElementById('bp-assessment');
                if (assessmentEl) {
                    assessmentEl.textContent = `${assessment.level} - ${assessment.advice}`;
                    assessmentEl.className = `text-sm font-medium ml-2 text-${assessment.color}-800`;
                }
            }
        }

        function updateSpO2Assessment() {
            const percent = parseFloat(document.getElementById('spo2-percent')?.value);
            const pi = parseFloat(document.getElementById('spo2-pi')?.value);
            
            if (percent && pi) {
                const assessment = assessSpO2(percent, pi);
                const assessmentEl = document.getElementById('spo2-assessment');
                if (assessmentEl) {
                    assessmentEl.textContent = `${assessment.level} - ${assessment.advice}`;
                    assessmentEl.className = `text-sm font-medium ml-2 text-${assessment.color}-800`;
                }
            }
        }

        function updateTemperatureAssessment() {
            const value = parseFloat(document.getElementById('temp-value')?.value);
            const location = document.getElementById('temp-location')?.value;
            
            if (value && location) {
                const assessment = assessTemperature(value, location);
                const assessmentEl = document.getElementById('temp-assessment');
                if (assessmentEl) {
                    assessmentEl.textContent = `${assessment.level} - ${assessment.advice}`;
                    assessmentEl.className = `text-sm font-medium ml-2 text-${assessment.color}-800`;
                }
            }
        }

        // 刷新设备统计数据
        function refreshDeviceStats() {
            const statsDiv = document.getElementById('device-stats');
            if (!statsDiv) return;
            
            const healthRecords = JSON.parse(localStorage.getItem('healthRecords') || '[]');
            const deviceRecords = healthRecords.filter(record => record.device);
            
            // 统计数据
            const bpCount = deviceRecords.filter(record => record.type === '血压' || record.type === '血壓').length;
            const spo2Count = deviceRecords.filter(record => record.type === '血氧').length;
            const tempCount = deviceRecords.filter(record => record.type === '体温' || record.type === '體溫').length;
            
            // 获取最新数据
            const latestData = getLatestDeviceData();
            
            statsDiv.innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <div class="flex items-center mb-2">
                        <i class="fa fa-heartbeat text-blue-600 text-xl mr-2"></i>
                        <h4 class="font-semibold text-blue-800">血压数据</h4>
                    </div>
                    <p class="text-2xl font-bold text-blue-900">${bpCount}</p>
                    <p class="text-sm text-blue-600">总记录数</p>
                    ${latestData.bloodPressure ? `
                        <div class="mt-2 pt-2 border-t border-blue-200">
                            <p class="text-xs text-blue-700">最新: ${latestData.bloodPressure.systolic}/${latestData.bloodPressure.diastolic} mmHg</p>
                            <p class="text-xs text-blue-600">${latestData.bloodPressure.time}</p>
                        </div>
                    ` : ''}
                </div>
                
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <div class="flex items-center mb-2">
                        <i class="fa fa-tint text-green-600 text-xl mr-2"></i>
                        <h4 class="font-semibold text-green-800">血氧数据</h4>
                    </div>
                    <p class="text-2xl font-bold text-green-900">${spo2Count}</p>
                    <p class="text-sm text-green-600">总记录数</p>
                    ${latestData.spO2 ? `
                        <div class="mt-2 pt-2 border-t border-green-200">
                            <p class="text-xs text-green-700">最新: ${latestData.spO2.percent}%</p>
                            <p class="text-xs text-green-600">${latestData.spO2.time}</p>
                        </div>
                    ` : ''}
                </div>
                
                <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                    <div class="flex items-center mb-2">
                        <i class="fa fa-thermometer-half text-orange-600 text-xl mr-2"></i>
                        <h4 class="font-semibold text-orange-800">体温数据</h4>
                    </div>
                    <p class="text-2xl font-bold text-orange-900">${tempCount}</p>
                    <p class="text-sm text-orange-600">总记录数</p>
                    ${latestData.temperature ? `
                        <div class="mt-2 pt-2 border-t border-orange-200">
                            <p class="text-xs text-orange-700">最新: ${latestData.temperature.value}°C</p>
                            <p class="text-xs text-orange-600">${latestData.temperature.time}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // 初始化
        function init() {
            console.log('应用初始化');
            
            // 初始化主题
            initTheme();
            
            // 初始化饮食记录历史显示
            setTimeout(() => {
                displayDietHistory();
            }, 1000);
            
            // 初始化动画延迟
            initStaggeredAnimations();
            
            // 显示主页
            showPage('page-home');
            
            // 初始化专业图表
            setTimeout(() => {
                updateTrendChart();
                updateCorrelationChart();
                updateMultiDimensionChart();
            }, 1000);
            
            // 初始化实时评估功能
            setTimeout(() => {
                initRealTimeAssessment();
            }, 1500);
            
            // 初始化设备统计
            setTimeout(() => {
                refreshDeviceStats();
            }, 2000);
            
            // 更新时间
            function updateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                const timeElements = document.querySelectorAll('[id^="real-time"]');
                timeElements.forEach(element => {
                    element.textContent = timeString;
                });
            }
            
            updateTime();
            setInterval(updateTime, 1000);
            
            // 检查自动主题切换（每分钟检查一次）
            setInterval(checkAutoTheme, 60000);
            
            // 添加按钮涟漪效果
            document.querySelectorAll('.ripple').forEach(button => {
                button.addEventListener('click', createRipple);
            });
            
            // 添加输入框验证
            document.querySelectorAll('.input-field').forEach(input => {
                input.addEventListener('invalid', function() {
                    FeedbackSystem.showError('请填写正确的信息');
                });
            });
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
