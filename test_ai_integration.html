<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 集成測試</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">AI 健康助手集成測試</h1>
        
        <!-- 測試數據錄入 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">1. 測試數據錄入</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">血壓收縮壓</label>
                    <input type="number" id="test-systolic" class="w-full p-2 border rounded" placeholder="120" value="120">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">血壓舒張壓</label>
                    <input type="number" id="test-diastolic" class="w-full p-2 border rounded" placeholder="80" value="80">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">脈搏</label>
                    <input type="number" id="test-pulse" class="w-full p-2 border rounded" placeholder="72" value="72">
                </div>
            </div>
            <button onclick="addTestData()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                <i class="fa fa-plus mr-2"></i>添加測試數據
            </button>
        </div>

        <!-- 查看存儲的數據 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">2. 查看存儲的數據</h2>
            <button onclick="showStoredData()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mb-4">
                <i class="fa fa-eye mr-2"></i>顯示存儲數據
            </button>
            <div id="stored-data" class="bg-gray-50 p-4 rounded text-sm font-mono"></div>
        </div>

        <!-- AI 聊天測試 -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">3. AI 聊天測試</h2>
            <div class="mb-4">
                <input type="text" id="test-message" class="w-full p-2 border rounded" placeholder="輸入測試消息，例如：我的血壓正常嗎？" value="我的血壓正常嗎？">
            </div>
            <button onclick="testAIChat()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                <i class="fa fa-robot mr-2"></i>測試 AI 聊天
            </button>
            <div id="ai-response" class="mt-4 bg-gray-50 p-4 rounded"></div>
        </div>
    </div>

    <script>
        // 添加測試數據
        function addTestData() {
            const systolic = parseInt(document.getElementById('test-systolic').value);
            const diastolic = parseInt(document.getElementById('test-diastolic').value);
            const pulse = parseInt(document.getElementById('test-pulse').value);
            
            if (!systolic || !diastolic || !pulse) {
                alert('請填寫完整的血壓數據');
                return;
            }
            
            const deviceData = {
                id: Date.now(),
                type: '血壓',
                device: true,
                time: new Date().toISOString().slice(0, 16),
                notes: '測試數據',
                timestamp: new Date().toISOString(),
                data: {
                    systolic: systolic,
                    diastolic: diastolic,
                    pulse: pulse,
                    assessment: {
                        level: systolic < 120 && diastolic < 80 ? '正常' : '偏高',
                        advice: systolic < 120 && diastolic < 80 ? '血壓正常，請保持良好生活習慣' : '血壓偏高，建議諮詢醫生'
                    }
                }
            };
            
            // 保存到本地存儲
            const healthRecords = JSON.parse(localStorage.getItem('healthRecords') || '[]');
            healthRecords.push(deviceData);
            localStorage.setItem('healthRecords', JSON.stringify(healthRecords));
            
            alert('測試數據添加成功！');
        }
        
        // 顯示存儲的數據
        function showStoredData() {
            const healthRecords = JSON.parse(localStorage.getItem('healthRecords') || '[]');
            const deviceRecords = healthRecords.filter(record => record.device);
            
            document.getElementById('stored-data').innerHTML = 
                `<strong>總記錄數：</strong>${healthRecords.length}<br>
                <strong>設備記錄數：</strong>${deviceRecords.length}<br>
                <strong>詳細數據：</strong><br>
                <pre>${JSON.stringify(deviceRecords, null, 2)}</pre>`;
        }
        
        // 測試 AI 聊天
        async function testAIChat() {
            const message = document.getElementById('test-message').value;
            if (!message) {
                alert('請輸入測試消息');
                return;
            }
            
            document.getElementById('ai-response').innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>正在測試 AI 聊天...';
            
            try {
                // 收集用戶健康數據（使用與 ai_chat.js 相同的邏輯）
                const healthData = collectUserHealthData();
                
                // 構建包含健康數據的消息
                const enhancedMessage = buildEnhancedMessage(message, healthData);
                
                console.log('增強後的消息：', enhancedMessage);
                
                const response = await fetch('http://localhost:3000/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer sk-ef5d339bf70b4f4d8e0657db5ba02d22'
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            { 
                                role: 'system', 
                                content: '你是一位專業的健康管理助手，專門為銀齡用戶提供健康建議。請基於用戶提供的健康數據，給出專業、個性化的健康建議。' 
                            },
                            { role: 'user', content: enhancedMessage }
                        ]
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                document.getElementById('ai-response').innerHTML = 
                    `<strong>AI 回應：</strong><br>${data.choices[0].message.content}`;
                    
            } catch (error) {
                console.error('AI 聊天測試失敗:', error);
                document.getElementById('ai-response').innerHTML = 
                    `<strong>錯誤：</strong>${error.message}`;
            }
        }
        
        // 收集用戶健康數據（複製自 ai_chat.js）
        function collectUserHealthData() {
            try {
                const healthRecords = JSON.parse(localStorage.getItem('healthRecords') || '[]');
                const deviceRecords = healthRecords.filter(record => record.device);
                
                const latestData = {
                    bloodPressure: null,
                    heartRate: null,
                    temperature: null,
                    spO2: null,
                    lastUpdate: null
                };
                
                const bpRecords = deviceRecords.filter(record => record.type === '血壓').sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                if (bpRecords.length > 0) {
                    const latestBP = bpRecords[0];
                    latestData.bloodPressure = {
                        systolic: latestBP.data.systolic,
                        diastolic: latestBP.data.diastolic,
                        pulse: latestBP.data.pulse,
                        assessment: latestBP.data.assessment,
                        time: latestBP.time
                    };
                }
                
                const medications = JSON.parse(localStorage.getItem('medications') || '[]');
                
                return {
                    deviceData: latestData,
                    medications: medications,
                    totalRecords: healthRecords.length,
                    deviceRecords: deviceRecords.length,
                    lastUpdate: deviceRecords.length > 0 ? 
                        new Date(Math.max(...deviceRecords.map(r => new Date(r.timestamp)))).toLocaleDateString('zh-CN') : 
                        '無記錄'
                };
            } catch (error) {
                console.error('收集健康數據失敗:', error);
                return {
                    deviceData: null,
                    medications: [],
                    totalRecords: 0,
                    deviceRecords: 0,
                    lastUpdate: '無記錄'
                };
            }
        }
        
        // 構建包含健康數據的增強消息（複製自 ai_chat.js）
        function buildEnhancedMessage(userMessage, healthData) {
            let enhancedMessage = userMessage;
            
            if (healthData.deviceData && (healthData.deviceData.bloodPressure || healthData.deviceData.spO2 || healthData.deviceData.temperature)) {
                enhancedMessage += '\n\n我的健康數據：\n';
                
                if (healthData.deviceData.bloodPressure) {
                    const bp = healthData.deviceData.bloodPressure;
                    enhancedMessage += `- 血壓：${bp.systolic}/${bp.diastolic} mmHg，脈搏：${bp.pulse} bpm（${bp.time}）\n`;
                }
                
                if (healthData.deviceData.spO2) {
                    const spo2 = healthData.deviceData.spO2;
                    enhancedMessage += `- 血氧飽和度：${spo2.percent}%，灌注指數：${spo2.pi}%，脈搏率：${spo2.pr} bpm（${spo2.time}）\n`;
                }
                
                if (healthData.deviceData.temperature) {
                    const temp = healthData.deviceData.temperature;
                    enhancedMessage += `- 體溫：${temp.value}°C（${temp.location}，${temp.time}）\n`;
                }
                
                if (healthData.medications && healthData.medications.length > 0) {
                    enhancedMessage += `\n我的用藥情況：\n`;
                    healthData.medications.forEach(med => {
                        if (med.status === 'active') {
                            enhancedMessage += `- ${med.name}：${med.dosage}，${med.time}，${getFrequencyText(med.frequency)}\n`;
                        }
                    });
                }
                
                enhancedMessage += `\n數據更新時間：${healthData.lastUpdate}`;
            } else {
                enhancedMessage += '\n\n注意：我還沒有錄入健康數據，請先使用智能設備數據錄入功能記錄您的健康狀況。';
            }
            
            return enhancedMessage;
        }
        
        function getFrequencyText(frequency) {
            const frequencyMap = {
                'daily': '每日',
                'weekly': '每週',
                'monthly': '每月',
                'custom': '自定義'
            };
            return frequencyMap[frequency] || frequency;
        }
    </script>
</body>
</html>
