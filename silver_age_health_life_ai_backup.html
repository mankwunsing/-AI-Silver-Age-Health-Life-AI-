<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>专业健康管理助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>
    <script>
        // 注册缩放/平移插件
        try {
            const zoomPlugin = window['chartjs-plugin-zoom'];
            if (zoomPlugin) { Chart.register(zoomPlugin); }
        } catch (e) { console.warn('zoom plugin register failed', e); }
    </script>
    
    <script>
        // 等待Tailwind CSS加载完成
        if (typeof tailwind !== 'undefined') {
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0F52BA',
                        secondary: '#3B82F6',
                        accent: '#60A5FA',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        info: '#3B82F6',
                        neutral: {
                            100: '#F3F4F6',
                            200: '#E5E7EB',
                            300: '#D1D5DB',
                            400: '#9CA3AF',
                            500: '#6B7280',
                            600: '#4B5563',
                            700: '#374151',
                            800: '#1F2937',
                            900: '#111827',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .app-container { max-width: 450px; min-height: 800px; margin: 0 auto; height: 100vh; overflow: visible; }
            .page-content { display: block; visibility: visible; opacity: 1; }
            .btn-main { @apply w-full py-6 rounded-xl text-lg font-semibold shadow-md flex items-center justify-center transition-all duration-300 hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]; }
            .btn-secondary { @apply w-full py-4 rounded-xl text-base font-semibold transition-all duration-300; }
            .card { @apply bg-white rounded-xl shadow-md p-5 mb-5 transform transition-all duration-300 hover:shadow-lg; }
            .card-hover { @apply hover:translate-y-[-4px]; }
            .input-field { @apply w-full p-4 border border-neutral-200 rounded-xl text-base focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all duration-300; }
            .text-title { @apply text-xl font-bold text-neutral-800; }
            .text-subtitle { @apply text-base font-medium text-neutral-600; }
            .text-normal { @apply text-base text-neutral-600; }
            .text-small { @apply text-sm text-neutral-500; }
            .empty-state { @apply text-center p-6 text-neutral-400; }
            .touch-area { @apply min-h-[60px] flex items-center; }
            .pulse-animation { animation: none; }
            .wake-word-active { animation: none; }
            .risk-alert { @apply bg-warning/10 border-l-4 border-warning p-3 rounded-xl mb-3; }
            .model-badge { @apply inline-block text-xs bg-primary/10 text-primary px-2 py-0.5 rounded-full ml-2; }
            .progress-ring { @apply w-full h-2 bg-neutral-200 rounded-full overflow-hidden; }
            .progress-bar { @apply h-full rounded-full transition-all duration-1000 ease-out; }
            .fade-in { animation: fadeIn 0.3s ease-in-out; }
            .slide-in { animation: slideIn 0.3s ease-out; }
            .scale-in { animation: scaleIn 0.2s ease-out; }
            .gradient-bg { @apply bg-gradient-to-r from-primary to-secondary; }
            .card-header { @apply flex justify-between items-center mb-4 pb-2 border-b border-neutral-100; }
            .stat-card { @apply bg-neutral-50 rounded-xl p-4 transition-all duration-300 hover:shadow-md; }
            .dashboard-item { @apply bg-white rounded-xl p-4 shadow-sm transition-all duration-300 hover:shadow-md; }
            .metric-label { @apply text-xs uppercase text-neutral-500 font-medium; }
            .metric-value { @apply text-2xl font-bold text-neutral-800; }
            .metric-trend { @apply text-xs font-medium flex items-center mt-1; }
            .trend-up { @apply text-danger; }
            .trend-down { @apply text-success; }
            .trend-stable { @apply text-neutral-500; }
            .chart-container { @apply w-full h-48 relative; }
            
            @keyframes pulse {
                0%, 100% { transform: scale(1); opacity: 1; }
            }
            @keyframes wakeWord {
                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes slideIn {
                from { transform: translateY(20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            @keyframes scaleIn {
                from { transform: scale(0.95); opacity: 0; }
                to { transform: scale(1); opacity: 1; }
            }
            
            @keyframes float {
                0%, 100% { transform: translateY(0px); }
            }
            
            @keyframes float3D {
                0%, 100% { transform: translateY(0px); }
            }
            
            @keyframes morphing {
                0%, 100% { border-radius: 8px; transform: scale(1); }
            }
            
            @keyframes glow {
                0%, 100% { box-shadow: 0 0 8px rgba(59, 130, 246, 0.3); }
            }
            
            @keyframes matrix {
                0% { transform: translateY(-100vh); opacity: 0; }
                10% { opacity: 1; }
                90% { opacity: 1; }
                100% { transform: translateY(100vh); opacity: 0; }
            }
            
            @keyframes hologram {
                0%, 100% { 
                    background: linear-gradient(45deg, rgba(0,255,255,0.1), rgba(255,0,255,0.1));
                }
                25% { 
                    background: linear-gradient(45deg, rgba(255,0,255,0.1), rgba(0,255,0,0.1));
                }
                50% { 
                    background: linear-gradient(45deg, rgba(0,255,0,0.1), rgba(255,255,0,0.1));
                }
                75% { 
                    background: linear-gradient(45deg, rgba(255,255,0,0.1), rgba(0,255,255,0.1));
                }
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 1; }
            }
            
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideInLeft {
                from { transform: translateX(-100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideInUp {
                from { transform: translateY(100%); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            
            @keyframes bounce {
                0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
                40%, 43% { transform: translate3d(0,-30px,0); }
                70% { transform: translate3d(0,-15px,0); }
                90% { transform: translate3d(0,-4px,0); }
            }
            
            .animate-float { animation: none; }
            .animate-float3d { animation: none; }
            .animate-morphing { animation: none; }
            .animate-glow { animation: none; }
            .animate-matrix { animation: none; }
            .animate-hologram { animation: none; }
            .animate-pulse { animation: none; }
            .animate-bounce { animation: bounce 1s infinite; }
            .animate-slide-in-right { animation: slideInRight 0.5s ease-out; }
            .animate-slide-in-left { animation: slideInLeft 0.5s ease-out; }
            .animate-slide-in-up { animation: slideInUp 0.5s ease-out; }
            
            /* 3D变换效果 */
            .transform-3d { transform-style: preserve-3d; }
            .perspective-1000 { perspective: 1000px; }
            
            /* 玻璃态效果增强 */
            .glass-morphism {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            }
            
            /* 霓虹灯效果 */
            .neon-glow {
                text-shadow: 
                    0 0 2px currentColor,
                    0 0 4px currentColor;
            }
            
            /* 全息投影效果 */
            .holographic {
                background: linear-gradient(45deg, 
                    rgba(0,255,255,0.1), 
                    rgba(255,0,255,0.1), 
                    rgba(0,255,0,0.1), 
                    rgba(255,255,0,0.1));
                background-size: 400% 400%;
                animation: hologram 8s ease-in-out infinite;
            }
            
            /* 矩阵雨效果 */
            .matrix-rain {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: -1;
                overflow: hidden;
            }
            
            /* 粒子系统 */
            .particle-system {
                position: absolute;
                width: 100%;
                height: 100%;
                overflow: hidden;
                pointer-events: none;
            }
            
            /* 动态渐变背景 */
            .dynamic-gradient {
                background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab) !important;
                background-size: 400% 400% !important;
                animation: gradientShift 15s ease infinite !important;
            }
            
            /* 强制显示复杂效果 */
            .glass-morphism {
                background: rgba(255, 255, 255, 0.1) !important;
                backdrop-filter: blur(20px) !important;
                border: 1px solid rgba(255, 255, 255, 0.2) !important;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
            }
            
            .neon-glow {
                text-shadow: 
                    0 0 2px currentColor,
                    0 0 4px currentColor !important;
            }
            
            .holographic {
                background: linear-gradient(45deg, 
                    rgba(0,255,255,0.1), 
                    rgba(255,0,255,0.1), 
                    rgba(0,255,0,0.1), 
                    rgba(255,255,0,0.1)) !important;
                background-size: 400% 400% !important;
                animation: hologram 8s ease-in-out infinite !important;
            }
            
            @keyframes gradientShift {
                0% { background-position: 0% 50%; }
                50% { background-position: 100% 50%; }
                100% { background-position: 0% 50%; }
            }
            
            /* 复杂渐变背景 */
            .gradient-bg {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                position: relative;
                overflow: hidden;
            }
            
            .gradient-bg::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
                animation: none;
            }
            
            /* 玻璃态效果 */
            .glass-effect {
                background: rgba(255, 255, 255, 0.25);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.18);
            }
            
            /* 悬浮效果 */
            .hover-lift {
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            
            .hover-lift:hover {
                transform: translateY(-5px);
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            
            /* 发光效果 */
            .glow-effect {
                box-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
                transition: box-shadow 0.3s ease;
            }
            
            .glow-effect:hover {
                box-shadow: 0 0 12px rgba(59, 130, 246, 0.4);
            }
            
            
            /* 浅色模式样式 */
            .light-mode {
                background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%) !important;
            }
            
            .light-mode .app-container {
                background: #ffffff !important;
                box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
                border: 1px solid #e2e8f0 !important;
            }
            
            .light-mode .gradient-bg {
                background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%) !important;
            }
            
            .light-mode .glass-morphism {
                background: rgba(255, 255, 255, 0.95) !important;
                backdrop-filter: blur(20px) !important;
                border: 1px solid rgba(0, 0, 0, 0.15) !important;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
            }
            
            .light-mode .neon-glow {
                text-shadow: none !important;
                color: #1e293b !important;
                font-weight: 600 !important;
            }
            
            .light-mode .card {
                background: #ffffff !important;
                border: 1px solid #d1d5db !important;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
            }
            
            .light-mode .stat-card {
                background: #f8fafc !important;
                border: 1px solid #d1d5db !important;
                color: #374151 !important;
            }
            
            .light-mode .stat-card .text-2xl {
                color: #1f2937 !important;
                font-weight: 700 !important;
            }
            
            .light-mode .stat-card .text-sm {
                color: #6b7280 !important;
            }
            
            .light-mode .btn-main {
                background: #3b82f6 !important;
                color: white !important;
                border: none !important;
                box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3) !important;
            }
            
            .light-mode .btn-main:hover {
                background: #2563eb !important;
                box-shadow: 0 6px 8px -1px rgba(59, 130, 246, 0.4) !important;
            }
            
            .light-mode .text-white {
                color: #1e293b !important;
            }
            
            /* 浅色模式下状态栏按钮文字保持白色 */
            .light-mode .gradient-bg .text-white,
            .light-mode .gradient-bg button,
            .light-mode .gradient-bg span {
                color: white !important;
            }
            
            /* 主题切换按钮样式 */
            #theme-toggle {
                transition: all 0.3s ease;
            }
            
            #theme-toggle:hover {
                background: #dbeafe !important;
                border-color: #3b82f6 !important;
                transform: scale(1.05);
            }
            
            .light-mode #theme-toggle {
                background: #f3f4f6 !important;
                border-color: #d1d5db !important;
            }
            
            .light-mode #theme-toggle:hover {
                background: #e5e7eb !important;
                border-color: #9ca3af !important;
            }
            
            .light-mode .text-gray-300 {
                color: #6b7280 !important;
            }
            
            .light-mode .text-gray-400 {
                color: #9ca3af !important;
            }
            
            .light-mode .bg-white\/10 {
                background: rgba(0, 0, 0, 0.05) !important;
            }
            
            .light-mode .bg-white\/20 {
                background: rgba(0, 0, 0, 0.1) !important;
            }
            
            .light-mode .border-white\/20 {
                border-color: rgba(0, 0, 0, 0.1) !important;
            }
        }
    </style>
    <style>
        :root {
            --color-bg: #ffffff;
            --color-text: #111827;
            --color-card: #ffffff;
        }
        .dark :root {}
        .dark body { background-color: #0b1220; color: #e5e7eb; }
        .dark .bg-white { background-color: #111827; }
        .dark .text-neutral-800 { color: #e5e7eb; }
        .dark .card, .dark .stat-card, .dark .dashboard-item { background-color: #111827; }
    </style>
</head>
<body class="bg-neutral-100 p-4 font-sans text-neutral-800">
    <!-- 错误提示面板 -->
    <div id="error-panel" class="fixed top-0 left-0 right-0 bg-red-500 text-white p-3 text-sm z-50 hidden">
        <p><i class="fa fa-exclamation-circle mr-2"></i><span id="error-message">发生错误</span></p>
    </div>

    <!-- 调试信息面板 -->
    <div id="debug-panel" class="fixed top-0 left-0 bg-black text-white p-2 text-xs z-50 hidden">
        <p>调试信息: <span id="debug-info">页面已加载</span></p>
    </div>


    <!-- 应用容器 -->
    <div class="app-container bg-white rounded-3xl shadow-xl relative">
        <!-- 顶部状态栏 -->
        <div class="gradient-bg text-white p-3 flex justify-between items-center">
            <span class="text-sm font-medium" id="real-time">14:30</span>
            <div class="flex space-x-3">
                <i class="fa fa-signal text-sm"></i>
                <i class="fa fa-wifi text-sm network-status" title="网络状态"></i>
                <i class="fa fa-battery-full text-sm"></i>
            </div>
        </div>

        <!-- 全屏圖表預覽模態 -->
        <div id="chart-fullscreen-modal" class="fixed inset-0 bg-black/70 hidden z-50 items-center justify-center">
            <div class="relative bg-white rounded-2xl w-[95vw] h-[85vh] p-4">
                <button id="chart-fullscreen-close" class="absolute right-4 top-4 text-neutral-600 hover:text-red-500"><i class="fa fa-times text-2xl"></i></button>
                <canvas id="chart-fullscreen-canvas" class="w-full h-full"></canvas>
            </div>
        </div>

        <!-- 圖表配置抽屜 -->
        <div id="chart-config-drawer" class="fixed right-0 top-0 h-full w-80 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-40">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">圖表配置</h3>
                    <button id="config-drawer-close" class="text-gray-500 hover:text-red-500">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- 圖例設置 -->
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">圖例設置</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="config-legend-show" class="mr-2" checked>
                                <span class="text-sm">顯示圖例</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="config-legend-clickable" class="mr-2" checked>
                                <span class="text-sm">可點擊隱藏數據集</span>
                            </label>
                        </div>
                    </div>

                    <!-- 平滑設置 -->
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">平滑設置</h4>
                        <div class="space-y-2">
                            <label class="block text-sm text-gray-600">線條平滑度</label>
                            <input type="range" id="config-tension" min="0" max="1" step="0.1" value="0.4" class="w-full">
                            <span id="tension-value" class="text-xs text-gray-500">0.4</span>
                        </div>
                    </div>

                    <!-- 色板主題 -->
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">色板主題</h4>
                        <div class="grid grid-cols-3 gap-2">
                            <button class="p-2 border rounded text-xs" data-theme="default">默認</button>
                            <button class="p-2 border rounded text-xs" data-theme="medical">醫療</button>
                            <button class="p-2 border rounded text-xs" data-theme="vibrant">鮮豔</button>
                            <button class="p-2 border rounded text-xs" data-theme="monochrome">單色</button>
                            <button class="p-2 border rounded text-xs" data-theme="pastel">柔和</button>
                            <button id="theme-toggle" class="p-2 border rounded text-xs flex items-center justify-center space-x-1 bg-blue-50 border-blue-200">
                                <i class="fa fa-sun" id="theme-icon"></i>
                                <span id="theme-text">深色</span>
                            </button>
                        </div>
                    </div>

                    <!-- 單位設置 -->
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">單位設置</h4>
                        <div class="space-y-2">
                            <label class="block text-sm text-gray-600">血壓單位</label>
                            <select id="config-bp-unit" class="w-full p-2 border rounded text-sm">
                                <option value="mmHg">mmHg</option>
                                <option value="kPa">kPa</option>
                            </select>
                        </div>
                        <div class="space-y-2 mt-3">
                            <label class="block text-sm text-gray-600">血糖單位</label>
                            <select id="config-bs-unit" class="w-full p-2 border rounded text-sm">
                                <option value="mmol/L">mmol/L</option>
                                <option value="mg/dL">mg/dL</option>
                            </select>
                        </div>
                    </div>

                    <!-- 網格設置 -->
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">網格設置</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="config-grid-show" class="mr-2" checked>
                                <span class="text-sm">顯示網格線</span>
                            </label>
                            <label class="block text-sm text-gray-600">網格透明度</label>
                            <input type="range" id="config-grid-opacity" min="0" max="1" step="0.1" value="0.2" class="w-full">
                            <span id="grid-opacity-value" class="text-xs text-gray-500">20%</span>
                        </div>
                    </div>

                    <!-- 動畫設置 -->
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">動畫設置</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="config-animation-enable" class="mr-2" checked>
                                <span class="text-sm">啟用動畫</span>
                            </label>
                            <label class="block text-sm text-gray-600">動畫時長 (ms)</label>
                            <input type="range" id="config-animation-duration" min="0" max="2000" step="100" value="250" class="w-full">
                            <span id="animation-duration-value" class="text-xs text-gray-500">250ms</span>
                        </div>
                    </div>

                    <!-- 重置按鈕 -->
                    <div class="pt-4 border-t">
                        <button id="config-reset" class="w-full py-2 px-4 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm">
                            重置為默認設置
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 主界面 -->
        <div id="page-home" class="h-[calc(100vh-56px)] overflow-y-auto page-content">
            <!-- 简化背景 -->
            
            <!-- 顶部欢迎区域 -->
            <div class="gradient-bg p-6 text-white relative glass-morphism">
                
                <div class="relative z-10">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h1 class="text-[clamp(1.5rem,5vw,2rem)] font-bold mb-2 neon-glow animate-glow">专业健康管理助手</h1>
                            <p class="text-white/90 text-base animate-float">科学管理，健康生活</p>
                        </div>
                        <!-- 增强实时时钟 -->
                        <div class="text-right glass-morphism p-4 rounded-xl">
                            <div id="current-time" class="text-2xl font-mono font-bold neon-glow animate-pulse"></div>
                            <div id="current-date" class="text-sm text-white/70 animate-float"></div>
                            <div class="text-xs text-white/50 mt-1 animate-glow">实时同步</div>
                        </div>
                    </div>
                    
                    <!-- 增强快速统计卡片 -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                        <div class="glass-morphism rounded-xl p-4 border border-white/20 hover:bg-white/15 transition-all duration-300 hover:scale-105 animate-float3d transform-3d">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs text-white/70 mb-1">今日记录</p>
                                    <p id="today-records" class="text-xl font-bold text-white">0</p>
                                </div>
                                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                                    <i class="fa fa-calendar-check-o text-white/80 text-sm"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20 hover:bg-white/15 transition-all duration-300 hover:scale-105">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs text-white/70 mb-1">健康评分</p>
                                    <p id="health-score" class="text-xl font-bold text-white">85</p>
                                </div>
                                <div class="w-10 h-10 bg-red-500/30 rounded-full flex items-center justify-center">
                                    <i class="fa fa-heart text-red-300 text-sm"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20 hover:bg-white/15 transition-all duration-300 hover:scale-105">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs text-white/70 mb-1">连续天数</p>
                                    <p id="streak-days" class="text-xl font-bold text-white">7</p>
                                </div>
                                <div class="w-10 h-10 bg-orange-500/30 rounded-full flex items-center justify-center">
                                    <i class="fa fa-fire text-orange-300 text-sm"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20 hover:bg-white/15 transition-all duration-300 hover:scale-105">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-xs text-white/70 mb-1">目标完成</p>
                                    <p id="goal-progress" class="text-xl font-bold text-white">75%</p>
                                </div>
                                <div class="w-10 h-10 bg-green-500/30 rounded-full flex items-center justify-center">
                                    <i class="fa fa-target text-green-300 text-sm"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 今日状态 -->
                    <div class="mt-4 bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                    <p class="text-base flex items-center">
                        <i class="fa fa-calendar-check-o mr-2"></i>
                        <span id="today-status">今日健康评分: 85分 (良好)</span>
                    </p>
                    </div>
                </div>
            </div>
            
            <!-- 健康概览卡片 -->
            <div class="px-5 mb-5 mt-[-20px]">
                <div class="card bg-white p-5 card-hover scale-in relative overflow-hidden">
                    <!-- 卡片背景装饰 -->
                    <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-100 to-purple-100 rounded-full -translate-y-16 translate-x-16 opacity-50"></div>
                    
                    <div class="relative z-10">
                        <div class="card-header flex justify-between items-center mb-4">
                        <h3 class="text-title">健康数据概览</h3>
                            <div class="flex items-center space-x-2">
                        <button class="text-primary text-sm font-medium" onclick="handleAction('viewHealthReport')">
                            查看报告 <i class="fa fa-angle-right ml-1"></i>
                        </button>
                                <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                            </div>
                        </div>
                        
                        <!-- 健康指标进度条 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-700">整体健康度</span>
                                    <span class="text-sm font-bold text-green-600">85%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full transition-all duration-1000 ease-out" style="width: 85%"></div>
                                </div>
                                
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-700">数据完整性</span>
                                    <span class="text-sm font-bold text-blue-600">72%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div class="bg-gradient-to-r from-blue-400 to-blue-600 h-3 rounded-full transition-all duration-1000 ease-out" style="width: 72%"></div>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-700">目标达成率</span>
                                    <span class="text-sm font-bold text-purple-600">68%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div class="bg-gradient-to-r from-purple-400 to-purple-600 h-3 rounded-full transition-all duration-1000 ease-out" style="width: 68%"></div>
                                </div>
                                
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-700">趋势稳定性</span>
                                    <span class="text-sm font-bold text-orange-600">91%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div class="bg-gradient-to-r from-orange-400 to-orange-600 h-3 rounded-full transition-all duration-1000 ease-out" style="width: 91%"></div>
                                </div>
                            </div>
                    </div>
                    
                    <!-- 健康指标仪表盘 -->
                    <div class="grid grid-cols-2 gap-4 mb-5">
                        <div class="dashboard-item">
                            <div class="metric-label">心率</div>
                            <div class="metric-value" id="dashboard-heart-rate">72</div>
                            <div class="metric-trend trend-stable" id="dashboard-heart-rate-status">
                                <i class="fa fa-minus mr-1"></i> 次/分钟 (正常)
                            </div>
                        </div>
                        <div class="dashboard-item">
                            <div class="metric-label">血压</div>
                            <div class="metric-value" id="dashboard-blood-pressure">125/82</div>
                            <div class="metric-trend trend-up" id="dashboard-blood-pressure-status">
                                <i class="fa fa-arrow-up mr-1"></i> mmHg (略高)
                            </div>
                        </div>
                        <div class="dashboard-item">
                            <div class="metric-label">血糖</div>
                            <div class="metric-value" id="dashboard-blood-sugar">5.4</div>
                            <div class="metric-trend trend-stable" id="dashboard-blood-sugar-status">
                                <i class="fa fa-minus mr-1"></i> mmol/L (正常)
                            </div>
                        </div>
                        <div class="dashboard-item">
                            <div class="metric-label">睡眠</div>
                            <div class="metric-value" id="dashboard-sleep">7.2</div>
                            <div class="metric-trend trend-down">
                                <i class="fa fa-arrow-down mr-1"></i> 小时 (不足)
                            </div>
                        </div>
                        <div class="dashboard-item">
                            <div class="metric-label">HRV</div>
                            <div class="metric-value" id="dashboard-hrv">58</div>
                            <div class="metric-trend trend-up">
                                <i class="fa fa-arrow-up mr-1"></i> ms (良好)
                            </div>
                        </div>
                    </div>
                    
                    <!-- 健康评分和完成情况 -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="stat-card">
                            <p class="text-small text-neutral-500">健康评分</p>
                            <div class="flex items-center">
                                <div class="w-16 h-16 relative mr-3">
                                    <canvas id="health-score-gauge"></canvas>
                                    <div class="absolute inset-0 flex items-center justify-center text-xl font-bold text-primary" id="health-score">85</div>
                                </div>
                                <div>
                                    <p class="text-xs text-success font-medium">良好</p>
                                    <p class="text-xs text-neutral-500">较昨日 +2</p>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <p class="text-small text-neutral-500">目标完成率</p>
                            <p class="text-xl font-bold" id="completed-goals">2/3</p>
                            <div class="progress-ring mt-1">
                                <div class="progress-bar bg-success" style="width: 67%"></div>
                            </div>
                            <p class="text-xs text-right mt-1 text-neutral-500">67%</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 功能快速入口 -->
            <div class="px-5 mb-5">
                <div class="grid grid-cols-3 gap-4">
                    <button onclick="handleAction('navigateToPage', 'page-medication')" class="dashboard-item text-center p-4">
                        <i class="fa fa-medkit text-2xl text-primary mb-2"></i>
                        <p class="font-semibold text-neutral-700">用药提醒</p>
                    </button>
                    <button onclick="handleAction('navigateToPage', 'page-appointment')" class="dashboard-item text-center p-4">
                        <i class="fa fa-calendar-plus-o text-2xl text-accent mb-2"></i>
                        <p class="font-semibold text-neutral-700">预约管理</p>
                    </button>
                    <button id="open-ai-chat-modal-btn" class="dashboard-item text-center p-4">
                        <i class="fa fa-comments-o text-2xl text-green-500 mb-2"></i>
                        <p class="font-semibold text-neutral-700">AI智能问答</p>
                    </button>
                </div>
            </div>
            
            <!-- 健康趋势图表卡片 -->
            <div class="px-5 mb-5">
                <div class="card card-hover scale-in">
                    <div class="card-header">
                        <h2 class="text-title flex items-center">
                            <i class="fa fa-line-chart text-primary mr-2"></i>健康趋势分析
                        </h2>
                        <div id="chart-period-buttons" class="flex space-x-2">
                            <button onclick="handleAction('updateChart', 'week')" class="text-xs px-2 py-1 bg-primary text-white rounded-full">周</button>
                            <button onclick="handleAction('updateChart', 'month')" class="text-xs px-2 py-1 bg-neutral-200 text-neutral-700 rounded-full">月</button>
                            <button onclick="handleAction('updateChart', 'year')" class="text-xs px-2 py-1 bg-neutral-200 text-neutral-700 rounded-full">年</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="health-trends-chart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- 语音助手按钮 -->
            <div class="px-5 mb-5">
                <button id="voice-btn" onclick="handleAction('toggleVoiceAssistant')" class="w-20 h-20 bg-primary rounded-full shadow-lg flex items-center justify-center mx-auto transition-all duration-300 hover:scale-110 active:scale-95">
                    <i class="fa fa-microphone text-white text-3xl"></i>
                </button>
                <p class="text-center text-small mt-2 text-neutral-600">按住说话（支持多语言）</p>
            </div>
            
            <!-- 语音交互界面 -->
            <div id="voice-assistant" class="hidden px-5 mb-5 fade-in">
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <p class="text-xs text-neutral-500">当前语言</p>
                        <select id="language-selector" class="text-base bg-transparent border-none focus:ring-0" onchange="handleAction('changeLanguage', this.value)">
                            <option value="mandarin">普通话</option>
                            <option value="cantonese">粤语</option>
                            <option value="sichuanese">四川话</option>
                        </select>
                    </div>
                    <div class="flex items-center">
                        <span class="text-xs bg-primary/10 text-primary px-2 py-1 rounded-full flex items-center">
                            <i class="fa fa-bolt mr-1"></i> 由AI提供支持
                        </span>
                    </div>
                </div>
                
                <!-- 模型选择器 -->
                <div class="mb-3">
                    <p class="text-xs text-neutral-500">AI模型选择</p>
                    <select id="model-selector" class="text-base bg-transparent border-none focus:ring-0" onchange="handleAction('updateSelectedModel', this.value)">
                        <option value="deepseek-chat">标准模式</option>
                        <option value="deepseek-reasoner">深度分析模式</option>
                    </select>
                </div>
                
                <div class="bg-neutral-100 rounded-2xl p-4 mb-3">
                    <p class="text-base text-neutral-700" id="user-query">正在聆听...</p>
                </div>
                <div class="bg-primary/10 rounded-2xl p-4">
                    <div class="flex items-start">
                        <i class="fa fa-robot text-primary mt-1 mr-3"></i>
                        <p class="text-base text-neutral-800" id="ai-response">请说出您的问题或指令...</p>
                    </div>
                </div>
                <button onclick="handleAction('stopListening')" class="w-full mt-4 py-3 bg-neutral-200 rounded-xl text-base font-semibold hover:bg-neutral-300 transition-colors">
                    <i class="fa fa-stop mr-2"></i> 结束对话
                </button>
            </div>
            
            <!-- 风险预警提示 -->
            <div id="risk-alert-container" class="px-5 mb-5">
                <div class="risk-alert slide-in">
                    <div class="flex items-start">
                        <i class="fa fa-exclamation-triangle text-warning mt-1 mr-3 text-lg"></i>
                        <div>
                            <p class="text-title text-warning">健康风险预警</p>
                            <p class="text-base" id="risk-alert-message">根据近7天数据分析，您的血压呈现上升趋势，建议减少盐分摄入并增加有氧运动。</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-5">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button onclick="handleAction('showPage', 'page-medicine')" class="btn-main bg-danger text-white card-hover glass-morphism animate-float3d transform-3d neon-glow">
                        <i class="fa fa-pills text-3xl mb-2 block animate-glow"></i>
                        <span class="animate-float">用药记录</span>
                    </button>
                    
                    <button onclick="handleAction('showPage', 'page-exam')" class="btn-main bg-warning text-white card-hover glass-morphism neon-glow">
                        <i class="fa fa-calendar-check-o text-3xl mb-2 block animate-glow"></i>
                        <span class="animate-float">体检预约</span>
                    </button>
                    
                    <button onclick="handleAction('showPage', 'page-diet')" class="btn-main bg-success text-white card-hover glass-morphism animate-float3d transform-3d neon-glow">
                        <i class="fa fa-cutlery text-3xl mb-2 block animate-glow"></i>
                        <span class="animate-float">饮食建议</span>
                    </button>
                    
                    <button onclick="handleAction('showPage', 'page-health-data')" class="btn-main bg-primary text-white card-hover glass-morphism neon-glow">
                        <i class="fa fa-heartbeat text-3xl mb-2 block animate-glow"></i>
                        <span class="animate-float">健康数据</span>
                    </button>
                    
                    <!-- 运动记录和健康目标按钮 -->
                    <button onclick="handleAction('showPage', 'page-exercise')" class="btn-main bg-info text-white card-hover glass-morphism animate-float3d transform-3d neon-glow">
                        <i class="fa fa-heartbeat text-3xl mb-2 block animate-glow"></i>
                        <span class="animate-float">运动记录</span>
                    </button>
                    
                    <button onclick="handleAction('showPage', 'page-goals')" class="btn-main bg-secondary text-white card-hover glass-morphism neon-glow">
                        <i class="fa fa-bullseye text-3xl mb-2 block animate-glow"></i>
                        <span class="animate-float">健康目标</span>
                    </button>

                    <button onclick="window.location.href='drug_inquiry.html'" class="btn-main bg-purple-500 text-white card-hover">
                        <i class="fa fa-search text-3xl mb-2 block"></i>
                        <span>药物查询</span>
                    </button>

                    <button onclick="window.location.href='recipe_suggestions.html'" class="btn-main bg-green-500 text-white card-hover">
                        <i class="fa fa-leaf text-3xl mb-2 block"></i>
                        <span>健康食谱</span>
                    </button>
                </div>
                
                <!-- 健康分析卡片 -->
                <div class="card card-hover mb-5">
                    <div class="card-header">
                        <h2 class="text-title flex items-center">
                            <i class="fa fa-bar-chart text-primary mr-2"></i>健康指标分析
                        </h2>
                        <button onclick="handleAction('generateHealthAnalysis')" class="text-primary text-sm hover:underline transition-all">
                            <i class="fa fa-refresh mr-1"></i> 分析
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="health-metrics-radar-chart"></canvas>
                    </div>
                    <div class="mt-4 text-sm text-neutral-600">
                        <p><i class="fa fa-info-circle text-primary mr-2"></i> 雷达图展示您各项健康指标与标准值的对比情况</p>
                    </div>
                </div>
                
                <!-- 模型设置卡片 -->
                <div class="card border-l-4 border-primary card-hover">
                    <div class="card-header">
                        <h2 class="text-title flex items-center">
                            <i class="fa fa-cog text-primary mr-2"></i>AI分析设置
                        </h2>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-base mb-2">API密钥</label>
                            <input type="password" id="api-key-input" placeholder="请输入API密钥" class="input-field">
                            <p class="text-xs text-neutral-500 mt-1">获取专业分析功能</p>
                        </div>
                        <div>
                            <label class="block text-base mb-2">DeepSeek API密钥</label>
                            <input type="password" id="deepseek-api-key-input" placeholder="请输入DeepSeek API密钥" class="input-field">
                            <p class="text-xs text-neutral-500 mt-1">用于生成AI健康报告</p>
                        </div>
                        <div>
                            <label class="block text-base mb-2">分析模型</label>
                            <select id="default-model-selector" class="input-field" onchange="handleAction('updateSelectedModel', this.value)">
                                <option value="deepseek-chat">标准分析模型</option>
                                <option value="deepseek-reasoner">深度分析模型</option>
                            </select>
                        </div>
                        <button onclick="handleAction('validateModels')" class="w-full py-3 bg-blue-500 text-white rounded-xl text-base font-semibold mb-2 hover:bg-blue-600 transition-colors">
                            <i class="fa fa-check-circle mr-2"></i> 验证模型可用性
                        </button>
                        <button onclick="handleAction('saveApiSettings')" class="w-full py-3 bg-primary text-white rounded-xl text-base font-semibold hover:bg-primary/90 transition-colors">
                            <i class="fa fa-save mr-2"></i> 保存设置
                        </button>
                    </div>
                    <div id="model-status-container" class="mt-4 space-y-2 hidden">
                        <p class="text-sm font-medium">模型状态：</p>
                        <div id="model-status-list" class="text-sm"></div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- 懸浮快捷操作 -->
        <div class="fixed right-5 bottom-6 z-40 flex flex-col items-end space-y-3">
            <button id="fab-add-record" class="rounded-full shadow-lg bg-primary text-white w-12 h-12 flex items-center justify-center hover:scale-105 transition-transform" title="添加記錄">
                <i class="fa fa-plus"></i>
            </button>
            <button id="fab-view-report" class="rounded-full shadow-lg bg-white text-primary w-12 h-12 flex items-center justify-center hover:scale-105 transition-transform" title="查看報告">
                <i class="fa fa-file-text-o"></i>
            </button>
            <button id="fab-open-ai" class="rounded-full shadow-lg bg-green-500 text-white w-12 h-12 flex items-center justify-center hover:scale-105 transition-transform" title="AI 助手">
                <i class="fa fa-comments"></i>
            </button>
        </div>

        
        <!-- 用药提醒页面已移动到功能页面容器 -->
            <div class="flex items-center mb-5">
                <button onclick="handleAction('navigateToPage', 'page-home')" class="text-primary mr-4"><i class="fa fa-arrow-left text-xl"></i></button>
                <h2 class="text-title">用药提醒</h2>
            </div>

            <div class="card">
                <h3 class="text-subtitle mb-3">今日用药</h3>
                <div id="today-medication-list">
                    <!-- 用药项将动态生成 -->
                </div>
                <div id="empty-medication-today" class="empty-state hidden">
                    <i class="fa fa-check-circle-o text-4xl text-success mb-3"></i>
                    <p>今日无用药安排</p>
                </div>
            </div>

            <div class="card">
                <h3 class="text-subtitle mb-3">所有用药计划</h3>
                <div id="all-medication-list">
                    <!-- 所有用药计划将动态生成 -->
                </div>
                <div id="empty-medication-all" class="empty-state hidden">
                    <p>暂无用药计划</p>
                </div>
            </div>

            <button onclick="handleAction('openModal', 'add-medication-modal')" class="btn-main bg-primary text-white mt-5">
                <i class="fa fa-plus mr-2"></i> 添加用药提醒
            </button>
        </div>

        <!-- 预约管理页面 -->
        <div id="page-appointment-old" class="hidden h-[calc(100vh-56px)] overflow-y-auto p-5 page-content">
            <div class="flex items-center mb-5">
                <button onclick="handleAction('navigateToPage', 'page-home')" class="text-primary mr-4"><i class="fa fa-arrow-left text-xl"></i></button>
                <h2 class="text-title">预约管理</h2>
            </div>

            <div class="card">
                <h3 class="text-subtitle mb-3">即将到来的预约</h3>
                <div id="upcoming-appointment-list">
                    <!-- 预约项将动态生成 -->
                </div>
                <div id="empty-appointment-upcoming" class="empty-state hidden">
                    <p>无即将到来的预约</p>
                </div>
            </div>

            <div class="card">
                <h3 class="text-subtitle mb-3">所有预约</h3>
                <div id="all-appointment-list">
                    <!-- 所有预约将动态生成 -->
                </div>
                <div id="empty-appointment-all" class="empty-state hidden">
                    <p>暂无预约记录</p>
                </div>
            </div>

            <button onclick="handleAction('openModal', 'add-appointment-modal')" class="btn-main bg-primary text-white mt-5">
                <i class="fa fa-plus mr-2"></i> 添加新预约
            </button>
        </div>
        
        <!-- 用药记录页面 -->
        <div id="page-medicine" class="h-[calc(100vh-56px)] overflow-y-auto hidden page-content">
            <div class="p-5">
                <div class="touch-area mb-5">
                    <button onclick="handleAction('showPage', 'page-home')" class="mr-4 text-xl hover:text-primary transition-colors">
                        <i class="fa fa-arrow-left"></i>
                    </button>
                    <h2 class="text-title inline-block">用药记录管理</h2>
                </div>
                
                <!-- 添加用药记录 -->
                <div class="card mb-5 card-hover scale-in">
                    <div class="card-header">
                        <h3 class="text-title">添加用药记录</h3>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-base mb-2">药品名称</label>
                            <input type="text" id="medicine-name" placeholder="例如：阿司匹林" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">剂量</label>
                            <input type="text" id="medicine-dose" placeholder="例如：100mg" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">服用时间</label>
                            <input type="datetime-local" id="medicine-time" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">服用原因</label>
                            <textarea id="medicine-reason" placeholder="例如：缓解头痛" class="input-field" rows="3"></textarea>
                        </div>
                        <button onclick="handleAction('addMedicineRecord')" class="w-full py-3 bg-primary text-white rounded-xl text-base font-semibold hover:bg-primary/90 transition-colors">
                            <i class="fa fa-plus-circle mr-2"></i> 添加记录
                        </button>
                    </div>
                </div>
                
                <!-- 用药记录列表 -->
                <div class="card card-hover">
                    <div class="card-header">
                        <h3 class="text-title">用药记录历史</h3>
                        <button onclick="handleAction('clearMedicineRecords')" class="text-danger text-sm hover:underline transition-all">
                            <i class="fa fa-trash mr-1"></i> 清空
                        </button>
                    </div>
                    <div id="medicine-records-list" class="space-y-3">
                        <!-- 用药记录会动态添加到这里 -->
                        <div class="empty-state" id="medicine-records-empty">
                            <i class="fa fa-pills text-4xl mb-2"></i>
                            <p class="text-base">暂无用药记录</p>
                            <p class="text-small mt-1">添加您的用药信息以便跟踪</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 体检预约页面 -->
        <div id="page-exam-old" class="h-[calc(100vh-56px)] overflow-y-auto hidden page-content">
            <div class="p-5">
                <div class="touch-area mb-5">
                    <button onclick="handleAction('showPage', 'page-home')" class="mr-4 text-xl hover:text-primary transition-colors">
                        <i class="fa fa-arrow-left"></i>
                    </button>
                    <h2 class="text-title inline-block">体检预约管理</h2>
                </div>
                
                <!-- 新增体检预约 -->
                <div class="card mb-5 card-hover scale-in">
                    <div class="card-header">
                        <h3 class="text-title">新增体检预约</h3>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-base mb-2">体检类型</label>
                            <select id="exam-type" class="input-field">
                                <option value="常规体检">常规体检</option>
                                <option value="专项体检">专项体检</option>
                                <option value="入职体检">入职体检</option>
                                <option value="年度体检">年度体检</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-base mb-2">体检机构</label>
                            <input type="text" id="exam-hospital" placeholder="例如：市第一人民医院" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">预约日期</label>
                            <input type="date" id="exam-date" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">预约时间</label>
                            <input type="time" id="exam-time" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">备注</label>
                            <textarea id="exam-notes" placeholder="例如：需要空腹" class="input-field" rows="3"></textarea>
                        </div>
                        <button onclick="handleAction('addExamAppointment')" class="w-full py-3 bg-primary text-white rounded-xl text-base font-semibold hover:bg-primary/90 transition-colors">
                            <i class="fa fa-calendar-plus-o mr-2"></i> 确认预约
                        </button>
                    </div>
                </div>
                
                <!--  upcoming体检 -->
                <div class="card mb-5 card-hover">
                    <div class="card-header">
                        <h3 class="text-title">即将进行的体检</h3>
                    </div>
                    <div id="upcoming-exams" class="space-y-3">
                        <div class="empty-state" id="upcoming-exams-empty">
                            <i class="fa fa-calendar text-4xl mb-2"></i>
                            <p class="text-base">暂无即将进行的体检</p>
                            <p class="text-small mt-1">添加您的体检预约以便提醒</p>
                        </div>
                    </div>
                </div>
                
                <!-- 历史体检记录 -->
                <div class="card card-hover">
                    <div class="card-header">
                        <h3 class="text-title">历史体检记录</h3>
                        <button onclick="handleAction('clearExamRecords')" class="text-danger text-sm hover:underline transition-all">
                            <i class="fa fa-trash mr-1"></i> 清空历史
                        </button>
                    </div>
                    <div id="completed-exams" class="space-y-3">
                        <div class="empty-state" id="completed-exams-empty">
                            <i class="fa fa-history text-4xl mb-2"></i>
                            <p class="text-base">暂无历史体检记录</p>
                            <p class="text-small mt-1">完成体检后可标记为已完成</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 饮食建议页面 -->
        <div id="page-diet-old" class="h-[calc(100vh-56px)] overflow-y-auto hidden page-content">
            <div class="p-5">
                <div class="touch-area mb-5">
                    <button onclick="handleAction('showPage', 'page-home')" class="mr-4 text-xl hover:text-primary transition-colors">
                        <i class="fa fa-arrow-left"></i>
                    </button>
                    <h2 class="text-title inline-block">饮食健康管理</h2>
                </div>
                
                <!-- 今日饮食记录 -->
                <div class="card mb-5 card-hover scale-in">
                    <div class="card-header">
                        <h3 class="text-title">今日饮食记录</h3>
                        <span class="text-small text-neutral-500" id="diet-date"></span>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- 早餐 -->
                        <div>
                            <label class="block text-base mb-2 flex items-center">
                                <i class="fa fa-sun-o text-warning mr-2"></i> 早餐
                            </label>
                            <textarea id="diet-breakfast" placeholder="记录您的早餐内容" class="input-field" rows="2"></textarea>
                        </div>
                        
                        <!-- 午餐 -->
                        <div>
                            <label class="block text-base mb-2 flex items-center">
                                <i class="fa fa-sun-o text-danger mr-2"></i> 午餐
                            </label>
                            <textarea id="diet-lunch" placeholder="记录您的午餐内容" class="input-field" rows="2"></textarea>
                        </div>
                        
                        <!-- 晚餐 -->
                        <div>
                            <label class="block text-base mb-2 flex items-center">
                                <i class="fa fa-moon-o text-primary mr-2"></i> 晚餐
                            </label>
                            <textarea id="diet-dinner" placeholder="记录您的晚餐内容" class="input-field" rows="2"></textarea>
                        </div>
                        
                        <!-- 加餐/零食 -->
                        <div>
                            <label class="block text-base mb-2 flex items-center">
                                <i class="fa fa-cutlery text-success mr-2"></i> 加餐/零食
                            </label>
                            <textarea id="diet-snacks" placeholder="记录您的加餐或零食" class="input-field" rows="2"></textarea>
                        </div>
                        
                        <button onclick="handleAction('saveDietRecord')" class="w-full py-3 bg-primary text-white rounded-xl text-base font-semibold hover:bg-primary/90 transition-colors">
                            <i class="fa fa-save mr-2"></i> 保存今日饮食
                        </button>
                    </div>
                </div>
                
                <!-- 饮食建议 -->
                <div class="card mb-5 card-hover">
                    <div class="card-header">
                        <h3 class="text-title flex items-center">
                            <i class="fa fa-lightbulb-o text-warning mr-2"></i>个性化饮食建议
                        </h3>
                        <button onclick="handleAction('generateDietAdvice')" class="text-primary text-sm hover:underline transition-all">
                            <i class="fa fa-refresh mr-1"></i> 更新建议
                        </button>
                    </div>
                    <div id="diet-advice" class="text-base space-y-3">
                        <div class="empty-state" id="diet-advice-empty">
                            <i class="fa fa-book text-4xl mb-2"></i>
                            <p class="text-base">暂无饮食建议</p>
                            <p class="text-small mt-1">记录您的饮食后生成个性化建议</p>
                        </div>
                    </div>
                </div>
                
                <!-- 营养摄入分析 -->
                <div class="card card-hover">
                    <div class="card-header">
                        <h3 class="text-title flex items-center">
                            <i class="fa fa-pie-chart text-success mr-2"></i>营养摄入分析
                        </h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="nutrition-chart"></canvas>
                    </div>
                    <div class="mt-4 grid grid-cols-3 gap-2 text-center">
                        <div class="bg-neutral-50 p-3 rounded-lg">
                            <p class="text-xs text-neutral-500">蛋白质</p>
                            <p class="text-lg font-bold text-primary">65g</p>
                            <p class="text-xs text-success">达标</p>
                        </div>
                        <div class="bg-neutral-50 p-3 rounded-lg">
                            <p class="text-xs text-neutral-500">碳水</p>
                            <p class="text-lg font-bold text-warning">230g</p>
                            <p class="text-xs text-warning">略高</p>
                        </div>
                        <div class="bg-neutral-50 p-3 rounded-lg">
                            <p class="text-xs text-neutral-500">脂肪</p>
                            <p class="text-lg font-bold text-danger">75g</p>
                            <p class="text-xs text-danger">超标</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 运动记录页面 -->
        <div id="page-exercise-old" class="h-[calc(100vh-56px)] overflow-y-auto hidden page-content">
            <div class="p-5">
                <div class="touch-area mb-5">
                    <button onclick="handleAction('showPage', 'page-home')" class="mr-4 text-xl hover:text-primary transition-colors">
                        <i class="fa fa-arrow-left"></i>
                    </button>
                    <h2 class="text-title inline-block">运动记录管理</h2>
                </div>
                
                <!-- 添加运动记录 -->
                <div class="card mb-5 card-hover scale-in">
                    <div class="card-header">
                        <h3 class="text-title">添加运动记录</h3>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-base mb-2">运动类型</label>
                            <select id="exercise-type" class="input-field">
                                <option value="散步">散步</option>
                                <option value="跑步">跑步</option>
                                <option value="游泳">游泳</option>
                                <option value="骑自行车">骑自行车</option>
                                <option value="健身">健身</option>
                                <option value="瑜伽">瑜伽</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-base mb-2">运动时长 (分钟)</label>
                            <input type="number" id="exercise-duration" placeholder="例如：30" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">运动日期</label>
                            <input type="date" id="exercise-date" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">运动强度</label>
                            <select id="exercise-intensity" class="input-field">
                                <option value="低">低</option>
                                <option value="中" selected>中</option>
                                <option value="高">高</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-base mb-2">备注</label>
                            <textarea id="exercise-notes" placeholder="例如：感觉良好" class="input-field" rows="2"></textarea>
                        </div>
                        <button onclick="handleAction('addExerciseRecord')" class="w-full py-3 bg-primary text-white rounded-xl text-base font-semibold hover:bg-primary/90 transition-colors">
                            <i class="fa fa-plus-circle mr-2"></i> 记录运动
                        </button>
                    </div>
                </div>
                
                <!-- 运动统计 -->
                <div class="card mb-5 card-hover">
                    <div class="card-header">
                        <h3 class="text-title flex items-center">
                            <i class="fa fa-bar-chart text-info mr-2"></i>运动统计
                        </h3>
                        <div class="flex space-x-2" id="chart-period-buttons">
                            <button onclick="handleAction('updateExerciseChart', 'week')" class="text-xs px-2 py-1 bg-primary text-white rounded-full">周</button>
                            <button onclick="handleAction('updateExerciseChart', 'month')" class="text-xs px-2 py-1 bg-neutral-200 text-neutral-700 rounded-full">月</button>
                            <button onclick="handleAction('updateExerciseChart', 'year')" class="text-xs px-2 py-1 bg-neutral-200 text-neutral-700 rounded-full">年</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="exercise-chart"></canvas>
                    </div>
                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <div class="bg-neutral-50 p-3 rounded-lg">
                            <p class="text-xs text-neutral-500">本周运动总时长</p>
                            <p class="text-xl font-bold text-info">210分钟</p>
                        </div>
                        <div class="bg-neutral-50 p-3 rounded-lg">
                            <p class="text-xs text-neutral-500">平均每周运动</p>
                            <p class="text-xl font-bold text-info">3.5天</p>
                        </div>
                    </div>
                </div>
                
                <!-- 运动记录历史 -->
                <div class="card card-hover">
                    <div class="card-header">
                        <h3 class="text-title">近期运动记录</h3>
                        <button onclick="handleAction('clearExerciseRecords')" class="text-danger text-sm hover:underline transition-all">
                            <i class="fa fa-trash mr-1"></i> 清空
                        </button>
                    </div>
                    <div id="exercise-records-list" class="space-y-3">
                        <div class="empty-state" id="exercise-records-empty">
                            <i class="fa fa-heartbeat text-4xl mb-2"></i>
                            <p class="text-base">暂无运动记录</p>
                            <p class="text-small mt-1">记录您的运动情况以便分析</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 健康目标页面 -->
        <div id="page-goals-old" class="h-[calc(100vh-56px)] overflow-y-auto hidden page-content">
            <div class="p-5">
                <div class="touch-area mb-5">
                    <button onclick="handleAction('showPage', 'page-home')" class="mr-4 text-xl hover:text-primary transition-colors">
                        <i class="fa fa-arrow-left"></i>
                    </button>
                    <h2 class="text-title inline-block">健康目标管理</h2>
                </div>
                
                <!-- 添加健康目标 -->
                <div class="card mb-5 card-hover scale-in">
                    <div class="card-header">
                        <h3 class="text-title">添加健康目标</h3>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-base mb-2">目标类型</label>
                            <select id="goal-type" class="input-field">
                                <option value="运动">运动</option>
                                <option value="饮食">饮食</option>
                                <option value="睡眠">睡眠</option>
                                <option value="体重">体重</option>
                                <option value="血压">血压</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-base mb-2">目标描述</label>
                            <input type="text" id="goal-description" placeholder="例如：每天运动30分钟" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">目标开始日期</label>
                            <input type="date" id="goal-start-date" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">目标完成日期</label>
                            <input type="date" id="goal-end-date" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">目标优先级</label>
                            <select id="goal-priority" class="input-field">
                                <option value="高">高</option>
                                <option value="中" selected>中</option>
                                <option value="低">低</option>
                            </select>
                        </div>
                        <button onclick="handleAction('addHealthGoal')" class="w-full py-3 bg-primary text-white rounded-xl text-base font-semibold hover:bg-primary/90 transition-colors">
                            <i class="fa fa-plus-circle mr-2"></i> 添加目标
                        </button>
                    </div>
                </div>
                
                <!-- 进行中的目标 -->
                <div class="card mb-5 card-hover">
                    <div class="card-header">
                        <h3 class="text-title">进行中的目标</h3>
                    </div>
                    <div id="active-goals" class="space-y-3">
                        <div class="empty-state" id="active-goals-empty">
                            <i class="fa fa-bullseye text-4xl mb-2"></i>
                            <p class="text-base">暂无进行中的目标</p>
                            <p class="text-small mt-1">添加您的健康目标开始管理</p>
                        </div>
                    </div>
                </div>
                
                <!-- 已完成的目标 -->
                <div class="card card-hover">
                    <div class="card-header">
                        <h3 class="text-title">已完成的目标</h3>
                        <button onclick="handleAction('clearCompletedGoals')" class="text-danger text-sm hover:underline transition-all">
                            <i class="fa fa-trash mr-1"></i> 清空
                        </button>
                    </div>
                    <div id="completed-goals-list" class="space-y-3">
                        <div class="empty-state" id="completed-goals-empty">
                            <i class="fa fa-trophy text-4xl mb-2"></i>
                            <p class="text-base">暂无已完成的目标</p>
                            <p class="text-small mt-1">完成目标后会显示在这里</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 健康数据页面 -->
        <div id="page-health-data-old" class="h-[calc(100vh-56px)] overflow-y-auto hidden page-content">
            <div class="p-5">
                <div class="touch-area mb-5">
                    <button onclick="handleAction('showPage', 'page-home')" class="mr-4 text-xl hover:text-primary transition-colors">
                        <i class="fa fa-arrow-left"></i>
                    </button>
                    <h2 class="text-title inline-block">健康数据管理</h2>
                </div>
                
                <!-- 健康数据录入 -->
                <div class="card mb-5 card-hover scale-in">
                    <div class="card-header">
                        <h3 class="text-title">输入健康数据</h3>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-base mb-2">心率 (次/分钟)</label>
                            <input type="number" id="input-heart-rate" placeholder="例如：75" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">血压 (mmHg)</label>
                            <input type="text" id="input-blood-pressure" placeholder="例如：120/80" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">血糖 (mmol/L)</label>
                            <input type="number" step="0.1" id="input-blood-sugar" placeholder="例如：5.6" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">睡眠时长 (小时)</label>
                            <input type="number" step="0.5" id="input-sleep-duration" placeholder="例如：7.5" class="input-field">
                        </div>
                        <button onclick="handleAction('saveHealthData')" class="w-full py-3 bg-primary text-white rounded-xl text-base font-semibold hover:bg-primary/90 transition-colors">
                            <i class="fa fa-save mr-2"></i> 保存数据
                        </button>
                    </div>
                </div>
                
                <!-- 健康报告 -->
                <div class="card mb-5 card-hover">
                    <div class="card-header">
                        <h3 class="text-title">健康分析报告</h3>
                        <button onclick="handleAction('generateHealthReport')" class="text-primary text-base hover:underline transition-all">
                            <i class="fa fa-refresh mr-1"></i> 更新
                        </button>
                    </div>
                    <div id="health-report" class="text-base space-y-2 empty-state">
                        <i class="fa fa-file-text-o text-4xl mb-2"></i>
                        <p class="text-base">暂无健康报告</p>
                        <p class="text-small mt-1">添加健康数据后生成</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 操作提示 -->
        <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-xl text-base shadow-lg hidden flex items-center fade-in">
            <i class="fa fa-check-circle mr-2"></i>
            <span id="toast-text">操作成功</span>
        </div>
    </div>

    <!-- 功能页面容器 -->
    <div class="app-container bg-white rounded-3xl shadow-xl relative">
        <!-- 预约管理页面 -->
        <div id="page-appointment" class="hidden h-[calc(100vh-56px)] overflow-y-auto p-5 page-content">
            <div class="flex items-center mb-5">
                <button onclick="handleAction('navigateToPage', 'page-home')" class="text-primary mr-4"><i class="fa fa-arrow-left text-xl"></i></button>
                <h2 class="text-title">预约管理</h2>
            </div>

            <!-- 即将到来的预约 -->
            <div class="card mb-5">
                <div class="card-header">
                    <h3 class="text-title">即将到来的预约</h3>
                </div>
                <div id="appointment-upcoming" class="space-y-3">
                    <!-- 预约项将动态生成 -->
                </div>
                <div id="empty-appointment-upcoming" class="empty-state hidden">
                    <p>无即将到来的预约</p>
                </div>
            </div>

            <!-- 所有预约 -->
            <div class="card mb-5">
                <div class="card-header">
                    <h3 class="text-title">所有预约</h3>
                </div>
                <div id="appointment-all" class="space-y-3">
                    <!-- 所有预约将动态生成 -->
                </div>
                <div id="empty-appointment-all" class="empty-state hidden">
                    <p>暂无预约记录</p>
                </div>
            </div>

            <button onclick="handleAction('openModal', 'add-appointment-modal')" class="btn-main bg-primary text-white mt-5">
                <i class="fa fa-plus mr-2"></i> 添加新预约
            </button>
        </div>
        
        <!-- 体检预约页面 -->
        <div id="page-exam-old" class="h-[calc(100vh-56px)] overflow-y-auto hidden page-content">
            <div class="p-5">
                <div class="touch-area mb-5">
                    <button onclick="handleAction('showPage', 'page-home')" class="mr-4 text-xl hover:text-primary transition-colors">
                        <i class="fa fa-arrow-left"></i>
                    </button>
                    <h2 class="text-title inline-block">体检预约管理</h2>
                </div>
                
                <!-- 添加体检预约表单 -->
                <div class="card mb-5">
                    <div class="card-header">
                        <h3 class="text-title">添加体检预约</h3>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-base mb-2">体检类型</label>
                            <select id="exam-type" class="input-field">
                                <option value="">请选择体检类型</option>
                                <option value="常规体检">常规体检</option>
                                <option value="心血管检查">心血管检查</option>
                                <option value="血糖检查">血糖检查</option>
                                <option value="血压检查">血压检查</option>
                                <option value="眼科检查">眼科检查</option>
                                <option value="口腔检查">口腔检查</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-base mb-2">预约日期</label>
                            <input type="date" id="exam-date" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">预约时间</label>
                            <input type="time" id="exam-time" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">医院/诊所</label>
                            <input type="text" id="exam-hospital" placeholder="例如：市人民医院" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">备注</label>
                            <textarea id="exam-notes" placeholder="例如：需要空腹" class="input-field" rows="3"></textarea>
                        </div>
                        <button onclick="handleAction('addExamAppointment')" class="w-full py-3 bg-primary text-white rounded-xl text-base font-semibold hover:bg-primary/90 transition-colors">
                            <i class="fa fa-calendar-plus-o mr-2"></i> 确认预约
                        </button>
                    </div>
                </div>
                
                <!-- 体检预约历史 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-title">历史体检记录</h3>
                        <button onclick="handleAction('clearExamRecords')" class="text-danger text-sm hover:underline transition-all">
                            <i class="fa fa-trash mr-1"></i> 清空历史
                        </button>
                    </div>
                    <div id="exam-records" class="space-y-3">
                        <!-- 记录将动态生成 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 饮食建议页面 -->
        <div id="page-diet-old" class="h-[calc(100vh-56px)] overflow-y-auto hidden page-content">
            <div class="p-5">
                <div class="touch-area mb-5">
                    <button onclick="handleAction('showPage', 'page-home')" class="mr-4 text-xl hover:text-primary transition-colors">
                        <i class="fa fa-arrow-left"></i>
                    </button>
                    <h2 class="text-title inline-block">饮食健康管理</h2>
                </div>
                
                <!-- 饮食记录表单 -->
                <div class="card mb-5">
                    <div class="card-header">
                        <h3 class="text-title">记录饮食</h3>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-base mb-2">用餐时间</label>
                            <select id="meal-time" class="input-field">
                                <option value="早餐">早餐</option>
                                <option value="午餐">午餐</option>
                                <option value="晚餐">晚餐</option>
                                <option value="加餐">加餐</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-base mb-2">食物内容</label>
                            <textarea id="food-content" placeholder="例如：白米饭、青菜、瘦肉" class="input-field" rows="3"></textarea>
                        </div>
                        <div>
                            <label class="block text-base mb-2">用餐时间</label>
                            <input type="datetime-local" id="diet-time" class="input-field">
                        </div>
                        <button onclick="handleAction('saveDietRecord')" class="w-full py-3 bg-primary text-white rounded-xl text-base font-semibold hover:bg-primary/90 transition-colors">
                            <i class="fa fa-save mr-2"></i> 保存记录
                        </button>
                    </div>
                </div>
                
                <!-- 饮食建议 -->
                <div class="card mb-5">
                    <div class="card-header">
                        <h3 class="text-title">个性化饮食建议</h3>
                        <button onclick="handleAction('generateDietAdvice')" class="text-primary text-sm hover:underline transition-all">
                            <i class="fa fa-refresh mr-1"></i> 更新建议
                        </button>
                    </div>
                    <div id="diet-advice" class="text-base space-y-2">
                        <p class="text-neutral-500">点击"更新建议"获取个性化饮食建议</p>
                    </div>
                </div>
                
                <!-- 饮食记录历史 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-title">饮食记录历史</h3>
                    </div>
                    <div id="diet-records" class="space-y-3">
                        <!-- 记录将动态生成 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 运动记录页面 -->
        <div id="page-exercise-old" class="h-[calc(100vh-56px)] overflow-y-auto hidden page-content">
            <div class="p-5">
                <div class="touch-area mb-5">
                    <button onclick="handleAction('showPage', 'page-home')" class="mr-4 text-xl hover:text-primary transition-colors">
                        <i class="fa fa-arrow-left"></i>
                    </button>
                    <h2 class="text-title inline-block">运动记录管理</h2>
                </div>
                
                <!-- 添加运动记录表单 -->
                <div class="card mb-5">
                    <div class="card-header">
                        <h3 class="text-title">添加运动记录</h3>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-base mb-2">运动类型</label>
                            <select id="exercise-type" class="input-field">
                                <option value="">请选择运动类型</option>
                                <option value="散步">散步</option>
                                <option value="跑步">跑步</option>
                                <option value="游泳">游泳</option>
                                <option value="骑自行车">骑自行车</option>
                                <option value="太极拳">太极拳</option>
                                <option value="瑜伽">瑜伽</option>
                                <option value="健身">健身</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-base mb-2">运动时长（分钟）</label>
                            <input type="number" id="exercise-duration" placeholder="例如：30" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">运动强度</label>
                            <select id="exercise-intensity" class="input-field">
                                <option value="低">低强度</option>
                                <option value="中">中等强度</option>
                                <option value="高">高强度</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-base mb-2">运动时间</label>
                            <input type="datetime-local" id="exercise-time" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">备注</label>
                            <textarea id="exercise-notes" placeholder="例如：感觉很好" class="input-field" rows="3"></textarea>
                        </div>
                        <button onclick="handleAction('addExerciseRecord')" class="w-full py-3 bg-primary text-white rounded-xl text-base font-semibold hover:bg-primary/90 transition-colors">
                            <i class="fa fa-plus-circle mr-2"></i> 添加记录
                        </button>
                    </div>
                </div>
                
                <!-- 运动记录历史 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-title">运动记录历史</h3>
                        <button onclick="handleAction('clearExerciseRecords')" class="text-danger text-sm hover:underline transition-all">
                            <i class="fa fa-trash mr-1"></i> 清空
                        </button>
                    </div>
                    <div id="exercise-records" class="space-y-3">
                        <!-- 记录将动态生成 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 健康目标页面 -->
        <div id="page-goals-old" class="h-[calc(100vh-56px)] overflow-y-auto hidden page-content">
            <div class="p-5">
                <div class="touch-area mb-5">
                    <button onclick="handleAction('showPage', 'page-home')" class="mr-4 text-xl hover:text-primary transition-colors">
                        <i class="fa fa-arrow-left"></i>
                    </button>
                    <h2 class="text-title inline-block">健康目标管理</h2>
                </div>
                
                <!-- 添加健康目标表单 -->
                <div class="card mb-5">
                    <div class="card-header">
                        <h3 class="text-title">添加健康目标</h3>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-base mb-2">目标类型</label>
                            <select id="goal-type" class="input-field">
                                <option value="">请选择目标类型</option>
                                <option value="体重管理">体重管理</option>
                                <option value="运动目标">运动目标</option>
                                <option value="饮食目标">饮食目标</option>
                                <option value="睡眠目标">睡眠目标</option>
                                <option value="血压控制">血压控制</option>
                                <option value="血糖控制">血糖控制</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-base mb-2">目标描述</label>
                            <textarea id="goal-description" placeholder="例如：每天步行30分钟" class="input-field" rows="3"></textarea>
                        </div>
                        <div>
                            <label class="block text-base mb-2">目标期限</label>
                            <input type="date" id="goal-deadline" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">目标优先级</label>
                            <select id="goal-priority" class="input-field">
                                <option value="低">低优先级</option>
                                <option value="中">中等优先级</option>
                                <option value="高">高优先级</option>
                            </select>
                        </div>
                        <button onclick="handleAction('addHealthGoal')" class="w-full py-3 bg-primary text-white rounded-xl text-base font-semibold hover:bg-primary/90 transition-colors">
                            <i class="fa fa-plus-circle mr-2"></i> 添加目标
                        </button>
                    </div>
                </div>
                
                <!-- 健康目标列表 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-title">我的健康目标</h3>
                        <button onclick="handleAction('clearCompletedGoals')" class="text-success text-sm hover:underline transition-all">
                            <i class="fa fa-check mr-1"></i> 清理已完成
                        </button>
                    </div>
                    <div id="health-goals" class="space-y-3">
                        <!-- 目标将动态生成 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 健康数据页面 -->
        <div id="page-health-data-old" class="h-[calc(100vh-56px)] overflow-y-auto hidden page-content">
            <div class="p-5">
                <div class="touch-area mb-5">
                    <button onclick="handleAction('showPage', 'page-home')" class="mr-4 text-xl hover:text-primary transition-colors">
                        <i class="fa fa-arrow-left"></i>
                    </button>
                    <h2 class="text-title inline-block">健康数据管理</h2>
                </div>
                
                <!-- 添加健康数据表单 -->
                <div class="card mb-5">
                    <div class="card-header">
                        <h3 class="text-title">添加健康数据</h3>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-base mb-2">数据类型</label>
                            <select id="data-type" class="input-field">
                                <option value="">请选择数据类型</option>
                                <option value="血压">血压</option>
                                <option value="心率">心率</option>
                                <option value="血糖">血糖</option>
                                <option value="体重">体重</option>
                                <option value="体温">体温</option>
                                <option value="血氧">血氧</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-base mb-2">数值</label>
                            <input type="text" id="data-value" placeholder="例如：120/80" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">测量时间</label>
                            <input type="datetime-local" id="data-time" class="input-field">
                        </div>
                        <div>
                            <label class="block text-base mb-2">备注</label>
                            <textarea id="data-notes" placeholder="例如：餐后测量" class="input-field" rows="3"></textarea>
                        </div>
                        <button onclick="handleAction('addHealthRecord')" class="w-full py-3 bg-primary text-white rounded-xl text-base font-semibold hover:bg-primary/90 transition-colors">
                            <i class="fa fa-plus-circle mr-2"></i> 添加数据
                        </button>
                    </div>
                </div>
                
                <!-- 健康数据历史 -->
                <div class="card mb-5">
                    <div class="card-header">
                        <h3 class="text-title">健康数据历史</h3>
                    </div>
                    <div id="health-data-records" class="space-y-3">
                        <!-- 记录将动态生成 -->
                    </div>
                </div>
                
                <!-- 健康报告 -->
                <div class="card mb-5 card-hover">
                    <div class="card-header">
                        <h3 class="text-title">健康分析报告</h3>
                        <button onclick="handleAction('generateHealthReport')" class="text-primary text-base hover:underline transition-all">
                            <i class="fa fa-refresh mr-1"></i> 更新
                        </button>
                    </div>
                    <div id="health-report" class="text-base space-y-2 empty-state">
                        <i class="fa fa-file-text-o text-4xl mb-2"></i>
                        <p class="text-base">暂无健康报告</p>
                        <p class="text-small mt-1">添加健康数据后生成</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 主题切换功能
        let isLightMode = false;
        
        function initThemeToggle() {
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            const body = document.body;
            
            // 检查元素是否存在
            if (!themeToggle) {
                console.error('主题切换按钮未找到');
                return;
            }
            if (!themeIcon) {
                console.error('主题图标未找到');
                return;
            }
            if (!themeText) {
                console.error('主题文字未找到');
                return;
            }
            
            console.log('主题切换功能初始化成功');
            
            // 从localStorage读取主题设置
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                isLightMode = true;
                body.classList.add('light-mode');
                themeIcon.className = 'fa fa-moon';
                themeText.textContent = '浅色';
                console.log('已切换到浅色模式');
            } else {
                console.log('当前为深色模式');
            }
            
            themeToggle.addEventListener('click', function() {
                isLightMode = !isLightMode;
                
                if (isLightMode) {
                    body.classList.add('light-mode');
                    themeIcon.className = 'fa fa-moon';
                    themeText.textContent = '浅色';
                    localStorage.setItem('theme', 'light');
                    console.log('切换到浅色模式');
                } else {
                    body.classList.remove('light-mode');
                    themeIcon.className = 'fa fa-sun';
                    themeText.textContent = '深色';
                    localStorage.setItem('theme', 'dark');
                    console.log('切换到深色模式');
                }
            });
        }
        
        // 全局错误处理
        window.addEventListener('error', function(event) {
            showError(`JavaScript错误: ${event.error.message}`);
            console.error('全局错误捕获:', event.error);
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            showError(`未处理的Promise错误: ${event.reason.message}`);
            console.error('未处理的Promise错误:', event.reason);
        });
        
        // 显示错误信息
        function showError(message) {
            const errorPanel = document.getElementById('error-panel');
            const errorMessage = document.getElementById('error-message');
            
            if (errorPanel && errorMessage) {
                errorMessage.textContent = message;
                errorPanel.classList.remove('hidden');
                
                // 5秒后自动隐藏错误面板
                setTimeout(() => {
                    errorPanel.classList.add('hidden');
                }, 5000);
            }
        }
        
        // 统一的事件处理入口，方便错误捕获
            let healthTrendsChart; // 全局图表变量

        function getHealthData() {
            const personalInfo = appData.personalInfo;
            const healthData = appData.healthData[0]; // Get the latest health data

            return {
                ...personalInfo,
                ...healthData
            };
        }

        function handleAction(action, ...args) {
                try {
                    console.log(`执行操作: ${action}`, args);
                    updateDebugInfo(`执行: ${action}`);

                    if (action === 'viewHealthReport') {
                        console.log('viewHealthReport action triggered');
                        const healthReportSection = document.getElementById('health-report-section');
                        const chartsContainer = document.getElementById('charts-container');
                        console.log('healthReportSection:', healthReportSection);
                        console.log('chartsContainer:', chartsContainer);
                        if (healthReportSection && chartsContainer) {
                            healthReportSection.classList.remove('hidden');
                            chartsContainer.classList.remove('hidden');
                            renderAllReportCharts();
                            if (typeof generateHealthReport === 'function') {
                                generateHealthReport();
                            }
                        }
                        return;
                    }
                    
                    if (action === 'showPage') {
                        console.log('showPage action triggered with page:', args[0]);
                        showPage(args[0]);
                        return;
                    }
                    
                    if (action === 'navigateToPage') {
                        console.log('navigateToPage action triggered with page:', args[0]);
                        showPage(args[0]);
                        return;
                    }
                    
                    // 根据操作名称分发到相应的处理函数
                    // 异步函数：处理健康问答
                    async function askQuestion() {
                        const questionInput = document.getElementById('question-input');
                        const chatBox = document.getElementById('chat-box');
                        const question = questionInput.value.trim();

                        if (!question) {
                            showToast('请输入您的问题。');
                            return;
                        }

                        if (!deepSeekApiKey) {
                            showToast('请先在设置中输入DeepSeek API密钥。');
                            return;
                        }

                        // 移除初始提示
                        if (chatBox.querySelector('.text-center')) {
                            chatBox.innerHTML = '';
                        }

                        // 显示用户的问题
                        const userMessage = document.createElement('div');
                        userMessage.className = 'mb-4 text-right';
                        userMessage.innerHTML = `<p class="inline-block bg-primary text-white rounded-lg px-4 py-2">${question}</p>`;
                        chatBox.appendChild(userMessage);

                        // 清空输入框并滚动到底部
                        questionInput.value = '';
                        chatBox.scrollTop = chatBox.scrollHeight;

                        // 显示“思考中”提示
                        const thinkingMessage = document.createElement('div');
                        thinkingMessage.className = 'mb-4 text-left';
                        thinkingMessage.innerHTML = `<p class="inline-block bg-gray-200 text-gray-700 rounded-lg px-4 py-2"><i class="fa fa-spinner fa-spin mr-2"></i>正在思考中...</p>`;
                        chatBox.appendChild(thinkingMessage);
                        chatBox.scrollTop = chatBox.scrollHeight;

                        try {
                            // 准备发送给API的健康数据
                            const healthData = getHealthData();
                            const healthDataString = `性别: ${healthData.gender}, 年龄: ${healthData.age}, 身高: ${healthData.height}cm, 体重: ${healthData.weight}kg, 血压: ${healthData.bloodPressure}, 血糖: ${healthData.bloodSugar}mmol/L, 心率: ${healthData.heartRate}bpm, 血氧: ${healthData.bloodOxygen}%, 症状: ${healthData.symptoms}, 病史: ${healthData.medicalHistory}, 过敏史: ${healthData.allergies}, 运动习惯: ${healthData.exerciseHabits}, 饮食习惯: ${healthData.dietaryHabits}`;

                            const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${deepSeekApiKey}`
                                },
                                body: JSON.stringify({
                                    model: 'deepseek-chat',
                                    messages: [
                                        {
                                            content: `你是一位资深的健康顾问，专门为中老年人提供健康咨询。请根据用户的健康数据和问题，提供专业、详细、易于理解的建议。请注意，你的回答仅供参考，不能替代专业医疗意见。用户的健康数据如下：\n${healthDataString}`,
                                            role: 'system'
                                        },
                                        {
                                            content: question,
                                            role: 'user'
                                        }
                                    ],
                                    max_tokens: 1024,
                                    temperature: 0.7,
                                    stream: false
                                })
                            });

                            // 移除“思考中”提示
                            chatBox.removeChild(thinkingMessage);

                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(`DeepSeek API 请求失败，状态码: ${response.status}, 错误信息: ${errorData.error.message}`);
                            }

                            const data = await response.json();
                            const answer = data.choices[0].message.content;

                            // 显示API的回答
                            const apiMessage = document.createElement('div');
                            apiMessage.className = 'mb-4 text-left';
                            apiMessage.innerHTML = `<p class="inline-block bg-gray-200 text-gray-700 rounded-lg px-4 py-2">${answer.replace(/\n/g, '<br>')}</p>`;
                            chatBox.appendChild(apiMessage);

                        } catch (error) {
                            console.error('健康问答失败:', error);
                            // 移除“思考中”提示（如果它仍然存在）
                            if (chatBox.contains(thinkingMessage)) {
                                chatBox.removeChild(thinkingMessage);
                            }
                            const errorMessage = document.createElement('div');
                            errorMessage.className = 'mb-4 text-left';
                            errorMessage.innerHTML = `<p class="inline-block bg-red-100 text-red-700 rounded-lg px-4 py-2">抱歉，无法获取回答。请检查您的API密钥或网络连接，然后重试。</p>`;
                            chatBox.appendChild(errorMessage);
                        } finally {
                            // 滚动到底部
                            chatBox.scrollTop = chatBox.scrollHeight;
                        }
                    }

                    const actions = {
                        showPage: showPage,
                        openModal: openModal,
                        closeModal: closeModal,
                        navigateToPage: navigateToPage,
                        toggleVoiceAssistant: toggleVoiceAssistant,
                        stopListening: stopListening,
                        changeLanguage: changeLanguage,
                        updateSelectedModel: updateSelectedModel,
                        validateModels: validateModels,
                        saveApiSettings: saveApiSettings,
                        saveHealthData: saveHealthData,
                        generateHealthReport: generateHealthReport,
                        updateChart: updateChart,
                        generateHealthAnalysis: generateHealthAnalysis,
                        addMedicineRecord: addMedicineRecord,
                        clearMedicineRecords: clearMedicineRecords,
                        deleteMedicineRecord: deleteMedicineRecord,
                        addExamAppointment: addExamAppointment,
                        clearExamRecords: clearExamRecords,
                        completeExam: completeExam,
                        deleteExam: deleteExam,
                        saveDietRecord: saveDietRecord,
                        generateDietAdvice: generateDietAdvice,
                        addExerciseRecord: addExerciseRecord,
                        clearExerciseRecords: clearExerciseRecords,
                        deleteExerciseRecord: deleteExerciseRecord,
                        updateExerciseChart: updateExerciseChart,
                        addHealthGoal: addHealthGoal,
                        clearCompletedGoals: clearCompletedGoals,
                        completeGoal: completeGoal,
                        deleteGoal: deleteGoal,
                        addMedication: addMedication,
                        toggleMedication: toggleMedication,
                        deleteMedication: deleteMedication,
                        addAppointment: addAppointment,
                        updateAppointmentStatus: updateAppointmentStatus,
                        deleteAppointment: deleteAppointment,
                        askQuestion: askQuestion,
                        addHealthRecord: () => {
                            // 打开健康数据输入页面
                            showPage('page-health-data');
                        },
                        openAIChat: () => {
                            // 打开AI聊天功能
                            const openBtn = document.getElementById('open-ai-chat-modal-btn');
                            if (openBtn) openBtn.click();
                        },
                        showSettingsPanel: () => {
                            // 打开设置功能 - 显示配置抽屉
                            const configDrawer = document.getElementById('chart-config-drawer');
                            if (configDrawer) {
                                configDrawer.classList.remove('translate-x-full');
                                configDrawer.classList.add('translate-x-0');
                            }
                        }
                    };
                    
                    if (typeof actions[action] === 'function') {
                        actions[action].apply(this, args);
                    } else {
                        throw new Error(`未定义的操作: ${action}`);
                    }
                } catch (error) {
                    console.error(`操作 ${action} 执行失败:`, error);
                    showError(`操作失败: ${error.message}`);
                }
            }
        
        // 更新调试信息
        function updateDebugInfo(info) {
            const debugInfo = document.getElementById('debug-info');
            if (debugInfo) {
                debugInfo.textContent = info;
            }
        }
        
        // 显示提示消息
        function showToast(text) {
            const toast = document.getElementById('toast');
            if (!toast) return;
            
            document.getElementById('toast-text').textContent = text;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 2000);
        }
        
        // 页面切换
        function showPage(pageId) {
            console.log('showPage called with:', pageId);
            const page = document.getElementById(pageId);
            if (!page) {
                throw new Error(`页面 ${pageId} 不存在`);
            }
            
            console.log('Found page element:', page);
            console.log('Page classes before show:', page.className);
            
            // 隐藏所有页面
            document.querySelectorAll('[id^="page-"]').forEach(p => {
                p.classList.add('hidden');
                console.log(`Hidden page: ${p.id}`);
            });
            
            // 显示目标页面
            page.classList.remove('hidden');
            page.style.display = 'block';
            page.style.visibility = 'visible';
            page.style.opacity = '1';
            console.log('Page classes after show:', page.className);
            console.log('Page is now visible:', !page.classList.contains('hidden'));
            console.log('Page style display:', page.style.display);
            
            hideAllModals();
            
            // 设置页面标题
            const pageTitles = {
                'page-home': '健康管理助手 - 主页',
                'page-medication': '健康管理助手 - 用药提醒',
                'page-appointment': '健康管理助手 - 预约管理',
                'page-medicine': '健康管理助手 - 用药记录',
                'page-exam': '健康管理助手 - 体检预约',
                'page-diet': '健康管理助手 - 饮食建议',
                'page-health-data': '健康管理助手 - 健康数据',
                'page-exercise': '健康管理助手 - 运动记录',
                'page-goals': '健康管理助手 - 健康目标'
            };
            
            if (pageTitles[pageId]) {
                document.title = pageTitles[pageId];
            }
            
            // 加载对应页面的数据
            if (pageId === 'page-medication') {
                renderMedications();
            } else if (pageId === 'page-appointment') {
                renderAppointments();
            } else if (pageId === 'page-medicine') {
                loadMedicineRecords();
            } else if (pageId === 'page-exam') {
                loadExamAppointments();
            } else if (pageId === 'page-diet') {
                loadDietRecord();
                initNutritionChart();
            } else if (pageId === 'page-exercise') {
                loadExerciseRecords();
                initExerciseChart();
            } else if (pageId === 'page-goals') {
                loadHealthGoals();
            }
        }
        
        // 弹窗控制
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) {
                throw new Error(`弹窗 ${modalId} 不存在`);
            }
            
            hideAllModals();
            modal.classList.remove('hidden');
        }
        
        function hideAllModals() {
            document.querySelectorAll('[id^="modal-"]').forEach(modal => modal.classList.add('hidden'));
        }
        
        // 增强版语音识别功能
        let recognition;
        let isListening = false;

        // 初始化语音识别
        function initVoiceRecognition() {
            // 检查浏览器支持
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showError('抱歉，您的浏览器不支持语音识别功能，请使用Chrome浏览器尝试');
                return false;
            }
            
            // 创建识别实例
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            // 配置识别参数
            recognition.continuous = false; // 单次识别
            recognition.interimResults = false; // 不返回中间结果
            recognition.maxAlternatives = 3; // 返回3个可能的结果
            recognition.lang = getLanguageCode(appData.currentLanguage); // 设置语言
            
            // 识别成功回调
            recognition.onresult = handleRecognitionResult;
            
            // 识别结束回调
            recognition.onend = () => {
                if (isListening) {
                    // 如果仍在监听状态，自动重启识别
                    recognition.start();
                } else {
                    updateVoiceUI(false);
                }
            };
            
            // 识别错误回调
            recognition.onerror = (event) => {
                console.error('语音识别错误:', event.error);
                let errorMsg = '语音识别出错';
                
                switch(event.error) {
                    case 'not-allowed':
                        errorMsg = '请允许麦克风权限以使用语音识别';
                        break;
                    case 'no-speech':
                        errorMsg = '未检测到语音，请重试';
                        break;
                    case 'audio-capture':
                        errorMsg = '无法访问麦克风，请检查设备';
                        break;
                }
                
                document.getElementById('ai-response').textContent = errorMsg;
                stopListening();
            };
            
            return true;
        }

        // 处理识别结果
        function handleRecognitionResult(event) {
            const results = event.results[0];
            const bestResult = results[0].transcript;
            document.getElementById('user-query').textContent = bestResult;
            
            // 显示可能的备选结果，供用户选择
            showRecognitionAlternatives(results);
            
            // 延迟处理，等待用户可能的修正
            setTimeout(() => {
                processVoiceCommand(bestResult);
            }, 3000);
        }

        // 显示识别备选结果
        function showRecognitionAlternatives(results) {
            if (results.length <= 1) return; // 只有一个结果时不显示
            
            let alternativesHTML = '<div class="text-xs text-neutral-500 mt-2">其他可能: ';
            for (let i = 1; i < results.length; i++) {
                // 转义单引号以避免HTML注入问题
                const transcript = results[i].transcript.replace(/'/g, '&#39;');
                alternativesHTML += `<button onclick="correctRecognition('${transcript}')" class="text-primary hover:underline mx-1">${results[i].transcript}</button>`;
            }
            alternativesHTML += '</div>';
            
            const queryContainer = document.getElementById('user-query').parentNode;
            // 清除已存在的备选框
            const existingAlt = queryContainer.querySelector('.recognition-alternatives');
            if (existingAlt) existingAlt.remove();
            
            // 添加新的备选框
            const altElement = document.createElement('div');
            altElement.className = 'recognition-alternatives';
            altElement.innerHTML = alternativesHTML;
            queryContainer.appendChild(altElement);
        }

        // 修正识别结果
        function correctRecognition(text) {
            document.getElementById('user-query').textContent = text;
            // 移除备选框
            const altElement = document.querySelector('.recognition-alternatives');
            if (altElement) altElement.remove();
            // 处理修正后的命令
            processVoiceCommand(text);
        }

        // 处理语音命令
        function processVoiceCommand(command) {
            // 移除备选框
            const altElement = document.querySelector('.recognition-alternatives');
            if (altElement) altElement.remove();
            
            let response = "抱歉，我没理解您的意思。您可以尝试说：'记录血压120/80'、'添加用药记录'或'生成健康报告'";
            
            // 健康数据匹配
            const bloodSugarMatch = command.match(/血糖 ?(\d+\.?\d*)/);
            const bloodPressureMatch = command.match(/血压 ?(\d+\/\d+)/);
            const cholesterolMatch = command.match(/胆固醇 ?(\d+\.?\d*)/);

            if (bloodSugarMatch || bloodPressureMatch || cholesterolMatch) {
                const healthData = JSON.parse(localStorage.getItem('healthData')) || {};
                if (bloodSugarMatch) {
                    healthData.bloodSugar = parseFloat(bloodSugarMatch[1]);
                    response = `已记录血糖: ${healthData.bloodSugar}`;
                }
                if (bloodPressureMatch) {
                    healthData.bloodPressure = bloodPressureMatch[1];
                    response = `已记录血压: ${healthData.bloodPressure}`;
                }
                if (cholesterolMatch) {
                    healthData.cholesterol = parseFloat(cholesterolMatch[1]);
                    response = `已记录胆固醇: ${healthData.cholesterol}`;
                }
                localStorage.setItem('healthData', JSON.stringify(healthData));
                showToast('健康数据已更新，正在为您跳转到食谱建议...');
                setTimeout(() => {
                    window.location.href = 'recipe_suggestions.html';
                }, 1500);
            } else if (command.includes('用药') || command.includes('吃药')) {
                handleAction('showPage', 'page-medicine');
                response = "已为您打开用药记录页面";
            } else if (command.includes('运动')) {
                handleAction('showPage', 'page-exercise');
                response = "已为您打开运动记录页面";
            } else if (command.includes('报告') || command.includes('分析')) {
                handleAction('generateHealthReport');
                response = "正在为您生成健康报告";
            } else if (command.includes('饮食')) {
                handleAction('showPage', 'page-diet');
                response = "已为您打开饮食记录页面";
            } else if (command.includes('体检')) {
                handleAction('showPage', 'page-exam');
                response = "已为您打开体检预约页面";
            } else if (command.includes('目标')) {
                handleAction('showPage', 'page-goals');
                response = "已为您打开健康目标页面";
            }
            
            document.getElementById('ai-response').textContent = response;
        }

        // 切换语音识别状态
        function toggleVoiceAssistant() {
            const voiceBtn = document.getElementById('voice-btn');
            const voiceAssistant = document.getElementById('voice-assistant');
            
            if (!voiceBtn || !voiceAssistant) {
                throw new Error("语音助手相关元素不存在");
            }
            
            // 初始化语音识别（如果尚未初始化）
            if (!recognition && !initVoiceRecognition()) {
                return;
            }
            
            if (isListening) {
                stopListening();
            } else {
                // 开始聆听
                voiceAssistant.classList.remove('hidden');
                isListening = true;
                updateVoiceUI(true);
                
                try {
                    recognition.lang = getLanguageCode(appData.currentLanguage);
                    recognition.start();
                    document.getElementById('user-query').textContent = "正在聆听...请说话...";
                    document.getElementById('ai-response').textContent = "";
                } catch (error) {
                    console.error('启动语音识别失败:', error);
                    showError('启动语音识别失败，请重试');
                    stopListening();
                }
            }
        }

        // 停止聆听
        function stopListening() {
            if (recognition && isListening) {
                recognition.stop();
            }
            isListening = false;
            updateVoiceUI(false);
        }

        // 更新语音UI状态
        function updateVoiceUI(isActive) {
            const voiceBtn = document.getElementById('voice-btn');
            if (!voiceBtn) return;
            
            if (isActive) {
                voiceBtn.classList.add('pulse-animation', 'wake-word-active');
                voiceBtn.innerHTML = '<i class="fa fa-microphone-slash text-white text-3xl"></i>';
            } else {
                voiceBtn.classList.remove('pulse-animation', 'wake-word-active');
                voiceBtn.innerHTML = '<i class="fa fa-microphone text-white text-3xl"></i>';
            }
        }

        // 获取语言代码
        function getLanguageCode(lang) {
            switch(lang) {
                case 'mandarin': return 'zh-CN';
                case 'cantonese': return 'zh-HK';
                case 'sichuanese': return 'zh-CN'; // 四川话使用中文识别
                default: return 'zh-CN';
            }
        }

        // 更改语言时更新识别语言
        function changeLanguage(lang) {
            appData.currentLanguage = lang;
            if (recognition) {
                recognition.lang = getLanguageCode(lang);
            }
            showToast(`已切换至${lang === 'mandarin' ? '普通话' : lang === 'cantonese' ? '粤语' : '四川话'}`);
        }
        
        // 模型选择
        function updateSelectedModel(model) {
            SELECTED_MODEL = model;
            // 同步所有模型选择器
            document.getElementById('model-selector').value = model;
            document.getElementById('default-model-selector').value = model;
            
            const modelName = model === 'deepseek-chat' ? '标准分析模型' : '深度分析模型';
            showToast(`已切换至${modelName}`);
        }
        
        // 健康数据相关
        function saveHealthData() {
            const heartRate = document.getElementById('input-heart-rate').value.trim();
            const bloodPressure = document.getElementById('input-blood-pressure').value.trim();
            const bloodSugar = document.getElementById('input-blood-sugar').value.trim();
            const sleepDuration = document.getElementById('input-sleep-duration').value.trim();

            // 简单验证
            if (!heartRate && !bloodPressure && !bloodSugar && !sleepDuration) {
                showToast('请至少输入一项健康数据');
                return;
            }

            // 获取最新的健康数据记录作为默认值
            const latestHealthData = appData.healthData[0] || {};

            // 创建新的健康数据记录
            const newHealthRecord = {
                heartRate: heartRate || latestHealthData.heartRate,
                bloodPressure: bloodPressure || latestHealthData.bloodPressure,
                bloodSugar: bloodSugar || latestHealthData.bloodSugar,
                sleepDuration: sleepDuration || latestHealthData.sleepDuration,
                // 保留其他可能存在的数据
                bloodOxygen: latestHealthData.bloodOxygen,
                symptoms: latestHealthData.symptoms,
                lastUpdated: new Date().toLocaleString()
            };

            // 将新记录添加到数组开头
            if (!Array.isArray(appData.healthData)) {
                appData.healthData = [];
            }
            appData.healthData.unshift(newHealthRecord);

            // 更新UI
            document.getElementById('dashboard-heart-rate').textContent = newHealthRecord.heartRate;
            document.getElementById('dashboard-blood-pressure').textContent = newHealthRecord.bloodPressure;
            document.getElementById('dashboard-blood-sugar').textContent = newHealthRecord.bloodSugar;
            document.getElementById('dashboard-sleep').textContent = newHealthRecord.sleepDuration;

            updateHealthStatus(newHealthRecord); // 更新健康状态显示

            // 清空输入
            document.getElementById('input-heart-rate').value = '';
            document.getElementById('input-blood-pressure').value = '';
            document.getElementById('input-blood-sugar').value = '';
            document.getElementById('input-sleep-duration').value = '';

            saveAppData();
            showToast('健康数据已更新');
            updateDashboard(); // 更新整个仪表盘
            // 若報告區已打開，立即刷新圖表與文本
            const reportSection = document.getElementById('health-report-section');
            if (reportSection && !reportSection.classList.contains('hidden')) {
                        if (typeof renderAllReportCharts === 'function') {
                            renderAllReportCharts();
                        }
                        if (typeof generateHealthReport === 'function') {
                            generateHealthReport();
                        }
                        if (typeof initTimelinePlayback === 'function') {
                            initTimelinePlayback();
                        }
                        if (typeof initConfigDrawer === 'function') {
                            initConfigDrawer();
                        }
                        if (typeof initAdvancedTooltip === 'function') {
                            initAdvancedTooltip();
                        }
                        // 初始化复杂UI功能
                        if (typeof initComplexUI === 'function') {
                            initComplexUI();
                        }
            }
            showRedirectConfirmation(); // 恢复食谱建议弹窗
        }

        // 更新健康数据概览
        function updateHealthOverview() {
            const latestData = appData.healthData[0];
            if (!latestData) return;

            document.getElementById('dashboard-heart-rate').textContent = latestData.heartRate;
            document.getElementById('dashboard-blood-pressure').textContent = latestData.bloodPressure;
            document.getElementById('dashboard-blood-sugar').textContent = latestData.bloodSugar;
            document.getElementById('dashboard-sleep').textContent = latestData.sleepDuration;

            updateHealthStatus(latestData); // 更新健康状态显示
        }

        // 更新健康评分
        function updateHealthScore() {
            const latestData = appData.healthData[0];
            if (!latestData) return;

            // 示例：根据心率计算一个简单的分数
            const heartRateScore = 100 - Math.abs(latestData.heartRate - 75); // 假设75是理想心率
            const score = Math.max(0, Math.min(100, heartRateScore)); // 保证分数在0-100之间

            const healthScoreEl = document.getElementById('health-score');
            if (healthScoreEl) {
                healthScoreEl.textContent = Math.round(score);
            }

            // 更新仪表盘图表
            const healthScoreChart = Chart.getChart('health-score-gauge');
            if (healthScoreChart) {
                healthScoreChart.data.datasets[0].data = [score, 100 - score];
                healthScoreChart.update();
            }
        }

        // 更新健康风险预警
        function updateRiskAlert() {
            const latestData = appData.healthData[0];
            if (!latestData) return;

            let riskMessage = "一切正常，请继续保持。";
            const bp = latestData.bloodPressure.split('/');
            if (bp[0] > 140 || bp[1] > 90) {
                riskMessage = "您的血压偏高，请注意减少盐分摄入并咨询医生。";
            } else if (latestData.heartRate > 100) {
                riskMessage = "您的心率过快，请注意休息并避免剧烈运动。";
            }

            const riskAlertEl = document.getElementById('risk-alert-message');
            if (riskAlertEl) {
                riskAlertEl.textContent = riskMessage;
            }
        }

        // 更新健康指标分析
        function updateHealthMetrics() {
            const latestData = appData.healthData[0];
            if (!latestData) return;

            const radarChart = Chart.getChart('health-metrics-radar-chart');
            if (radarChart) {
                // 示例数据转换
                const data = [
                    latestData.heartRate ? (100 - Math.abs(latestData.heartRate - 75)) : 0,
                    latestData.bloodPressure ? (100 - (Math.abs(latestData.bloodPressure.split('/')[0] - 120) / 2)) : 0,
                    latestData.bloodSugar ? (100 - Math.abs(latestData.bloodSugar - 5) * 10) : 0,
                    latestData.sleepDuration ? (latestData.sleepDuration / 8 * 100) : 0,
                    65 // 运动数据暂时为静态
                ];

                radarChart.data.datasets[0].data = data.map(d => Math.max(0, Math.min(100, d)));
                radarChart.update();
            }
        }

        // 统一的仪表盘更新函数
        function updateDashboard() {
            updateHealthOverview();
            updateChart('week');
            generateHealthReport();
            updateHealthScore();
            updateRiskAlert();
            updateHealthMetrics();
        }

        let countdownTimer;
        function showRedirectConfirmation() {
            // First, remove any existing confirmation toast
            const existingToast = document.getElementById('redirect-toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.id = 'redirect-toast';
            toast.className = 'bg-blue-500 text-white p-4 rounded-lg shadow-lg flex items-center justify-between w-full max-w-md';

            let countdown = 70;
            toast.innerHTML = `
                <div class="flex-grow">
                    <p class="font-semibold">需要跳转到食谱建议页面吗？</p>
                    <p class="text-sm">将根据您的新数据生成建议。</p>
                </div>
                <div class="flex items-center flex-shrink-0 ml-4">
                    <button id="confirm-redirect-btn" class="bg-white text-blue-500 font-bold py-1 px-3 rounded-md mr-2 hover:bg-blue-100">确认 (${countdown})</button>
                    <button id="cancel-redirect-btn" class="text-white text-2xl font-bold hover:text-gray-200">&times;</button>
                </div>
            `;
            toastContainer.appendChild(toast);

            const confirmBtn = document.getElementById('confirm-redirect-btn');
            const cancelBtn = document.getElementById('cancel-redirect-btn');

            const redirectToRecipe = () => {
                clearInterval(countdownTimer);
                window.location.href = 'recipe_suggestions.html';
            };

            countdownTimer = setInterval(() => {
                countdown--;
                if (countdown <= 0) {
                    redirectToRecipe();
                } else {
                    confirmBtn.textContent = `确认 (${countdown})`;
                }
            }, 1000);

            confirmBtn.onclick = redirectToRecipe;

            cancelBtn.onclick = () => {
                clearInterval(countdownTimer);
                toast.remove();
            };
        }


        function updateHealthStatus(healthData) {
            // 更新心率状态
            const heartRateStatusEl = document.getElementById('dashboard-heart-rate-status');
            const heartRate = parseInt(healthData.heartRate);
            if (heartRate >= 60 && heartRate <= 100) {
                heartRateStatusEl.className = 'metric-trend trend-stable';
                heartRateStatusEl.innerHTML = '<i class="fa fa-minus mr-1"></i> 次/分钟 (正常)';
            } else if (heartRate < 60) {
                heartRateStatusEl.className = 'metric-trend trend-down';
                heartRateStatusEl.innerHTML = '<i class="fa fa-arrow-down mr-1"></i> 次/分钟 (略低)';
            } else {
                heartRateStatusEl.className = 'metric-trend trend-up';
                heartRateStatusEl.innerHTML = '<i class="fa fa-arrow-up mr-1"></i> 次/分钟 (略高)';
            }

            // 更新血压状态
            const bloodPressureStatusEl = document.getElementById('dashboard-blood-pressure-status');
            const [systolic, diastolic] = healthData.bloodPressure.split('/').map(Number);
            if (systolic < 90 || diastolic < 60) {
                bloodPressureStatusEl.className = 'metric-trend trend-down';
                bloodPressureStatusEl.innerHTML = '<i class="fa fa-arrow-down mr-1"></i> mmHg (偏低)';
            } else if (systolic > 140 || diastolic > 90) {
                bloodPressureStatusEl.className = 'metric-trend trend-up';
                bloodPressureStatusEl.innerHTML = '<i class="fa fa-arrow-up mr-1"></i> mmHg (偏高)';
            } else {
                bloodPressureStatusEl.className = 'metric-trend trend-stable';
                bloodPressureStatusEl.innerHTML = '<i class="fa fa-minus mr-1"></i> mmHg (正常)';
            }

            // 更新血糖状态
            const bloodSugarStatusEl = document.getElementById('dashboard-blood-sugar-status');
            const bloodSugar = parseFloat(healthData.bloodSugar);
            if (bloodSugar < 3.9) {
                bloodSugarStatusEl.className = 'metric-trend trend-down';
                bloodSugarStatusEl.innerHTML = '<i class="fa fa-arrow-down mr-1"></i> mmol/L (偏低)';
            } else if (bloodSugar > 6.1) {
                bloodSugarStatusEl.className = 'metric-trend trend-up';
                bloodSugarStatusEl.innerHTML = '<i class="fa fa-arrow-up mr-1"></i> mmol/L (偏高)';
            } else {
                bloodSugarStatusEl.className = 'metric-trend trend-stable';
                bloodSugarStatusEl.innerHTML = '<i class="fa fa-minus mr-1"></i> mmol/L (正常)';
            }
        }
        
        

        async function callDeepSeek(prompt) {
            // 检查网络连接
            if (!navigator.onLine) {
                throw new Error('网络连接已断开，请检查网络设置');
            }

            // 检查API密钥
            if (!deepSeekApiKey || deepSeekApiKey.trim() === '') {
                throw new Error('API密钥未配置，请在设置中配置DeepSeek API密钥');
            }

            try {
            const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${deepSeekApiKey}`
                },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [
                        { "role": "system", "content": "You are a helpful assistant." },
                        { "role": "user", "content": prompt }
                    ],
                    stream: false
                    }),
                    // 添加超时设置
                    signal: AbortSignal.timeout(30000) // 30秒超时
            });

            if (!response.ok) {
                    let errorMessage = `API请求失败 (状态码: ${response.status})`;
                    try {
                const errorData = await response.json();
                        if (errorData.error && errorData.error.message) {
                            errorMessage = errorData.error.message;
                        }
                    } catch (e) {
                        // 如果无法解析错误响应，使用默认消息
                    }
                    throw new Error(errorMessage);
            }

            const data = await response.json();
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('API响应格式异常');
                }
                
            return data.choices[0].message.content;
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('请求超时，请检查网络连接或稍后重试');
                } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    throw new Error('网络连接失败，请检查网络设置或API服务状态');
                }
                throw error;
            }
        }

        // 生成健康报告
        async function generateHealthReport() {
            const reportContainer = document.getElementById('health-report');
            if (!reportContainer) {
                throw new Error("健康报告容器不存在");
            }

            reportContainer.innerHTML = '<p class="text-center"><i class="fa fa-circle-o-notch fa-spin text-primary mr-2"></i> 正在生成健康报告...</p>';

            try {
                // 确保 healthData 是一个数组
                if (!Array.isArray(appData.healthData)) {
                    appData.healthData = [appData.healthData].filter(Boolean);
                }
                
                if (appData.healthData.length === 0) {
                    reportContainer.innerHTML = '<p class="text-center">暂无健康数据，无法生成报告。</p>';
                    return;
                }

                const periodSel = document.getElementById('report-period-select');
                const days = parseInt(periodSel ? periodSel.value : '7', 10) || 7;
                const sorted = [...appData.healthData].sort((a, b) => new Date(a.lastUpdated || a.date || 0) - new Date(b.lastUpdated || b.date || 0));
                const recent = sorted.slice(-days);

                const labelMap = {
                    heartRate: '心率(bpm)',
                    bloodPressure: '血压(mmHg)',
                    bloodSugar: '血糖(mmol/L)',
                    sleepDuration: '睡眠(小时)',
                    hrv: 'HRV(ms)',
                    weight: '体重(kg)',
                    fat: '体脂率(%)',
                    muscle: '肌肉量(kg)',
                    water: '水分(%)',
                    bone: '骨量(kg)',
                    protein: '蛋白质(%)',
                    bmr: '基础代谢(kcal)',
                    steps: '步数',
                    spo2: '血氧(%)',
                    cholesterol: '胆固醇(mmol/L)'
                };

                const serialize = (d) => {
                    const dateStr = new Date(d.lastUpdated || d.date || Date.now()).toLocaleDateString('zh-CN');
                    const parts = Object.keys(labelMap)
                        .filter(k => d[k] !== undefined && d[k] !== null && d[k] !== '')
                        .map(k => `${labelMap[k]}: ${d[k]}`);
                    return `日期: ${dateStr}，${parts.join('，')}`;
                };

                const healthData = recent.map(serialize).join('\n');
                const prompt = `根据以下最近${days}天的健康数据，生成一份结构化健康分析报告（用中文）：\n- 汇总本期关键指标的趋势与变化幅度\n- 识别异常值并提示潜在风险\n- 给出饮食/运动/作息/用药方面的可执行建议（分点列出）\n\n数据：\n${healthData}`;

                const report = await callDeepSeek(prompt);

                reportContainer.innerHTML = report.split('\n').map(p => `<p><i class="fa fa-comment text-primary mr-2"></i>${p}</p>`).join('');
                showToast('健康报告已生成');
            } catch (error) {
                console.error('生成健康报告失败:', error);
                
                let errorMessage = '生成报告失败，请稍后重试。';
                let errorIcon = 'fa-exclamation-triangle';
                
                if (error.message.includes('网络连接已断开')) {
                    errorMessage = '网络连接已断开，请检查网络设置后重试。';
                    errorIcon = 'fa-wifi';
                } else if (error.message.includes('API密钥未配置')) {
                    errorMessage = 'API密钥未配置，请在设置中配置DeepSeek API密钥。';
                    errorIcon = 'fa-key';
                } else if (error.message.includes('请求超时')) {
                    errorMessage = '请求超时，请检查网络连接或稍后重试。';
                    errorIcon = 'fa-clock-o';
                } else if (error.message.includes('网络连接失败')) {
                    errorMessage = '网络连接失败，请检查网络设置或API服务状态。';
                    errorIcon = 'fa-wifi';
                } else if (error.message.includes('API请求失败')) {
                    errorMessage = `API请求失败: ${error.message}`;
                    errorIcon = 'fa-exclamation-circle';
                } else if (error.message.includes('API响应格式异常')) {
                    errorMessage = 'API响应格式异常，请稍后重试。';
                    errorIcon = 'fa-exclamation-circle';
                }
                
                reportContainer.innerHTML = `
                    <div class="text-center p-4">
                        <i class="fa ${errorIcon} text-danger text-2xl mb-3 block"></i>
                        <p class="text-danger mb-3">${errorMessage}</p>
                        <button onclick="generateHealthReport()" class="btn btn-primary btn-sm">
                            <i class="fa fa-refresh mr-2"></i>重新生成
                        </button>
                    </div>
                `;
                showError(`生成报告失败: ${error.message}`);
            }
        }
        
        // 图表更新
        function updateChart(period) {
            if (!healthTrendsChart) {
                console.error("healthTrendsChart aunchart尚未初始化");
                return;
            }

            // 更新按钮样式
            const buttonsContainer = document.getElementById('chart-period-buttons');
            if (buttonsContainer) {
                const buttons = buttonsContainer.querySelectorAll('button');
                buttons.forEach(button => {
                    if (button.textContent.toLowerCase().includes(period.charAt(0))) {
                        button.classList.add('bg-primary', 'text-white');
                        button.classList.remove('bg-neutral-200', 'text-neutral-700');
                    } else {
                        button.classList.remove('bg-primary', 'text-white');
                        button.classList.add('bg-neutral-200', 'text-neutral-700');
                    }
                });
            }


            // 生成模拟数据
            let labels = [];
            let heartRateData = [];
            let bloodPressureData = [];
            const numDataPoints = period === 'week' ? 7 : (period === 'month' ? 30 : 12);
            const labelFormat = period === 'week' ? { weekday: 'short' } : (period === 'month' ? { month: 'numeric', day: 'numeric' } : { month: 'long' });

            for (let i = 0; i < numDataPoints; i++) {
                const date = new Date();
                if (period === 'week') {
                    date.setDate(date.getDate() - (numDataPoints - 1 - i));
                    labels.push(date.toLocaleDateString('zh-CN', labelFormat));
                } else if (period === 'month') {
                    date.setDate(date.getDate() - (numDataPoints - 1 - i));
                    labels.push(date.toLocaleDateString('zh-CN', labelFormat));
                } else { // year
                    date.setMonth(date.getMonth() - (numDataPoints - 1 - i));
                    labels.push(date.toLocaleDateString('zh-CN', { month: 'long' }));
                }

                // 模拟数据
                heartRateData.push(Math.floor(Math.random() * (85 - 65 + 1)) + 65); // 65-85
                bloodPressureData.push(Math.floor(Math.random() * (130 - 110 + 1)) + 110); // 110-130
            }

            // 更新图表
            healthTrendsChart.data.labels = labels;
            healthTrendsChart.data.datasets[0].data = heartRateData;
            healthTrendsChart.data.datasets[1].data = bloodPressureData;
            healthTrendsChart.update();

            showToast(`已切换至${period === 'week' ? '周' : period === 'month' ? '月' : '年'}视图`);
        }
        
        // 生成健康分析
        function generateHealthAnalysis() {
            showToast('正在生成健康分析...');
            // 实际项目中这里会生成健康分析
        }
        
        // 模型验证
        function validateModels() {
            const statusContainer = document.getElementById('model-status-container');
            const statusList = document.getElementById('model-status-list');
            
            if (!statusContainer || !statusList) {
                throw new Error("模型状态容器不存在");
            }
            
            statusContainer.classList.remove('hidden');
            statusList.innerHTML = '<p class="text-center"><i class="fa fa-circle-o-notch fa-spin text-primary mr-2"></i> 正在验证模型...</p>';
            
            // 模拟验证过程
            setTimeout(() => {
                statusList.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span>标准分析模型</span>
                        <span class="inline-block text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">可用</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span>深度分析模型</span>
                        <span class="inline-block text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">可用</span>
                    </div>
                `;
                showToast('模型验证完成');
            }, 2000);
        }
        
        // 保存API设置
        function saveApiSettings() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            const deepSeekApiKeyInput = document.getElementById('deepseek-api-key-input').value.trim();

            if (apiKey) {
                API_KEY = apiKey;
                localStorage.setItem('api_key', apiKey);
            }

            if (deepSeekApiKeyInput) {
                deepSeekApiKey = deepSeekApiKeyInput;
                localStorage.setItem('deepseek_api_key', deepSeekApiKeyInput);
            }

            showToast('API设置已保存');
        }
        
        // 用药记录相关功能
        function addMedicineRecord() {
            const name = document.getElementById('medicine-name').value.trim();
            const dose = document.getElementById('medicine-dose').value.trim();
            const time = document.getElementById('medicine-time').value;
            const reason = document.getElementById('medicine-reason').value.trim();
            
            // 验证输入
            if (!name || !dose || !time) {
                showToast('请填写药品名称、剂量和服用时间');
                return;
            }
            
            // 创建新记录
            const newRecord = {
                id: Date.now(),
                name,
                dose,
                time,
                reason,
                createdAt: new Date().toISOString()
            };
            
            // 添加到数据中
            appData.medicines.unshift(newRecord);
            saveAppData();
            
            // 更新UI
            loadMedicineRecords();
            
            // 清空表单
            document.getElementById('medicine-name').value = '';
            document.getElementById('medicine-dose').value = '';
            document.getElementById('medicine-time').value = '';
            document.getElementById('medicine-reason').value = '';
            
            showToast('用药记录已添加');
        }
        
        function loadMedicineRecords() {
            const recordsList = document.getElementById('medicine-records-list');
            const emptyState = document.getElementById('medicine-records-empty');
            
            if (!recordsList || !emptyState) {
                throw new Error("用药记录容器不存在");
            }
            
            // 清空列表（保留emptyState）
            Array.from(recordsList.children).forEach(child => {
                if (child.id !== 'medicine-records-empty') {
                    child.remove();
                }
            });
            
            // 检查是否有记录
            if (appData.medicines.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            
            // 隐藏空状态
            emptyState.classList.add('hidden');
            
            // 添加记录
            appData.medicines.forEach(record => {
                const recordElement = document.createElement('div');
                recordElement.className = 'border-b border-neutral-100 pb-3 last:border-0 last:pb-0';
                recordElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold">${record.name}</h4>
                            <p class="text-sm text-neutral-600">${record.dose} · ${formatDateTime(record.time)}</p>
                            ${record.reason ? `<p class="text-sm mt-1">${record.reason}</p>` : ''}
                        </div>
                        <button onclick="handleAction('deleteMedicineRecord', ${record.id})" class="text-neutral-400 hover:text-danger transition-colors">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `;
                recordsList.appendChild(recordElement);
            });
        }
        
        function deleteMedicineRecord(id) {
            appData.medicines = appData.medicines.filter(record => record.id !== id);
            saveAppData();
            loadMedicineRecords();
            showToast('记录已删除');
        }
        
        function clearMedicineRecords() {
            if (confirm('确定要清空所有用药记录吗？此操作不可恢复。')) {
                appData.medicines = [];
                saveAppData();
                loadMedicineRecords();
                showToast('所有用药记录已清空');
            }
        }
        
        // 体检预约相关功能
        function addExamAppointment() {
            const type = document.getElementById('exam-type').value;
            const hospital = document.getElementById('exam-hospital').value.trim();
            const date = document.getElementById('exam-date').value;
            const time = document.getElementById('exam-time').value;
            const notes = document.getElementById('exam-notes').value.trim();
            
            // 验证输入
            if (!hospital || !date || !time) {
                showToast('请填写体检机构、日期和时间');
                return;
            }
            
            // 创建新预约
            const newExam = {
                id: Date.now(),
                type,
                hospital,
                date,
                time,
                notes,
                createdAt: new Date().toISOString()
            };
            
            // 添加到数据中
            appData.exams.upcoming.unshift(newExam);
            saveAppData();
            
            // 更新UI
            loadExamAppointments();
            
            // 清空表单
            document.getElementById('exam-hospital').value = '';
            document.getElementById('exam-date').value = '';
            document.getElementById('exam-time').value = '';
            document.getElementById('exam-notes').value = '';
            
            showToast('体检预约已添加');
        }
        
        function loadExamAppointments() {
            const upcomingContainer = document.getElementById('upcoming-exams');
            const upcomingEmpty = document.getElementById('upcoming-exams-empty');
            const completedContainer = document.getElementById('completed-exams');
            const completedEmpty = document.getElementById('completed-exams-empty');
            
            if (!upcomingContainer || !upcomingEmpty || !completedContainer || !completedEmpty) {
                throw new Error("体检预约容器不存在");
            }
            
            // 清空列表（保留emptyState）
            Array.from(upcomingContainer.children).forEach(child => {
                if (child.id !== 'upcoming-exams-empty') {
                    child.remove();
                }
            });
            
            Array.from(completedContainer.children).forEach(child => {
                if (child.id !== 'completed-exams-empty') {
                    child.remove();
                }
            });
            
            // 检查即将进行的体检
            if (appData.exams.upcoming.length === 0) {
                upcomingEmpty.classList.remove('hidden');
            } else {
                upcomingEmpty.classList.add('hidden');
                appData.exams.upcoming.forEach(exam => {
                    const examElement = document.createElement('div');
                    examElement.className = 'border-b border-neutral-100 pb-3 last:border-0 last:pb-0';
                    examElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold">${exam.type} - ${exam.hospital}</h4>
                                <p class="text-sm text-neutral-600">${formatDate(exam.date)} ${exam.time}</p>
                                ${exam.notes ? `<p class="text-sm mt-1">${exam.notes}</p>` : ''}
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="handleAction('completeExam', ${exam.id})" class="text-success hover:text-success/80 transition-colors">
                                    <i class="fa fa-check"></i>
                                </button>
                                <button onclick="handleAction('deleteExam', 'upcoming', ${exam.id})" class="text-neutral-400 hover:text-danger transition-colors">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    upcomingContainer.appendChild(examElement);
                });
            }
            
            // 检查已完成的体检
            if (appData.exams.completed.length === 0) {
                completedEmpty.classList.remove('hidden');
            } else {
                completedEmpty.classList.add('hidden');
                appData.exams.completed.forEach(exam => {
                    const examElement = document.createElement('div');
                    examElement.className = 'border-b border-neutral-100 pb-3 last:border-0 last:pb-0';
                    examElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold line-through text-neutral-600">${exam.type} - ${exam.hospital}</h4>
                                <p class="text-sm text-neutral-500">${formatDate(exam.date)} ${exam.time}</p>
                                <p class="text-xs text-success mt-1"><i class="fa fa-check-circle mr-1"></i> 已完成</p>
                            </div>
                            <button onclick="handleAction('deleteExam', 'completed', ${exam.id})" class="text-neutral-400 hover:text-danger transition-colors">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    `;
                    completedContainer.appendChild(examElement);
                });
            }
        }
        
        function completeExam(id) {
            // 从即将进行的列表中找到并移除
            const examIndex = appData.exams.upcoming.findIndex(exam => exam.id === id);
            if (examIndex !== -1) {
                const completedExam = appData.exams.upcoming.splice(examIndex, 1)[0];
                // 添加到已完成列表
                appData.exams.completed.unshift(completedExam);
                saveAppData();
                loadExamAppointments();
                showToast('已标记为完成');
            }
        }
        
        function deleteExam(listType, id) {
            if (listType === 'upcoming') {
                appData.exams.upcoming = appData.exams.upcoming.filter(exam => exam.id !== id);
            } else if (listType === 'completed') {
                appData.exams.completed = appData.exams.completed.filter(exam => exam.id !== id);
            }
            saveAppData();
            loadExamAppointments();
            showToast('记录已删除');
        }
        
        function clearExamRecords() {
            if (confirm('确定要清空所有历史体检记录吗？此操作不可恢复。')) {
                appData.exams.completed = [];
                saveAppData();
                loadExamAppointments();
                showToast('所有历史体检记录已清空');
            }
        }
        
        // 饮食建议相关功能
        function saveDietRecord() {
            const breakfast = document.getElementById('diet-breakfast').value.trim();
            const lunch = document.getElementById('diet-lunch').value.trim();
            const dinner = document.getElementById('diet-dinner').value.trim();
            const snacks = document.getElementById('diet-snacks').value.trim();
            
            // 简单验证
            if (!breakfast && !lunch && !dinner && !snacks) {
                showToast('请至少记录一项饮食内容');
                return;
            }
            
            // 获取当前日期作为键
            const today = new Date().toISOString().split('T')[0];
            
            // 保存数据逻辑
            appData.dietRecords[today] = {
                breakfast,
                lunch,
                dinner,
                snacks,
                lastUpdated: new Date().toLocaleString()
            };
            
            // 更新UI
            showToast('今日饮食已保存');
            generateDietAdvice();
        }
        
        function loadDietRecord() {
            // 设置当前日期显示
            const today = new Date().toLocaleDateString();
            document.getElementById('diet-date').textContent = today;
            
            // 获取当前日期作为键
            const dateKey = new Date().toISOString().split('T')[0];
            
            // 如果有当天记录，加载
            if (appData.dietRecords[dateKey]) {
                const record = appData.dietRecords[dateKey];
                document.getElementById('diet-breakfast').value = record.breakfast || '';
                document.getElementById('diet-lunch').value = record.lunch || '';
                document.getElementById('diet-dinner').value = record.dinner || '';
                document.getElementById('diet-snacks').value = record.snacks || '';
            }
        }
        
        function generateDietAdvice() {
            const adviceContainer = document.getElementById('diet-advice');
            const emptyState = document.getElementById('diet-advice-empty');
            
            if (!adviceContainer || !emptyState) {
                throw new Error("饮食建议容器不存在");
            }
            
            adviceContainer.innerHTML = '<p class="text-center"><i class="fa fa-circle-o-notch fa-spin text-primary mr-2"></i> 正在生成饮食建议...</p>';
            
            // 模拟生成建议
            setTimeout(() => {
                emptyState.classList.add('hidden');
                adviceContainer.innerHTML = `
                    <div class="bg-success/10 p-3 rounded-lg mb-3">
                        <p class="font-medium text-success"><i class="fa fa-check-circle mr-2"></i> 饮食优点</p>
                        <ul class="list-disc list-inside text-sm mt-1 space-y-1">
                            <li>蔬菜摄入充足，富含维生素和矿物质</li>
                            <li>蛋白质来源多样，有助于肌肉维护</li>
                        </ul>
                    </div>
                    <div class="bg-warning/10 p-3 rounded-lg mb-3">
                        <p class="font-medium text-warning"><i class="fa fa-exclamation-circle mr-2"></i> 改进建议</p>
                        <ul class="list-disc list-inside text-sm mt-1 space-y-1">
                            <li>减少盐分摄入，有助于控制血压</li>
                            <li>增加全谷物比例，提高膳食纤维摄入</li>
                            <li>晚餐宜清淡，避免过量油脂</li>
                        </ul>
                    </div>
                    <div class="bg-primary/10 p-3 rounded-lg">
                        <p class="font-medium text-primary"><i class="fa fa-lightbulb-o mr-2"></i> 明日推荐</p>
                        <p class="text-sm mt-1">早餐建议：燕麦粥配坚果，提供持久能量<br>
                        午餐建议：杂粮饭配清蒸鱼和绿叶蔬菜<br>
                        晚餐建议：蔬菜豆腐汤配全麦面包</p>
                    </div>
                `;
                showToast('饮食建议已生成');
            }, 1500);
        }
        
        function initNutritionChart() {
            const ctx = document.getElementById('nutrition-chart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['蛋白质', '碳水化合物', '脂肪', '纤维素'],
                    datasets: [{
                        data: [25, 50, 20, 5],
                        backgroundColor: [
                            '#0F52BA',
                            '#F59E0B',
                            '#EF4444',
                            '#10B981'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: { 
                        legend: { 
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 15
                            }
                        } 
                    },
                    cutout: '65%'
                }
            });
        }
        
        // 运动记录相关功能
        function addExerciseRecord() {
            const type = document.getElementById('exercise-type').value;
            const duration = document.getElementById('exercise-duration').value.trim();
            const date = document.getElementById('exercise-date').value;
            const intensity = document.getElementById('exercise-intensity').value;
            const notes = document.getElementById('exercise-notes').value.trim();
            
            // 验证输入
            if (!duration || !date) {
                showToast('请填写运动时长和日期');
                return;
            }
            
            // 创建新记录
            const newExercise = {
                id: Date.now(),
                type,
                duration,
                date,
                intensity,
                notes,
                createdAt: new Date().toISOString()
            };
            
            // 添加到数据中
            appData.exercises.unshift(newExercise);
            saveAppData();
            
            // 更新UI
            loadExerciseRecords();
            initExerciseChart();
            
            // 清空表单
            document.getElementById('exercise-duration').value = '';
            document.getElementById('exercise-date').value = '';
            document.getElementById('exercise-notes').value = '';
            
            showToast('运动记录已添加');
        }
        
        function loadExerciseRecords() {
            const recordsList = document.getElementById('exercise-records-list');
            const emptyState = document.getElementById('exercise-records-empty');
            
            if (!recordsList || !emptyState) {
                throw new Error("运动记录容器不存在");
            }
            
            // 清空列表（保留emptyState）
            Array.from(recordsList.children).forEach(child => {
                if (child.id !== 'exercise-records-empty') {
                    child.remove();
                }
            });
            
            // 检查是否有记录
            if (appData.exercises.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            
            // 隐藏空状态
            emptyState.classList.add('hidden');
            
            // 添加记录
            appData.exercises.slice(0, 5).forEach(record => { // 只显示最近5条
                const intensityClass = record.intensity === '高' ? 'text-danger' : 
                                     record.intensity === '中' ? 'text-warning' : 'text-success';
                
                const recordElement = document.createElement('div');
                recordElement.className = 'border-b border-neutral-100 pb-3 last:border-0 last:pb-0';
                recordElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold">${record.type}</h4>
                            <p class="text-sm text-neutral-600">${record.duration}分钟 · ${formatDate(record.date)} · 
                                <span class="${intensityClass}">${record.intensity}强度</span>
                            </p>
                            ${record.notes ? `<p class="text-sm mt-1">${record.notes}</p>` : ''}
                        </div>
                        <button onclick="handleAction('deleteExerciseRecord', ${record.id})" class="text-neutral-400 hover:text-danger transition-colors">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `;
                recordsList.appendChild(recordElement);
            });
        }
        
        function deleteExerciseRecord(id) {
            appData.exercises = appData.exercises.filter(record => record.id !== id);
            saveAppData();
            loadExerciseRecords();
            initExerciseChart();
            showToast('运动记录已删除');
        }
        
        function clearExerciseRecords() {
            if (confirm('确定要清空所有运动记录吗？此操作不可恢复。')) {
                appData.exercises = [];
                saveAppData();
                loadExerciseRecords();
                initExerciseChart();
                showToast('所有运动记录已清空');
            }
        }
        
        function initExerciseChart() {
            // 准备数据 - 最近7天的运动时长
            const ctx = document.getElementById('exercise-chart').getContext('2d');
            
            // 生成最近7天的日期标签
            const labels = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('zh-CN', { weekday: 'short' }));
            }
            
            // 模拟数据
            const data = [30, 0, 45, 60, 0, 25, 40];
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '运动时长(分钟)',
                        data: data,
                        backgroundColor: '#3B82F6',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: { 
                        legend: { display: false } 
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        function updateExerciseChart(period) {
            showToast(`已切换至${period === 'week' ? '周' : period === 'month' ? '月' : '年'}运动数据视图`);
            // 实际项目中这里会更新图表数据
        }
        
        // 健康目标相关功能
        function addHealthGoal() {
            const type = document.getElementById('goal-type').value;
            const description = document.getElementById('goal-description').value.trim();
            const startDate = document.getElementById('goal-start-date').value;
            const endDate = document.getElementById('goal-end-date').value;
            const priority = document.getElementById('goal-priority').value;
            
            // 验证输入
            if (!description || !startDate || !endDate) {
                showToast('请填写目标描述、开始日期和完成日期');
                return;
            }
            
            // 验证日期
            if (new Date(startDate) > new Date(endDate)) {
                showToast('开始日期不能晚于完成日期');
                return;
            }
            
            // 创建新目标
            const newGoal = {
                id: Date.now(),
                type,
                description,
                startDate,
                endDate,
                priority,
                createdAt: new Date().toISOString()
            };
            
            // 添加到数据中
            appData.goals.active.unshift(newGoal);
            saveAppData();
            
            // 更新UI
            loadHealthGoals();
            
            // 清空表单
            document.getElementById('goal-description').value = '';
            document.getElementById('goal-start-date').value = '';
            document.getElementById('goal-end-date').value = '';
            
            showToast('健康目标已添加');
        }
        
        function loadHealthGoals() {
            const activeContainer = document.getElementById('active-goals');
            const activeEmpty = document.getElementById('active-goals-empty');
            const completedContainer = document.getElementById('completed-goals-list');
            const completedEmpty = document.getElementById('completed-goals-empty');
            
            if (!activeContainer || !activeEmpty || !completedContainer || !completedEmpty) {
                throw new Error("健康目标容器不存在");
            }
            
            // 清空列表（保留emptyState）
            Array.from(activeContainer.children).forEach(child => {
                if (child.id !== 'active-goals-empty') {
                    child.remove();
                }
            });
            
            Array.from(completedContainer.children).forEach(child => {
                if (child.id !== 'completed-goals-empty') {
                    child.remove();
                }
            });
            
            // 计算进行中的目标
            if (appData.goals.active.length === 0) {
                activeEmpty.classList.remove('hidden');
            } else {
                activeEmpty.classList.add('hidden');
                appData.goals.active.forEach(goal => {
                    const priorityClass = goal.priority === '高' ? 'bg-red-100 text-red-800' : 
                                       goal.priority === '中' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800';
                    
                    // 计算剩余天数
                    const end = new Date(goal.endDate);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const daysLeft = Math.ceil((end - today) / (1000 * 60 * 60 * 24));
                    
                    const recordElement = document.createElement('div');
                    recordElement.className = 'border-b border-neutral-100 pb-3 last:border-0 last:pb-0';
                    recordElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold">${goal.description}</h4>
                                <p class="text-sm text-neutral-600">${goal.type} · ${formatDate(goal.startDate)} 至 ${formatDate(goal.endDate)}</p>
                                <p class="text-xs mt-1">
                                    <span class="inline-block ${priorityClass} px-2 py-0.5 rounded-full mr-2">
                                        ${goal.priority}优先级
                                    </span>
                                    ${daysLeft >= 0 ? `<span class="text-primary">剩余 ${daysLeft} 天</span>` : 
                                                      `<span class="text-danger">已逾期 ${Math.abs(daysLeft)} 天</span>`}
                                </p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="handleAction('completeGoal', ${goal.id})" class="text-success hover:text-success/80 transition-colors">
                                    <i class="fa fa-check"></i>
                                </button>
                                <button onclick="handleAction('deleteGoal', 'active', ${goal.id})" class="text-neutral-400 hover:text-danger transition-colors">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    activeContainer.appendChild(recordElement);
                });
            }
            
            // 计算已完成的目标
            if (appData.goals.completed.length === 0) {
                completedEmpty.classList.remove('hidden');
            } else {
                completedEmpty.classList.add('hidden');
                appData.goals.completed.slice(0, 3).forEach(goal => { // 只显示最近3条
                    const recordElement = document.createElement('div');
                    recordElement.className = 'border-b border-neutral-100 pb-3 last:border-0 last:pb-0';
                    recordElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold line-through text-neutral-600">${goal.description}</h4>
                                <p class="text-sm text-neutral-500">${goal.type}</p>
                                <p class="text-xs text-success mt-1"><i class="fa fa-check-circle mr-1"></i> 已完成</p>
                            </div>
                            <button onclick="handleAction('deleteGoal', 'completed', ${goal.id})" class="text-neutral-400 hover:text-danger transition-colors">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    `;
                    completedContainer.appendChild(recordElement);
                });
            }
            
            // 更新主页面的目标完成率
            const totalGoals = appData.goals.active.length + appData.goals.completed.length;
            const completedCount = appData.goals.completed.length;
            if (totalGoals > 0) {
                document.getElementById('completed-goals').textContent = `${completedCount}/${totalGoals}`;
                const percentage = Math.round((completedCount / totalGoals) * 100);
                document.querySelector('#page-home .progress-bar').style.width = `${percentage}%`;
                document.querySelector('#page-home .progress-ring + p').textContent = `${percentage}%`;
            }
        }
        
        function completeGoal(id) {
            // 从进行中的列表中找到并移除
            const goalIndex = appData.goals.active.findIndex(goal => goal.id === id);
            if (goalIndex !== -1) {
                const completedGoal = appData.goals.active.splice(goalIndex, 1)[0];
                // 添加完成日期
                completedGoal.completedDate = new Date().toISOString().split('T')[0];
                // 添加到已完成列表
                appData.goals.completed.unshift(completedGoal);
                saveAppData();
                loadHealthGoals();
                showToast('目标已完成，真棒！');
            }
        }
        
        function deleteGoal(listType, id) {
            if (listType === 'active') {
                appData.goals.active = appData.goals.active.filter(goal => goal.id !== id);
            } else if (listType === 'completed') {
                appData.goals.completed = appData.goals.completed.filter(goal => goal.id !== id);
            }
            saveAppData();
            loadHealthGoals();
            showToast('目标已删除');
        }
        
        function clearCompletedGoals() {
            if (confirm('确定要清空所有已完成的目标吗？此操作不可恢复。')) {
                appData.goals.completed = [];
                saveAppData();
                loadHealthGoals();
                showToast('所有已完成的目标已清空');
            }
        }
        
        // 工具函数：格式化日期时间
        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }
        
        // 应用数据和初始化
        let API_KEY = '';
        let deepSeekApiKey = 'sk-ef5d339bf70b4f4d8e0657db5ba02d22';
        
        // 网络状态检测
        function checkNetworkStatus() {
            const status = navigator.onLine ? '在线' : '离线';
            const statusColor = navigator.onLine ? 'text-success' : 'text-danger';
            const statusIcon = navigator.onLine ? 'fa-wifi' : 'fa-wifi';
            
            // 更新状态栏显示
            const statusElement = document.querySelector('.network-status');
            if (statusElement) {
                statusElement.innerHTML = `<i class="fa ${statusIcon} ${statusColor}"></i>`;
                statusElement.title = `网络状态: ${status}`;
            }
            
            return navigator.onLine;
        }
        
        // 监听网络状态变化
        window.addEventListener('online', function() {
            checkNetworkStatus();
            showToast('网络连接已恢复', 'success');
        });
        
        window.addEventListener('offline', function() {
            checkNetworkStatus();
            showToast('网络连接已断开', 'warning');
        });
        
        // API连接测试
        async function testApiConnection() {
            try {
                const response = await fetch('https://api.deepseek.com/v1/models', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${deepSeekApiKey}`
                    },
                    signal: AbortSignal.timeout(10000) // 10秒超时
                });
                
                if (response.ok) {
                    showToast('API连接正常', 'success');
                    return true;
                } else {
                    showToast(`API连接失败: ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showToast('API连接超时', 'error');
                } else {
                    showToast(`API连接错误: ${error.message}`, 'error');
                }
                return false;
            }
        }
        
        let SELECTED_MODEL = 'deepseek-chat';
        let appData = {
            personalInfo: {
                gender: '未设置',
                age: '未设置',
                height: '未设置',
                weight: '未设置',
                medicalHistory: '无',
                allergies: '无',
                exerciseHabits: '无',
                dietaryHabits: '无'
            },
            healthData: [{
                heartRate: "72",
                bloodPressure: "125/82",
                bloodSugar: "5.4",
                sleepDuration: "7.2",
                bloodOxygen: "98",
                symptoms: "无",
                lastUpdated: ""
            }],
            currentLanguage: "mandarin",
            medications: [],
            appointments: [],
            medicines: [],
            exercises: [],
            goals: {
                active: [],
                completed: []
            },
            exams: { 
                upcoming: [], 
                completed: [] 
            },
            dietRecords: {}
        };
        
        // 保存应用数据
        function saveAppData() {
            try {
                localStorage.setItem('health_app_data', JSON.stringify(appData));
                // 同步到全局，供圖表渲染器使用
                window.appData = appData;
            } catch (e) {
                console.error("保存数据失败:", e);
                showError(`保存数据失败: ${e.message}`);
            }
        }
        
        // 初始化
        function init() {
            try {
                console.log('开始初始化应用...');
                
                // 检查页面元素是否存在
                const homePage = document.getElementById('page-home');
                console.log('主页元素存在:', !!homePage);
                if (homePage) {
                    console.log('主页元素类名:', homePage.className);
                }
                
                // 显示主页
                showPage('page-home');
                
                // 强制显示主页内容
                setTimeout(() => {
                    const homePage = document.getElementById('page-home');
                    if (homePage) {
                        homePage.style.display = 'block';
                        homePage.style.visibility = 'visible';
                        homePage.style.opacity = '1';
                        homePage.classList.remove('hidden');
                        console.log('强制显示主页完成');
                        console.log('主页最终样式:', homePage.style.cssText);
                        console.log('主页最终类名:', homePage.className);
                    }
                }, 100);
                
                // 显示当前时间
                updateTime();
                setInterval(updateTime, 60000);
                
                // 加载保存的数据
                const savedData = localStorage.getItem('health_app_data');
                if (savedData) {
                    appData = JSON.parse(savedData);
                    if (!Array.isArray(appData.healthData)) {
                        appData.healthData = [appData.healthData];
                        saveAppData();
                    }
                    // 同步到全局，供圖表渲染器使用
                    window.appData = appData;
                }
                
                // 设置日期显示（容错：元素可能不存在）
                const today = new Date().toLocaleDateString();
                const overviewDateEl = document.getElementById('overview-date');
                if (overviewDateEl) {
                    overviewDateEl.textContent = today;
                }
                
                // 初始化图表
                initCharts();
                updateChart('week'); // 默认加载周视图
                
                // 加载API密钥
            const savedApiKey = localStorage.getItem('api_key');
            if (savedApiKey) {
                API_KEY = savedApiKey;
                document.getElementById('api-key-input').value = API_KEY;
            }
            const savedDeepSeekApiKey = localStorage.getItem('deepseek_api_key');
            if (savedDeepSeekApiKey) {
                deepSeekApiKey = savedDeepSeekApiKey;
                document.getElementById('deepseek-api-key-input').value = savedDeepSeekApiKey;
            }
                
                // 初始化
                renderMedications();
                renderAppointments();
                loadHealthGoals();
                
                // 事件监听
                document.getElementById('med-days').addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        e.target.classList.toggle('bg-primary');
                        e.target.classList.toggle('text-white');
                    }
                });

                updateDebugInfo("应用已初始化");
                console.log("应用初始化完成");
            } catch (error) {
                console.error("初始化失败:", error);
                showError(`初始化失败: ${error.message}`);
            }
        }
        
        // 更新时间显示
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('real-time').textContent = timeString;
        }
        
        // 初始化图表
        function initCharts() {
            // 健康评分仪表盘
            const healthScoreCtx = document.getElementById('health-score-gauge').getContext('2d');
            new Chart(healthScoreCtx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [85, 15],
                        backgroundColor: ['#0F52BA', '#E5E7EB'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '80%',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });
            
            // 健康趋势图
            const trendsCtx = document.getElementById('health-trends-chart').getContext('2d');
            healthTrendsChart = new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: [], // 初始为空
                    datasets: [{
                        label: '心率 (bpm)',
                        data: [], // 初始为空
                        borderColor: '#EF4444',
                        tension: 0.3,
                        fill: false,
                        spanGaps: true, // 连接空数据点
                    }, {
                        label: '血压 (mmHg)',
                        data: [], // 初始为空
                        borderColor: '#0F52BA',
                        tension: 0.3,
                        fill: false,
                        spanGaps: true, // 连接空数据点
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: { 
                        legend: { position: 'top' } 
                    },
                    scales: { 
                        y: { 
                            beginAtZero: false 
                        } 
                    }
                }
            });
            
            // 健康指标雷达图
            const radarCtx = document.getElementById('health-metrics-radar-chart').getContext('2d');
            new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: ['心率', '血压', '血糖', '睡眠', '运动'],
                    datasets: [{
                        label: '您的指标',
                        data: [85, 75, 90, 70, 65],
                        backgroundColor: 'rgba(15, 82, 186, 0.2)',
                        borderColor: '#0F52BA'
                    }, {
                        label: '标准值',
                        data: [90, 90, 90, 90, 90],
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderColor: '#10B981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    scales: { r: { min: 50, max: 100 } }
                }
            });
        }
        
        function navigateToPage(pageId) {
            showPage(pageId);
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function addMedication() {
            const medName = document.getElementById('med-name').value;
            const medDosage = document.getElementById('med-dosage').value;
            const medTime = document.getElementById('med-time').value;
            const medDays = [...document.getElementById('med-days').querySelectorAll('button.bg-primary')].map(b => b.dataset.day);
            if (medName && medDosage && medTime && medDays.length > 0) {
                const newMed = { id: Date.now(), name: medName, dosage: medDosage, time: medTime, days: medDays, enabled: true };
                appData.medications.push(newMed);
                saveAppData();
                renderMedications();
                closeModal('add-medication-modal');
            } else {
                alert('请填写所有用药信息');
            }
        }

        function toggleMedication(id) {
            const med = appData.medications.find(m => m.id === id);
            if (med) {
                med.enabled = !med.enabled;
                saveAppData();
                renderMedications();
            }
        }

        function deleteMedication(id) {
            appData.medications = appData.medications.filter(m => m.id !== id);
            saveAppData();
            renderMedications();
        }

        function renderMedications() {
            const container = document.getElementById('medication-list');
            if (!container) return;
            container.innerHTML = '';
            if (appData.medications.length === 0) {
                container.innerHTML = `<div class="text-center text-neutral-500 py-10">
                    <i class="fa fa-pills text-4xl mb-3"></i>
                    <p>还没有添加用药提醒</p>
                </div>`;
                return;
            }
            appData.medications.forEach(med => {
                const medElement = document.createElement('div');
                medElement.className = 'card p-4 flex justify-between items-center';
                medElement.innerHTML = `
                    <div>
                        <p class="text-lg font-semibold">${med.name} <span class="text-base font-normal text-neutral-600">(${med.dosage})</span></p>
                        <p class="text-primary font-bold text-xl">${med.time}</p>
                        <p class="text-sm text-neutral-500">每周: ${med.days.map(d => ['日', '一', '二', '三', '四', '五', '六'][d]).join(' ')}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="switch">
                            <input type="checkbox" ${med.enabled ? 'checked' : ''} onchange="handleAction('toggleMedication', ${med.id})">
                            <span class="slider round"></span>
                        </label>
                        <button onclick="handleAction('deleteMedication', ${med.id})" class="text-danger"><i class="fa fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(medElement);
            });
        }

        function addAppointment() {
            const appointTitle = document.getElementById('appoint-title').value;
            const appointDoctor = document.getElementById('appoint-doctor').value;
            const appointDate = document.getElementById('appoint-date').value;
            const appointTime = document.getElementById('appoint-time').value;
            const appointLocation = document.getElementById('appoint-location').value;
            if (appointTitle && appointDoctor && appointDate && appointTime && appointLocation) {
                const newAppoint = { id: Date.now(), title: appointTitle, doctor: appointDoctor, date: appointDate, time: appointTime, location: appointLocation, status: 'scheduled' };
                appData.appointments.push(newAppoint);
                saveAppData();
                renderAppointments();
                closeModal('add-appointment-modal');
            } else {
                alert('请填写所有预约信息');
            }
        }

        function updateAppointmentStatus(id, status) {
            const appoint = appData.appointments.find(a => a.id === id);
            if (appoint) {
                appoint.status = status;
                saveAppData();
                renderAppointments();
            }
        }

        function deleteAppointment(id) {
            appData.appointments = appData.appointments.filter(a => a.id !== id);
            saveAppData();
            renderAppointments();
        }

        function renderAppointments() {
            const upcomingContainer = document.getElementById('upcoming-appointments');
            const pastContainer = document.getElementById('past-appointments');
            if (!upcomingContainer || !pastContainer) return;

            upcomingContainer.innerHTML = '';
            pastContainer.innerHTML = '';

            const now = new Date();
            const upcoming = appData.appointments.filter(a => new Date(a.date + 'T' + a.time) >= now);
            const past = appData.appointments.filter(a => new Date(a.date + 'T' + a.time) < now);

            if (upcoming.length === 0) {
                upcomingContainer.innerHTML = `<div class="text-center text-neutral-500 py-10">
                    <i class="fa fa-calendar-check-o text-4xl mb-3"></i>
                    <p>没有即将到来的预约</p>
                </div>`;
            }
            upcoming.forEach(appoint => {
                const appointElement = document.createElement('div');
                appointElement.className = 'card p-4';
                appointElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-lg font-semibold">${appoint.title}</p>
                            <p class="text-neutral-600"><i class="fa fa-user-md mr-2"></i>${appoint.doctor}</p>
                            <p class="text-neutral-600"><i class="fa fa-map-marker mr-2"></i>${appoint.location}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-primary font-bold text-xl">${new Date(appoint.date).toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' })}</p>
                            <p class="text-lg">${appoint.time}</p>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-3">
                        <button onclick="handleAction('updateAppointmentStatus', ${appoint.id}, 'completed')" class="btn-sm btn-secondary bg-success text-white">完成</button>
                        <button onclick="handleAction('deleteAppointment', ${appoint.id})" class="btn-sm btn-secondary bg-danger text-white">删除</button>
                    </div>
                `;
                upcomingContainer.appendChild(appointElement);
            });

            if (past.length === 0) {
                pastContainer.innerHTML = `<div class="text-center text-neutral-500 py-10">
                    <i class="fa fa-calendar-times-o text-4xl mb-3"></i>
                    <p>没有过去的预约</p>
                </div>`;
            }
            past.forEach(appoint => {
                const appointElement = document.createElement('div');
                appointElement.className = 'card p-4 opacity-70';
                appointElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-lg font-semibold text-neutral-500">${appoint.title}</p>
                            <p class="text-neutral-500"><i class="fa fa-user-md mr-2"></i>${appoint.doctor}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-neutral-400 font-bold">${new Date(appoint.date).toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' })}</p>
                            <p class="text-neutral-400">已完成</p>
                        </div>
                    </div>
                `;
                pastContainer.appendChild(appointElement);
            });
        }

        // 页面加载完成后初始化
       window.addEventListener('DOMContentLoaded', () => {
            // 初始化主题切换
            initThemeToggle();
            
            // 初始化网络状态检测
            checkNetworkStatus();
            
            // 配置抽屉关闭按钮
            const configDrawerClose = document.getElementById('config-drawer-close');
            if (configDrawerClose) {
                configDrawerClose.addEventListener('click', () => {
                    const configDrawer = document.getElementById('chart-config-drawer');
                    if (configDrawer) {
                        configDrawer.classList.remove('translate-x-0');
                        configDrawer.classList.add('translate-x-full');
                    }
                });
            }
    
    // 恢復主題
    try {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') document.documentElement.classList.add('dark');
    } catch {}

    // 旧的悬浮按钮事件已移除，现在由 initFABInteractions() 函数处理

    init();
    updateChart('week'); // 在初始化后，立即更新图表以显示周视图
    
    // 初始化复杂UI功能
    if (typeof initComplexUI === 'function') {
        initComplexUI();
    }
});
    </script>
    <div id="toast-container"></div>

    <!-- 添加用药提醒模态框 -->
    <div id="add-medication-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-40 hidden scale-in">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-[90%] max-w-md">
            <h3 class="text-title mb-4">添加用药提醒</h3>
            <div class="space-y-4">
                <input type="text" id="med-name" placeholder="药品名称" class="input-field">
                <input type="text" id="med-dosage" placeholder="用药剂量，如：1片" class="input-field">
                <input type="time" id="med-time" class="input-field">
                <div>
                    <p class="text-normal mb-2">重复</p>
                    <div class="flex flex-wrap gap-2 text-sm" id="med-days">
                        <button class="px-3 py-1 border rounded-full" data-day="1">一</button>
                        <button class="px-3 py-1 border rounded-full" data-day="2">二</button>
                        <button class="px-3 py-1 border rounded-full" data-day="3">三</button>
                        <button class="px-3 py-1 border rounded-full" data-day="4">四</button>
                        <button class="px-3 py-1 border rounded-full" data-day="5">五</button>
                        <button class="px-3 py-1 border rounded-full" data-day="6">六</button>
                        <button class="px-3 py-1 border rounded-full" data-day="0">日</button>
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="handleAction('closeModal', 'add-medication-modal')" class="btn-secondary bg-neutral-200 text-neutral-700">取消</button>
                <button onclick="handleAction('addMedication')" class="btn-secondary bg-primary text-white">保存</button>
            </div>
        </div>
    </div>

    <!-- 添加预约模态框 -->
    <div id="add-appointment-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-40 hidden scale-in">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-[90%] max-w-md">
            <h3 class="text-title mb-4">添加新预约</h3>
            <div class="space-y-4">
                <input type="text" id="appoint-title" placeholder="预约标题，如：复诊" class="input-field">
                <input type="text" id="appoint-doctor" placeholder="医生姓名" class="input-field">
                <input type="date" id="appoint-date" class="input-field">
                <input type="time" id="appoint-time" class="input-field">
                <input type="text" id="appoint-location" placeholder="地点" class="input-field">
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="handleAction('closeModal', 'add-appointment-modal')" class="btn-secondary bg-neutral-200 text-neutral-700">取消</button>
                <button onclick="handleAction('addAppointment')" class="btn-secondary bg-primary text-white">保存</button>
            </div>
        </div>
    </div>
    <!-- 健康分析报告部分 -->
    <div id="health-report-section" class="px-5 mb-5 mt-5 hidden">
        <div class="bg-gradient-to-br from-gray-50 to-blue-50 rounded-2xl shadow-2xl w-full p-8">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800 flex items-center"><i class="fa fa-file-medical-alt mr-4 text-primary"></i>AI驱动的全面健康分析报告</h2>
                    <p class="text-gray-500 mt-2">根据您最近一周的健康数据生成</p>
                </div>
                <button id="close-health-report-btn" class="text-gray-500 hover:text-red-500 transition-colors transform hover:scale-110">
                    <i class="fa fa-times-circle text-3xl"></i>
                </button>
            </div>
            
            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Left Column: AI Text Report and Health Score -->
                <div class="md:col-span-1 flex flex-col gap-6">
                    <!-- Health Score -->
                    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-6 hover:shadow-xl transition-shadow duration-300 h-full">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><i class="fa fa-tachometer-alt mr-2 text-blue-500"></i>健康总分</h3>
                        <div class="flex items-center justify-center h-32">
                            <canvas id="report-health-score-chart"></canvas>
                        </div>
                    </div>
                    <!-- AI Text Report -->
                    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-6 hover:shadow-xl transition-shadow duration-300 flex-grow">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><i class="fa fa-commenting-o mr-2 text-blue-500"></i>AI文本报告</h3>
                        <div id="ai-text-report" class="prose max-w-none prose-lg"></div>

                    </div>
                </div>

                <!-- Right Column: Charts -->
                <div class="md:col-span-2">
                    <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg p-3 hover:shadow-xl transition-shadow duration-300 mb-2">
                        <div id="report-chart-tabs" class="flex overflow-x-auto space-x-2">
                            <button class="px-3 py-1 rounded-full text-xs bg-primary text-white whitespace-nowrap" data-target="all">全部</button>
                            <button class="px-3 py-1 rounded-full text-xs bg-neutral-200 text-neutral-700 whitespace-nowrap" data-target="report-heart-rate-chart">心率</button>
                            <button class="px-3 py-1 rounded-full text-xs bg-neutral-200 text-neutral-700 whitespace-nowrap" data-target="report-blood-pressure-chart">血压</button>
                            <button class="px-3 py-1 rounded-full text-xs bg-neutral-200 text-neutral-700 whitespace-nowrap" data-target="report-blood-sugar-chart">血糖</button>
                            <button class="px-3 py-1 rounded-full text-xs bg-neutral-200 text-neutral-700 whitespace-nowrap" data-target="report-sleep-quality-chart">睡眠</button>
                            <button class="px-3 py-1 rounded-full text-xs bg-neutral-200 text-neutral-700 whitespace-nowrap" data-target="report-weekly-sleep-chart">每周睡眠</button>
                            <button class="px-3 py-1 rounded-full text-xs bg-neutral-200 text-neutral-700 whitespace-nowrap" data-target="report-hrv-trend-chart">HRV</button>
                            <button class="px-3 py-1 rounded-full text-xs bg-neutral-200 text-neutral-700 whitespace-nowrap" data-target="report-health-score-chart">健康总分</button>
                            <div class="ml-auto"></div>
                            <select id="report-period-select" class="text-xs px-2 py-1 bg-neutral-100 text-neutral-700 rounded-full">
                                <option value="7">近7天</option>
                                <option value="30">近30天</option>
                                <option value="90">近90天</option>
                            </select>
                            <button id="config-drawer-toggle" class="ml-2 w-8 h-8 rounded-full bg-neutral-200 text-neutral-700 flex items-center justify-center hover:bg-neutral-300">
                                <i class="fa fa-cog text-xs"></i>
                            </button>
                        </div>
                        
                        <!-- 時間軸回放控制 -->
                        <div id="timeline-playback" class="mt-3 flex items-center space-x-3">
                            <button id="playback-play" class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center hover:bg-primary-dark">
                                <i class="fa fa-play text-xs"></i>
                            </button>
                            <div class="flex-1 bg-neutral-200 rounded-full h-2 relative">
                                <div id="playback-progress" class="bg-primary h-full rounded-full transition-all duration-100" style="width: 0%"></div>
                            </div>
                            <span id="playback-time" class="text-xs text-neutral-600 min-w-[60px]">0/7</span>
                            <select id="playback-speed" class="text-xs px-2 py-1 bg-neutral-100 text-neutral-700 rounded">
                                <option value="1">1x</option>
                                <option value="2">2x</option>
                                <option value="4">4x</option>
                            </select>
                        </div>
                    </div>
                    <div id="charts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Heart Rate Chart -->
                            <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-md p-4 hover:shadow-lg transition-shadow duration-300">
                                <h3 class="text-sm font-semibold text-gray-800 mb-2 flex items-center"><i class="fa fa-heartbeat mr-2 text-red-500"></i>心率</h3>
                                <div id="report-heart-rate-chart-controls" class="mb-2"></div>
                                <canvas id="report-heart-rate-chart" class="w-full h-32"></canvas>
                        </div>

                        <!-- Blood Pressure Chart -->
                            <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-md p-4 hover:shadow-lg transition-shadow duration-300">
                                <h3 class="text-sm font-semibold text-gray-800 mb-2 flex items-center"><i class="fa fa-tint mr-2 text-red-500"></i>血压</h3>
                                <div id="report-blood-pressure-chart-controls" class="mb-2"></div>
                                <canvas id="report-blood-pressure-chart" class="w-full h-32"></canvas>
                        </div>

                        <!-- Blood Sugar Chart -->
                            <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-md p-4 hover:shadow-lg transition-shadow duration-300">
                                <h3 class="text-sm font-semibold text-gray-800 mb-2 flex items-center"><i class="fa fa-medkit mr-2 text-yellow-500"></i>血糖</h3>
                                <div id="report-blood-sugar-chart-controls" class="mb-2"></div>
                                <canvas id="report-blood-sugar-chart" class="w-full h-32"></canvas>
                        </div>

                        <!-- Sleep Quality Chart -->
                            <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-md p-4 hover:shadow-lg transition-shadow duration-300">
                                <h3 class="text-sm font-semibold text-gray-800 mb-2 flex items-center"><i class="fa fa-bed mr-2 text-purple-500"></i>睡眠</h3>
                                <div id="report-sleep-quality-chart-controls" class="mb-2"></div>
                                <canvas id="report-sleep-quality-chart" class="w-full h-32"></canvas>
                        </div>

                            <!-- Weekly Sleep Stages -->
                            <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-md p-4 hover:shadow-lg transition-shadow duration-300">
                                <h3 class="text-sm font-semibold text-gray-800 mb-2">每周睡眠</h3>
                                <div id="report-weekly-sleep-chart-controls" class="mb-2"></div>
                                <canvas id="report-weekly-sleep-chart" class="w-full h-32"></canvas>
                        </div>

                            <!-- HRV Trend -->
                            <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-md p-4 hover:shadow-lg transition-shadow duration-300">
                                <h3 class="text-sm font-semibold text-gray-800 mb-2">HRV趋势</h3>
                                <div id="report-hrv-trend-chart-controls" class="mb-2"></div>
                                <canvas id="report-hrv-trend-chart" class="w-full h-32"></canvas>
                            </div>

                            <!-- Health Score Chart -->
                            <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-md p-4 hover:shadow-lg transition-shadow duration-300 md:col-span-2 lg:col-span-1">
                                <h3 class="text-sm font-semibold text-gray-800 mb-2">健康总分</h3>
                                <div id="report-health-score-chart-controls" class="mb-2"></div>
                                <canvas id="report-health-score-chart" class="w-full h-32"></canvas>
                        </div>
                    </div>

            </div>
        </div>
    </div>

        <!-- 浮动操作按钮组 -->
        <div id="fab-group" class="fixed bottom-6 right-6 flex flex-col items-end space-y-4 z-30">
            <!-- 主FAB按钮 -->
            <button id="fab-main" class="w-14 h-14 bg-gradient-to-r from-primary to-primary-dark text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 relative flex items-center justify-center">
                <i class="fa fa-plus transition-transform duration-300 text-lg" id="fab-main-icon"></i>
                <div class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center">
                    <span class="text-xs text-white font-bold">3</span>
            </div>
            </button>
            
            <!-- 子FAB按钮 -->
            <div id="fab-submenu" class="flex flex-col space-y-4 opacity-0 scale-0 transition-all duration-300 transform origin-bottom">
                <button id="fab-add-record" class="w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 flex items-center justify-center" title="添加记录">
                    <i class="fa fa-plus text-sm"></i>
                </button>
                <button id="fab-view-report" class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 flex items-center justify-center" title="查看报告">
                    <i class="fa fa-file-medical-alt text-sm"></i>
                </button>
                <button id="fab-ai-chat" class="w-12 h-12 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 flex items-center justify-center" title="AI助手">
                    <i class="fa fa-commenting-o text-sm"></i>
                </button>
                <button id="fab-settings" class="w-12 h-12 bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 flex items-center justify-center" title="设置">
                    <i class="fa fa-cog text-sm"></i>
                </button>
        </div>
    </div>

        <!-- 通知中心 -->
        <div id="notification-center" class="fixed top-4 right-4 z-40 space-y-3 w-80 max-w-[calc(100vw-2rem)]">
            <!-- 通知示例 -->
            <div class="notification-item bg-white rounded-xl shadow-lg p-4 border-l-4 border-green-500 transform translate-x-full transition-all duration-300">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                            <i class="fa fa-check-circle text-green-500 text-sm"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">数据同步完成</p>
                            <p class="text-xs text-gray-500">所有健康数据已更新</p>
                        </div>
                    </div>
                    <button class="text-gray-400 hover:text-gray-600 p-1">
                        <i class="fa fa-times text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 快速操作面板 -->
        <div id="quick-actions-panel" class="fixed bottom-24 left-4 z-30 bg-white rounded-xl shadow-lg p-5 transform translate-y-full transition-all duration-300 w-48">
            <h4 class="text-sm font-semibold text-gray-800 mb-4">快速操作</h4>
            <div class="grid grid-cols-2 gap-3">
                <button class="flex flex-col items-center p-4 rounded-xl bg-blue-50 hover:bg-blue-100 transition-all duration-300 hover:scale-105">
                    <i class="fa fa-heartbeat text-blue-500 mb-2 text-lg"></i>
                    <span class="text-xs text-gray-700 font-medium">心率</span>
                </button>
                <button class="flex flex-col items-center p-4 rounded-xl bg-red-50 hover:bg-red-100 transition-all duration-300 hover:scale-105">
                    <i class="fa fa-tint text-red-500 mb-2 text-lg"></i>
                    <span class="text-xs text-gray-700 font-medium">血压</span>
                </button>
                <button class="flex flex-col items-center p-4 rounded-xl bg-yellow-50 hover:bg-yellow-100 transition-all duration-300 hover:scale-105">
                    <i class="fa fa-medkit text-yellow-500 mb-2 text-lg"></i>
                    <span class="text-xs text-gray-700 font-medium">血糖</span>
                </button>
                <button class="flex flex-col items-center p-4 rounded-xl bg-purple-50 hover:bg-purple-100 transition-all duration-300 hover:scale-105">
                    <i class="fa fa-bed text-purple-500 mb-2 text-lg"></i>
                    <span class="text-xs text-gray-700 font-medium">睡眠</span>
                </button>
            </div>
        </div>
        
        <!-- 数据可视化仪表盘 -->
        <div id="data-dashboard" class="fixed top-4 left-4 z-30 bg-white rounded-xl shadow-lg p-5 transform -translate-x-full transition-all duration-300 w-56">
            <h4 class="text-sm font-semibold text-gray-800 mb-4">实时数据</h4>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600 font-medium">心率</span>
                    <div class="flex items-center">
                        <div class="w-20 h-3 bg-gray-200 rounded-full mr-3">
                            <div class="w-3/4 h-full bg-red-500 rounded-full transition-all duration-500"></div>
                        </div>
                        <span class="text-sm font-bold text-red-500">72</span>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600 font-medium">血压</span>
                    <div class="flex items-center">
                        <div class="w-20 h-3 bg-gray-200 rounded-full mr-3">
                            <div class="w-2/3 h-full bg-blue-500 rounded-full transition-all duration-500"></div>
                        </div>
                        <span class="text-sm font-bold text-blue-500">120/80</span>
                    </div>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600 font-medium">血糖</span>
                    <div class="flex items-center">
                        <div class="w-20 h-3 bg-gray-200 rounded-full mr-3">
                            <div class="w-4/5 h-full bg-yellow-500 rounded-full transition-all duration-500"></div>
                        </div>
                        <span class="text-sm font-bold text-yellow-500">5.2</span>
                    </div>
                </div>
            </div>
        </div>

        <script src="/chart_renderer.js"></script>
        <script>
        /**
         * 复杂UI交互功能
         */
        
        // 粒子背景效果
        function initParticleBackground() {
            const particlesContainer = document.getElementById('particles-bg');
            if (!particlesContainer) {
                console.warn('粒子背景容器不存在');
                return;
            }
            
            try {
                // 清空现有粒子
                particlesContainer.innerHTML = '';
                
                // 创建多种类型的粒子
                const particleTypes = [
                    { class: 'w-1 h-1 bg-white/20', animation: 'none' },
                    { class: 'w-2 h-2 bg-cyan-400/30', animation: 'none' },
                    { class: 'w-1.5 h-1.5 bg-purple-400/25', animation: 'none' },
                    { class: 'w-3 h-3 bg-pink-400/20', animation: 'none' }
                ];
                
                // 创建50个粒子
                for (let i = 0; i < 50; i++) {
                    const particle = document.createElement('div');
                    const type = particleTypes[Math.floor(Math.random() * particleTypes.length)];
                    
                    particle.className = `absolute ${type.class} rounded-full`;
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 8 + 's';
                    particle.style.animation = type.animation;
                    particle.style.zIndex = Math.floor(Math.random() * 3);
                    
                    particlesContainer.appendChild(particle);
                }
                
                // 初始化矩阵雨效果
                initMatrixRain();
                
                console.log('复杂粒子背景系统初始化完成');
            } catch (error) {
                console.error('粒子背景初始化失败:', error);
            }
        }
        
        // 矩阵雨效果
        function initMatrixRain() {
            const matrixContainer = document.getElementById('matrix-rain');
            if (!matrixContainer) return;
            
            const characters = '01アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲン';
            
            for (let i = 0; i < 20; i++) {
                const column = document.createElement('div');
                column.className = 'absolute text-green-400 text-xs font-mono opacity-30';
                column.style.left = Math.random() * 100 + '%';
                column.style.animationDelay = Math.random() * 15 + 's';
                column.style.animation = 'none';
                
                let text = '';
                for (let j = 0; j < 20; j++) {
                    text += characters[Math.floor(Math.random() * characters.length)] + '<br>';
                }
                column.innerHTML = text;
                
                matrixContainer.appendChild(column);
            }
        }
        
        // 实时时钟
        function updateClock() {
            const now = new Date();
            const timeElement = document.getElementById('current-time');
            const dateElement = document.getElementById('current-date');
            
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString('zh-CN', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
            
            if (dateElement) {
                dateElement.textContent = now.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
            }
        }
        
        // FAB按钮交互
        function initFABInteractions() {
            const fabMain = document.getElementById('fab-main');
            const fabSubmenu = document.getElementById('fab-submenu');
            const fabIcon = document.getElementById('fab-main-icon');
            
            if (!fabMain || !fabSubmenu) return;
            
            let isOpen = false;
            
            fabMain.addEventListener('click', () => {
                isOpen = !isOpen;
                
                if (isOpen) {
                    fabSubmenu.classList.remove('opacity-0', 'scale-0');
                    fabSubmenu.classList.add('opacity-100', 'scale-100');
                } else {
                    fabSubmenu.classList.add('opacity-0', 'scale-0');
                    fabSubmenu.classList.remove('opacity-100', 'scale-100');
                }
            });
            
            // 子按钮点击事件
            document.getElementById('fab-add-record')?.addEventListener('click', () => {
                handleAction('addHealthRecord');
                closeFAB();
            });
            
            document.getElementById('fab-view-report')?.addEventListener('click', () => {
                handleAction('viewHealthReport');
                closeFAB();
            });
            
            document.getElementById('fab-ai-chat')?.addEventListener('click', () => {
                handleAction('openAIChat');
                closeFAB();
            });
            
            document.getElementById('fab-settings')?.addEventListener('click', () => {
                handleAction('showSettingsPanel');
                closeFAB();
            });
            
            function closeFAB() {
                isOpen = false;
                fabSubmenu.classList.add('opacity-0', 'scale-0');
                fabSubmenu.classList.remove('opacity-100', 'scale-100');
            }
        }
        
        // 通知系统
        function showNotification(message, type = 'info', duration = 3000) {
            const notificationCenter = document.getElementById('notification-center');
            if (!notificationCenter) return;
            
            const notification = document.createElement('div');
            const colors = {
                success: 'border-green-500',
                error: 'border-red-500',
                warning: 'border-yellow-500',
                info: 'border-blue-500'
            };
            
            const icons = {
                success: 'fa-check-circle text-green-500',
                error: 'fa-exclamation-circle text-red-500',
                warning: 'fa-exclamation-triangle text-yellow-500',
                info: 'fa-info-circle text-blue-500'
            };
            
            notification.className = `notification-item bg-white rounded-xl shadow-lg p-4 border-l-4 ${colors[type]} transform translate-x-full transition-all duration-300`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-${type === 'success' ? 'green' : type === 'error' ? 'red' : type === 'warning' ? 'yellow' : 'blue'}-100 rounded-full flex items-center justify-center mr-3">
                            <i class="fa ${icons[type]} text-sm"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-gray-900">${message}</p>
                            <p class="text-xs text-gray-500">${new Date().toLocaleTimeString()}</p>
                        </div>
                    </div>
                    <button class="text-gray-400 hover:text-gray-600 p-1" onclick="this.parentElement.parentElement.remove()">
                        <i class="fa fa-times text-sm"></i>
                    </button>
                </div>
            `;
            
            notificationCenter.appendChild(notification);
            
            // 显示动画
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // 自动隐藏
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }
        
        // 快速操作面板
        function initQuickActions() {
            const quickPanel = document.getElementById('quick-actions-panel');
            if (!quickPanel) return;
            
            let isVisible = false;
            
            // 双击左下角显示/隐藏
            document.addEventListener('dblclick', (e) => {
                if (e.clientX < 100 && e.clientY > window.innerHeight - 100) {
                    isVisible = !isVisible;
                    if (isVisible) {
                        quickPanel.classList.remove('translate-y-full');
                    } else {
                        quickPanel.classList.add('translate-y-full');
                    }
                }
            });
            
            // 快速操作按钮事件
            quickPanel.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const icon = btn.querySelector('i').className;
                    if (icon.includes('heartbeat')) {
                        showQuickInput('heartRate');
                    } else if (icon.includes('tint')) {
                        showQuickInput('bloodPressure');
                    } else if (icon.includes('medkit')) {
                        showQuickInput('bloodSugar');
                    } else if (icon.includes('bed')) {
                        showQuickInput('sleep');
                    }
                });
            });
        }
        
        // 数据仪表盘
        function initDataDashboard() {
            const dashboard = document.getElementById('data-dashboard');
            if (!dashboard) return;
            
            let isVisible = false;
            
            // 双击左上角显示/隐藏
            document.addEventListener('dblclick', (e) => {
                if (e.clientX < 100 && e.clientY < 100) {
                    isVisible = !isVisible;
                    if (isVisible) {
                        dashboard.classList.remove('-translate-x-full');
                    } else {
                        dashboard.classList.add('-translate-x-full');
                    }
                }
            });
            
            // 实时更新数据
            setInterval(() => {
                updateDashboardData();
            }, 5000);
        }
        
        function updateDashboardData() {
            const heartRate = Math.floor(Math.random() * 20) + 70;
            const systolic = Math.floor(Math.random() * 20) + 110;
            const diastolic = Math.floor(Math.random() * 15) + 70;
            const bloodSugar = (Math.random() * 2 + 4).toFixed(1);
            
            // 更新心率
            const hrElement = document.querySelector('#data-dashboard .text-red-500');
            if (hrElement) {
                hrElement.textContent = heartRate;
                const hrBar = hrElement.previousElementSibling.querySelector('div');
                if (hrBar) {
                    const percentage = Math.min((heartRate - 60) / 40 * 100, 100);
                    hrBar.style.width = percentage + '%';
                }
            }
            
            // 更新血压
            const bpElement = document.querySelector('#data-dashboard .text-blue-500');
            if (bpElement) {
                bpElement.textContent = `${systolic}/${diastolic}`;
                const bpBar = bpElement.previousElementSibling.querySelector('div');
                if (bpBar) {
                    const percentage = Math.min((systolic - 90) / 50 * 100, 100);
                    bpBar.style.width = percentage + '%';
                }
            }
            
            // 更新血糖
            const bsElement = document.querySelector('#data-dashboard .text-yellow-500');
            if (bsElement) {
                bsElement.textContent = bloodSugar;
                const bsBar = bsElement.previousElementSibling.querySelector('div');
                if (bsBar) {
                    const percentage = Math.min((parseFloat(bloodSugar) - 3.9) / 2.2 * 100, 100);
                    bsBar.style.width = percentage + '%';
                }
            }
        }
        
        // 快速输入模态框
        function showQuickInput(type) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 w-80 max-w-[90vw]">
                    <h3 class="text-lg font-semibold mb-4">快速记录 ${getTypeName(type)}</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">数值</label>
                            <input type="number" id="quick-value" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="请输入数值">
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="saveQuickInput('${type}')" class="flex-1 bg-primary text-white py-2 rounded-lg hover:bg-primary-dark transition-colors">保存</button>
                            <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 transition-colors">取消</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // 聚焦输入框
            setTimeout(() => {
                modal.querySelector('#quick-value').focus();
            }, 100);
        }
        
        function getTypeName(type) {
            const names = {
                heartRate: '心率',
                bloodPressure: '血压',
                bloodSugar: '血糖',
                sleep: '睡眠'
            };
            return names[type] || type;
        }
        
        function saveQuickInput(type) {
            const value = document.getElementById('quick-value').value;
            if (!value) {
                showNotification('请输入有效数值', 'warning');
                return;
            }
            
            // 这里可以添加保存逻辑
            showNotification(`${getTypeName(type)}记录已保存`, 'success');
            document.querySelector('.fixed.inset-0').remove();
        }
        
        // 进度条动画
        function animateProgressBars() {
            const progressBars = document.querySelectorAll('.bg-gradient-to-r');
            progressBars.forEach(bar => {
                const width = bar.style.width;
                bar.style.width = '0%';
                setTimeout(() => {
                    bar.style.width = width;
                }, 500);
            });
        }
        
        // 初始化所有复杂UI功能
        function initComplexUI() {
            try {
                console.log('开始初始化复杂UI...');
                
                // 检查元素是否存在
                const particlesBg = document.getElementById('particles-bg');
                const matrixRain = document.getElementById('matrix-rain');
                const holographicOverlay = document.getElementById('holographic-overlay');
                const dynamicBg = document.getElementById('dynamic-bg');
                
                console.log('背景元素检查:', {
                    particlesBg: !!particlesBg,
                    matrixRain: !!matrixRain,
                    holographicOverlay: !!holographicOverlay,
                    dynamicBg: !!dynamicBg
                });
                
                initParticleBackground();
                initFABInteractions();
                initQuickActions();
                initDataDashboard();
                
                // 启动时钟
                updateClock();
                setInterval(updateClock, 1000);
                
                // 延迟启动进度条动画
                setTimeout(animateProgressBars, 1000);
                
                // 显示欢迎通知
                setTimeout(() => {
                    showNotification('欢迎使用健康管理助手！', 'success', 2000);
                }, 1500);
                
                console.log('复杂UI初始化完成');
            } catch (error) {
                console.error('复杂UI初始化失败:', error);
                showNotification('UI初始化失败，但基本功能可用', 'warning', 3000);
            }
        }
        
        /**
         * 在報告區塊存在時，自動渲染一次所有報告圖表，
         * 以免使用者未點「查看報告」按鈕時看不到圖表。
         */
        window.requestAnimationFrame(() => {
            try {
                if (typeof renderAllReportCharts === 'function') {
                    const chartsContainer = document.getElementById('charts-container');
                    const reportSection = document.getElementById('health-report-section');
                    
                    // 不自动显示健康报告，但设置必要的事件监听器
                    if (chartsContainer) {
                        // 分頁切換顯示/隱藏現有圖表
                        const tabs = document.getElementById('report-chart-tabs');
                        const periodSel = document.getElementById('report-period-select');
                        if (tabs) {
                            tabs.addEventListener('click', (e) => {
                                const btn = e.target.closest('button[data-target]');
                                if (!btn) return;
                                const target = btn.dataset.target;
                                Array.from(tabs.querySelectorAll('button')).forEach(b => b.classList.remove('bg-primary','text-white'));
                                btn.classList.add('bg-primary','text-white');
                                const ids = [
                                    'report-heart-rate-chart',
                                    'report-blood-pressure-chart',
                                    'report-blood-sugar-chart',
                                    'report-sleep-quality-chart',
                                    'report-weekly-sleep-chart',
                                    'report-hrv-trend-chart',
                                    'report-health-score-chart'
                                ];
                                ids.forEach(id => {
                                    const canvas = document.getElementById(id);
                                    if (!canvas) return;
                                    const card = canvas.closest('.bg-white');
                                    const container = card || canvas.parentElement;
                                    if (!container) return;
                                    if (target === 'all' || id === target) {
                                        container.classList.remove('hidden');
                                    } else {
                                        container.classList.add('hidden');
                                    }
                                });
                            });
                        }
                        if (periodSel && typeof setReportDays === 'function') {
                            periodSel.addEventListener('change', () => {
                                setReportDays(periodSel.value);
                            });
                        }
                    }
                }
            } catch (e) {
                console.error('初始化报告图表事件监听器失败:', e);
            }
        });
        </script>
     <script src="/ai_chat.js"></script>
     <script>

     </script>
  </body>
</html>